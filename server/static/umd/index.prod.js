(()=>{"use strict";var e,t,s,i,a={2380:(e,t,s)=>{s.d(t,{_Y:()=>a,Q5:()=>i,kz:()=>b,I1:()=>w,yQ:()=>H,qm:()=>o,uU:()=>m,UF:()=>U,sL:()=>F,y2:()=>_,A1:()=>k,Ae:()=>V,mo:()=>l,W8:()=>n,uK:()=>B,ED:()=>q,SA:()=>j,me:()=>r,cH:()=>v,W0:()=>O,_c:()=>y,g7:()=>M,wx:()=>S,AP:()=>D,q:()=>P,QJ:()=>p,cj:()=>h,Yb:()=>N,aq:()=>I,Y7:()=>g,mM:()=>C,s3:()=>R,OS:()=>L,iE:()=>d,Ir:()=>u,Km:()=>E,eV:()=>W,yE:()=>x,OI:()=>c,_0:()=>f,KG:()=>T,uW:()=>A});const i="TinodeWeb/0.22.12",a="AQEAAAABAAD_rAp4DJh05a1HAwFT3A6K",n={hosted:"web.tinode.co",local:"localhost:6060"},o=n.hosted,r=!0,l=3e3,c=1500,d=2,h=96,p=16,m="JRWPS",u="N",g=640,f=13,b=384,v=4096,w=32,E=128,C=24,S=262144,y=1<<23,M=1024,_=64,T=96,k=36,A=48,D=4,N=60,I=360,P=20,R=80,x=30,F=84,U=48,L=2e3,O=6e5,B="mailto:support@tinode.co",q="https://tinode.co/privacy.html",j="https://tinode.co/terms.html",V=!1,H=["http","https","ftp","ftps"],W=128},3092:(e,t,s)=>{s.d(t,{AP:()=>f,E9:()=>d,Q3:()=>p,Qn:()=>n,SS:()=>c,Se:()=>m,YJ:()=>u,_K:()=>h,_k:()=>l,wf:()=>g,yg:()=>o});const i=["image/jpeg","image/gif","image/png","image/svg","image/svg+xml"],a=["jpg","gif","png","svg","svg"];function n(e){if(e&&"object"==typeof e){if(e.ref)return e.ref;if(e.data&&e.type){return"data:"+(e.type.startsWith("image/")?e.type:"image/"+e.type)+";base64,"+e.data}}return null}function o(e,t,s,i,a){if(t|=0,s|=0,i|=0,(e|=0)<=0||t<=0||s<=0||i<=0)return null;a&&(s=i=Math.min(s,i));const n=Math.min(Math.min(e,s)/e,Math.min(t,i)/t),o={dstWidth:e*n|0,dstHeight:t*n|0};return a?(o.dstWidth=o.dstHeight=Math.min(o.dstWidth,o.dstHeight),o.srcWidth=o.srcHeight=Math.min(e,t),o.xoffset=(e-o.srcWidth)/2|0,o.yoffset=(t-o.srcWidth)/2|0):(o.xoffset=o.yoffset=0,o.srcWidth=e,o.srcHeight=t),o}function r(e,t){const s=i.indexOf(t);if(s<0||!e)return e;const n=a[s],o=e.lastIndexOf(".");return o>=0&&(e=e.substring(0,o)),e+"."+n}function l(e,t,s,a,n){return new Promise(((l,c)=>{const d=new Image;d.crossOrigin="Anonymous",d.onerror=function(e){c(new Error("Image format unrecognized"))},d.onload=async function(){URL.revokeObjectURL(d.src);const h=o(d.width,d.height,t,s,n);if(!h)return void c(new Error("Invalid image"));let p=document.createElement("canvas");p.width=h.dstWidth,p.height=h.dstHeight;let m=p.getContext("2d");m.imageSmoothingEnabled=!0,m.drawImage(d,h.xoffset,h.yoffset,h.srcWidth,h.srcHeight,0,0,h.dstWidth,h.dstHeight);const u=i.includes(e.type)?e.type:"image/jpeg";let g=await new Promise((e=>p.toBlob(e,u)));if(g){for(;a>0&&g.length>a;)h.dstWidth=.70710678118*h.dstWidth|0,h.dstHeight=.70710678118*h.dstHeight|0,p.width=h.dstWidth,p.height=h.dstHeight,m=p.getContext("2d"),m.clearRect(0,0,p.width,p.height),m.drawImage(d,h.xoffset,h.yoffset,h.srcWidth,h.srcHeight,0,0,h.dstWidth,h.dstHeight),g=await new Promise((e=>p.toBlob(e,u)));p=null,l({mime:u,blob:g,width:h.dstWidth,height:h.dstHeight,name:r(e.name,u)})}else c(new Error("Unsupported image format"))},d.src=URL.createObjectURL(e)}))}function c(e,t,s,a,n,o,r){return new Promise(((l,c)=>{const d=new Image;d.crossOrigin="Anonymous",d.onerror=e=>{c(new Error("Image format unrecognized"))},d.onload=t=>{URL.revokeObjectURL(d.src);let h=document.createElement("canvas");h.width=n*r,h.height=o*r;let p=h.getContext("2d");p.imageSmoothingEnabled=!0,p.drawImage(d,s,a,n,o,0,0,h.width,h.height),e=i.includes(e)?e:"image/jpeg",h.toBlob((t=>{h=null,t?l({mime:e,blob:t,width:n,height:o}):c(new Error("Unsupported image format"))}),e)},d.src=t}))}function d(e){return new Promise(((t,s)=>{const i=new FileReader;i.onerror=e=>{s(i.error)},i.onload=s=>{t({mime:e.type,bits:i.result.split(",")[1],name:e.name})},i.readAsDataURL(e)}))}function h(e){return new Promise(((t,s)=>{const i=new FileReader;i.onerror=e=>{s(i.error)},i.onload=s=>{t({mime:e.type,bits:i.result.split(",")[1]})},i.readAsDataURL(e)}))}function p(e,t,s,i){const a=(e.clipboardData||e.originalEvent.clipboardData||{}).items;if(!a||!a.length)return!1;for(let e in a){const n=a[e];if("file"===n.kind){const e=n.getAsFile();if(!e){console.error("Failed to get file object from pasted file item",n.kind,n.type),i("Failed to get file object from pasted file item");continue}return e.type&&"image"==e.type.split("/")[0]?t(e):s(e),!0}}return!1}function m(e){if(e){e=e.replace(/-/g,"+").replace(/_/g,"/");try{e=btoa(atob(e))}catch(t){console.error("Failed to base64 re-encode string.",t),e=null}}return e}function u(e,t){if(!e)return null;try{const s=atob(e),i=s.length,a=new ArrayBuffer(i),n=new Uint8Array(a);for(let e=0;e<i;e++)n[e]=s.charCodeAt(e);return new Blob([a],{type:t})}catch(e){console.error("Failed to convert base64 to blob: ",e)}return null}function g(e){if(!Array.isArray(e))return null;try{let t="";return new Uint8Array(e).forEach((e=>t+=String.fromCharCode(e))),window.btoa(t)}catch(e){}return null}function f(e){const t=[];try{return[...window.atob(e)].forEach((e=>{t.push(e.charCodeAt(0))})),t}catch(e){}return null}},336:(e,t,s)=>{s.d(t,{c:()=>i});class i{static setObject(e,t){localStorage.setItem(e,JSON.stringify(t))}static getObject(e){const t=localStorage.getItem(e);return t&&JSON.parse(t)}static updateObject(e,t){const s=this.getObject(e);this.setObject(e,Object.assign(s||{},t))}static removeItem(e){localStorage.removeItem(e)}}},4652:(e,t,s)=>{s.d(t,{c:()=>i});class i{static parseUrlHash(e){const t=e.split("?",2),s={};let i=[];return t[0]&&(i=t[0].replace("#","").split("/")),t[1]&&t[1].split("&").forEach((e=>{const t=e.indexOf("=");t>0&&(s[e.slice(0,t)]=decodeURIComponent(e.slice(t+1)))})),{path:i,params:s}}static navigateTo(e){window.location.hash=e}static composeUrlHash(e,t){let s=e.join("/");const i=[];for(const e in t)t.hasOwnProperty(e)&&void 0!==t[e]&&i.push(e+"="+encodeURIComponent(t[e]));return i.length>0&&(s+="?"+i.join("&")),s}static addUrlParam(e,t,s){const a=i.parseUrlHash(e);return a.params[t]=s,i.composeUrlHash(a.path,a.params)}static removeUrlParam(e,t){const s=i.parseUrlHash(e);return delete s.params[t],i.composeUrlHash(s.path,s.params)}static setUrlSidePanel(e,t){const s=i.parseUrlHash(e);return s.path[0]=t,i.composeUrlHash(s.path,s.params)}static setUrlInfoPanel(e,t){const s=i.parseUrlHash(e);return t?s.params.info=t:delete s.params.info,i.composeUrlHash(s.path,s.params)}static setUrlTopic(e,t){const s=i.parseUrlHash(e);return s.path[1]=t,delete s.params.info,i.composeUrlHash(s.path,s.params)}}},7928:(e,t,s)=>{function i(e,t){t=t||window.navigator.userLanguage||window.navigator.language;const s=new Date;return e.getFullYear()==s.getFullYear()?e.getMonth()==s.getMonth()&&e.getDate()==s.getDate()?e.toLocaleTimeString(t,{hour12:!1,hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString(t,{hour12:!1,month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString(t,{year:"numeric",month:"short",day:"numeric"})}function a(e,t){t=t||window.navigator.userLanguage||window.navigator.language;const s=new Date,i=Math.floor((e.getTime()-6e4*e.getTimezoneOffset())/864e5)-Math.floor((s.getTime()-6e4*s.getTimezoneOffset())/864e5);return Math.abs(i)<2?new Intl.RelativeTimeFormat(t,{numeric:"auto"}).format(i,"day"):new Intl.DateTimeFormat(t).format(e)}function n(e,t){if("number"!=typeof e)return"";let s=(0|Math.floor(e/60))%60,i=0|Math.floor(e/3600);(t||i>0)&&(s=s<10?`0${s}`:s);let a=(0|e)%60;return a=a<10?`0${a}`:a,0==i?`${s}:${a}`:`${i}:${s}:${a}`}function o(e){if(!e||0==e)return"0 Bytes";const t=["Bytes","KB","MB","GB","TB","PB"],s=Math.min(0|Math.floor(Math.log2(e)/10),t.length-1),i=e/Math.pow(1024,s),a=s>0?i<3?2:i<30?1:0:0;return i.toFixed(a)+" "+t[s]}function r(e,t){return"string"!=typeof e?e:e.length>t?e.slice(0,t/2-1)+"…"+e.slice(1-t/2):e}function l(e,t,s){return(t?"lt-":"dk-")+(s?"fg-":"bg-")+(i=e,Math.abs(function(e){let t=0;e=""+e;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t&=t;return t}(i))%16);var i}function c(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t)}s.d(t,{SO:()=>i,YZ:()=>l,iW:()=>o,is:()=>r,qM:()=>a,sj:()=>n,tQ:()=>c})},2796:(e,t,s)=>{s.d(t,{KF:()=>m,QB:()=>n,QX:()=>r,Ut:()=>h,WU:()=>d,cz:()=>a,mM:()=>c,oH:()=>p,oQ:()=>o,oR:()=>l});var i=s(6841);function a(e){const t=document.getElementById("shortcut-icon"),s=document.head||document.getElementsByTagName("head")[0],i=document.createElement("link");i.type="image/png",i.id="shortcut-icon",i.rel="shortcut icon",i.href="img/logo32x32"+(e>0?"a":"")+".png",t&&s.removeChild(t),s.appendChild(i),document.title=(e>0?"("+e+") ":"")+"Tinode"}function n(e,t,s,a){let n=null;if((e=e&&e.trim())&&(n={fn:e}),"string"==typeof(a=a&&a.trim())&&(n=n||{},n.note=a||i.Tinode.DEL_CHAR),t){n=n||{};let e=s;const a=/^data:(image\/[-a-z0-9+.]+)?(;base64)?,/i.exec(t);a?(e=a[1],n.photo={data:t.substring(t.indexOf(",")+1),ref:i.Tinode.DEL_CHAR}):n.photo={data:i.Tinode.DEL_CHAR,ref:t},n.photo.type=(e||"image/jpeg").substring(6)}return n}function o(e,t){if(e===t)return!0;if(!Array.isArray(e)||!Array.isArray(t))return!1;if(e.length!=t.length)return!1;e.sort(),t.sort();for(let s=0,i=e.length;s<i;s++)if(e[s]!==t[s])return!1;return!0}function r(e){return e&&!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(e.replace(/\\/g,"/"))}function l(e,t){if("string"!=typeof e)return e;if(e=(e=e.replace(/[^\x21-\x7E]/gim,"").trim()).replace(/\\/g,"/"),!/^([a-z][a-z0-9+.-]*:|\/\/)/i.test(e))return e;if(/^blob:http/.test(e))return e;const s=Array.isArray(t)?t.join("|"):"http|https";return new RegExp("^(("+s+"):|//)","i").test(e)?e:null}function c(e,t){if(!e)return null;const s=l(e);if(s)return s;return new RegExp(`data:${t}/[a-z0-9.-]+;base64,`,"i").test(e.trim())?e:null}function d(e){let t="",s="";const i=e.indexOf("#");i>0&&(s=e.substring(i+1),e=e.substring(0,i));const a=e.indexOf("?");a>0&&(t=e.substring(a+1),e=e.substring(0,a));const n=new URLSearchParams(t);return n.append("asatt","1"),`${e}?${n.toString()}`+(s?`#${s}`:"")}function h(e){switch(e){case i.Tinode.MESSAGE_STATUS_SENDING:return{name:"access_time"};case i.Tinode.MESSAGE_STATUS_FAILED:case i.Tinode.MESSAGE_STATUS_FATAL:return{name:"warning",color:"danger-color"};case i.Tinode.MESSAGE_STATUS_SENT:return{name:"done"};case i.Tinode.MESSAGE_STATUS_RECEIVED:return{name:"done_all"};case i.Tinode.MESSAGE_STATUS_READ:return{name:"done_all",color:"blue"}}return null}function p(e){let t=!1;return{promise:e instanceof Error?Promise.reject(e):new Promise(((s,i)=>{e.then((e=>t?i({isCanceled:!0}):s(e)),(e=>i(t?{isCanceled:!0}:e)))})),cancel(){t=!0}}}function m(e,t){return e&&e.substring(0,t)}},9672:(e,t,s)=>{s.d(t,{c:()=>h});var i=s(6376),a=s.n(i),n=s(6648),o=s(7928),r=s(3092);const l="#666C",c=(0,n.defineMessages)({icon_title_play:{id:"icon_title_play",defaultMessage:"Play recording",description:"Icon tool tip for starting audio playback"}});class d extends a().PureComponent{constructor(e){super(e);let t=(0,r.AP)(this.props.preview);(!Array.isArray(t)||t.length<16)&&(t=null),this.state={canPlay:!1,playing:!1,currentTime:"0:00",duration:this.props.duration>0?(0,o.sj)(this.props.duration/1e3):"-:--",longMin:this.props.duration>=6e5,preview:t},this.initAudio=this.initAudio.bind(this),this.initCanvas=this.initCanvas.bind(this),this.resampleBars=this.resampleBars.bind(this),this.visualize=this.visualize.bind(this),this.handlePlay=this.handlePlay.bind(this),this.handleSeek=this.handleSeek.bind(this),this.handleError=this.handleError.bind(this),this.audioPlayer=null,this.viewBuffer=[],this.canvasRef=a().createRef()}componentDidMount(){this.props.src&&this.initAudio(),this.initCanvas()}componentWillUnmount(){this.audioPlayer&&(this.audioPlayer.onloadedmetadata=null,this.audioPlayer.ontimeupdate=null,this.audioPlayer.onended=null,this.audioPlayer.pause(),this.audioPlayer=null)}componentDidUpdate(e){if(this.props.src!=e.src&&this.initAudio(),this.props.preview!=e.preview){let e=(0,r.AP)(this.props.preview);(!Array.isArray(e)||e.length<16)&&(e=null),this.setState({preview:e},this.initCanvas)}}initAudio(){this.audioPlayer=new Audio(this.props.src),this.audioPlayer.onloadedmetadata=e=>this.setState({canPlay:!0}),this.audioPlayer.ontimeupdate=e=>this.setState({currentTime:(0,o.sj)(this.audioPlayer.currentTime,this.state.longMin)}),this.audioPlayer.onended=e=>{this.audioPlayer.currentTime=0,this.setState({playing:!1,currentTime:(0,o.sj)(0,this.state.longMin)})}}initCanvas(){this.canvasRef.current.width=2*this.canvasRef.current.offsetWidth,this.canvasRef.current.height=2*this.canvasRef.current.offsetHeight,this.canvasContext=this.canvasRef.current.getContext("2d"),this.canvasContext.lineCap="round",this.viewBuffer=this.resampleBars(this.state.preview),this.visualize()}visualize(){if(!this.canvasRef.current)return;const e=this.effectiveWidth,t=this.canvasRef.current.height;this.canvasContext.lineWidth=6;const s=i=>{if(this.canvasRef.current&&this.audioPlayer&&(this.canvasContext.clearRect(0,0,this.canvasRef.current.width,t),this.viewBuffer)){this.state.playing&&window.requestAnimationFrame(s);const i=this.props.duration?Math.max(0,Math.min(1e3*this.audioPlayer.currentTime/this.props.duration,1))*(e-12):-1;this.canvasContext.beginPath(),this.canvasContext.strokeStyle=l;for(let e=0;e<this.viewBuffer.length;e++){let s=1+10*e+3,a=Math.max(this.viewBuffer[e]*t*.9,1);const n=s<i?l:"#888A";this.canvasContext.strokeStyle!=n&&(this.canvasContext.stroke(),this.canvasContext.beginPath(),this.canvasContext.strokeStyle=n),this.canvasContext.moveTo(s,.5*(t-a)),this.canvasContext.lineTo(s,.5*(t+a))}this.canvasContext.stroke(),this.props.duration&&(this.canvasContext.beginPath(),this.canvasContext.arc(i+12,.5*t,12,0,2*Math.PI),this.canvasContext.fillStyle="#444E",this.canvasContext.fill())}};s()}resampleBars(e){const t=(this.canvasRef.current.width-4)/10|0;if(this.effectiveWidth=10*t+4,!Array.isArray(e)||0==e.length)return Array.apply(null,Array(t)).map((e=>.01));const s=e.length/t;let i=[],a=-1;for(let n=0;n<t;n++){let t=n*s|0,o=(n+1)*s|0;if(o==t)i[n]=e[t];else{let s=0;for(let i=t;i<o;i++)s+=e[i];i[n]=Math.max(0,s/(o-t))}a=Math.max(i[n],a)}return a>0?i.map((e=>e/a)):Array.apply(null,Array(t)).map((e=>.01))}handlePlay(e){e.preventDefault(),this.state.canPlay&&(this.state.playing?(this.audioPlayer.pause(),this.setState({playing:!1})):this.audioPlayer.readyState>=2&&(this.audioPlayer.play(),this.setState({playing:!0},this.visualize)))}handleError(e){console.error(e)}handleSeek(e){if(e.preventDefault(),e.target&&this.props.duration){const t=e.target.getBoundingClientRect(),s=(e.clientX-t.left)/this.effectiveWidth*2;this.audioPlayer.currentTime=this.props.duration*s/1e3,this.setState({currentTime:(0,o.sj)(this.audioPlayer.currentTime,this.state.longMin)}),this.state.playing||this.visualize()}}render(){const e="material-icons"+(this.props.short?"":" large")+(this.state.canPlay?"":" disabled"),t=a().createElement("a",{href:"#",onClick:this.handlePlay,title:this.props.intl.formatMessage(c.icon_title_play)},a().createElement("i",{className:e},this.state.playing?"pause_circle":this.state.canPlay?"play_circle":"not_interested"));return a().createElement("div",{className:"audio-player"},this.props.short?a().createElement(a().Fragment,null,a().createElement("canvas",{className:"playback",ref:this.canvasRef,onClick:this.handleSeek}),t):a().createElement(a().Fragment,null,t,a().createElement("div",null,a().createElement("canvas",{className:"playback",ref:this.canvasRef,onClick:this.handleSeek}),a().createElement("div",{className:"timer"},this.state.currentTime,"/",this.state.duration))))}}const h=(0,n.injectIntl)(d)},1320:(e,t,s)=>{s.d(t,{c:()=>l});var i=s(6376),a=s.n(i),n=s(6648);class o extends a().Component{constructor(e){super(e),this.state={panX:0,panY:0,originX:0,originY:0,zoom:1,minZoom:0,maxZoom:2.5},this.overlay=a().createRef(),this.cutout=a().createRef(),this.preview=a().createRef(),this.boundingBox=a().createRef(),this.imageWidth=0,this.imageHeight=0,this.mouseX=0,this.mouseY=0,this.prevDistance=0,this.cutoutRect={},this.bBoxRect={},this.originX=0,this.originY=0,this.initScaling=this.initScaling.bind(this),this.onZoom=this.onZoom.bind(this),this.handleZoom=this.handleZoom.bind(this),this.mouseDown=this.mouseDown.bind(this),this.mouseUp=this.mouseUp.bind(this),this.mouseMove=this.mouseMove.bind(this),this.mouseTouch=this.mouseTouch.bind(this),this.positionAll=this.positionAll.bind(this),this.translate=this.translate.bind(this)}componentDidMount(){this.overlay.current.addEventListener("mousedown",this.mouseDown,{passive:!0}),this.overlay.current.addEventListener("touchstart",this.mouseDown,{passive:!0}),this.bBoxRect=this.boundingBox.current.getBoundingClientRect(),this.originX=this.bBoxRect.width/2,this.originY=this.bBoxRect.height/2,this.cutoutRect=this.cutout.current.getBoundingClientRect()}componentWillUnmount(){this.overlay.current.removeEventListener("mousedown",this.mouseDown),this.overlay.current.removeEventListener("touchstart",this.mouseDown)}positionAll(e,t,s){this.setState({panX:e,panY:t,zoom:s,originX:this.originX-e,originY:this.originY-t});const i=(this.originX-e)*s-this.originX,a=(this.originY-t)*s-this.originY;this.props.onChange((i+this.cutoutRect.left-this.bBoxRect.left)/s,(a+this.cutoutRect.top-this.bBoxRect.top)/s,this.cutoutRect.width/s,this.cutoutRect.height/s,s)}static checkBound(e,t,s,i){let a=Math.min(0,s[0]-t[0]-i,t[1]-s[1]+i);return(0==a||Math.min(0,s[0]-t[0],t[1]-s[1])<a)&&(e+=i),e}initScaling(){const e=this.preview.current.getBoundingClientRect();this.imageWidth=e.width,this.imageHeight=e.height;const t=Math.max(this.cutoutRect.width/e.width,this.cutoutRect.height/e.height);this.setState({minZoom:t,maxZoom:Math.max(2.5,t+1)});const s=Math.max(this.bBoxRect.width/e.width,this.bBoxRect.height/e.height),i=this.cutoutRect.left-this.bBoxRect.left-(e.width-this.cutoutRect.width)/2,a=this.cutoutRect.top-this.bBoxRect.top-(e.height-this.cutoutRect.height)/2;this.positionAll(i,a,s)}onZoom(e){this.handleZoom(e.target.value)}handleZoom(e){let t=this.state.panX,s=this.state.panY;const i=this.originX-(this.originX-t)*e,a=i+this.imageWidth*e,n=this.cutoutRect.left-this.bBoxRect.left,o=n+this.cutoutRect.width;n<i?t-=i-n:o>a&&(t+=o-a);const r=this.originY-(this.originY-s)*e,l=r+this.imageHeight*e,c=this.cutoutRect.top-this.bBoxRect.top,d=c+this.cutoutRect.height;c<r?s-=r-c:d>l&&(s+=d-l),this.positionAll(t,s,e)}mouseDown(e){e.touches?(this.mouseX=e.touches[0].pageX,this.mouseY=e.touches[0].pageY):(this.mouseX=e.pageX,this.mouseY=e.pageY),window.addEventListener("mousemove",this.mouseMove,{passive:!1}),window.addEventListener("touchmove",this.mouseTouch,{passive:!1}),window.addEventListener("mouseup",this.mouseUp,{passive:!0}),window.addEventListener("touchend",this.mouseUp,{passive:!0}),document.body.style.userSelect="none"}translate(e,t){const s=e-this.mouseX,i=t-this.mouseY;this.mouseX=e,this.mouseY=t;const a=this.preview.current.getBoundingClientRect();let n=o.checkBound(this.state.panX,[a.left,a.right],[this.cutoutRect.left,this.cutoutRect.right],s),r=o.checkBound(this.state.panY,[a.top,a.bottom],[this.cutoutRect.top,this.cutoutRect.bottom],i);this.positionAll(n,r,this.state.zoom)}mouseMove(e){e.preventDefault(),this.translate(e.pageX,e.pageY)}mouseTouch(e){if(e.preventDefault(),1==e.touches.length)return void this.translate(e.touches[0].pageX,e.touches[0].pageY);const[t,s]=e.touches,i=Math.sqrt((t.pageX-s.pageX)*(t.pageX-s.pageX)+(t.pageY-s.pageY)*(t.pageY-s.pageY));this.prevDistance||(this.prevDistance=i/this.state.zoom);let a=i/this.prevDistance;this.handleZoom(Math.max(this.minZoom,Math.min(this.maxZoom,a)))}mouseUp(e){window.removeEventListener("mousemove",this.mouseMove),window.removeEventListener("touchmove",this.mouseTouch),window.removeEventListener("mouseup",this.mouseUp),window.removeEventListener("touchend",this.mouseUp),document.body.style.userSelect="",this.positionAll(this.state.panX,this.state.panY,this.state.zoom)}render(){const e=`translate3d(${this.state.panX}px, ${this.state.panY}px, 0) scale(${this.state.zoom})`,t=`${this.state.originX}px ${this.state.originY}px`,s={top:this.originY-this.state.originY*this.state.zoom+"px",left:this.originX-this.state.originX*this.state.zoom+"px",width:this.imageWidth*this.state.zoom+"px",height:this.imageHeight*this.state.zoom+"px"};return a().createElement("div",{className:"cropper"},a().createElement("div",{className:"bounding-box",ref:this.boundingBox},a().createElement("img",{src:this.props.source,className:"preview",alt:"",style:{transform:e,transformOrigin:t},ref:this.preview,onLoad:this.initScaling}),a().createElement("div",{className:"cutout circle",ref:this.cutout}),a().createElement("div",{className:"overlay",style:s,ref:this.overlay})),a().createElement("div",{className:"zoom-wrapper"},a().createElement("input",{type:"range",className:"zoomer",step:"0.001",min:this.state.minZoom,max:this.state.maxZoom,value:this.state.zoom,onChange:this.onZoom})))}}var r=s(3092);class l extends a().PureComponent{constructor(e){super(e),this.state={top:0,left:0,width:0,height:0,scale:1},this.handleSubmit=this.handleSubmit.bind(this),this.handleChange=this.handleChange.bind(this)}handleChange(e,t,s,i,a){this.setState({left:e,top:t,width:s,height:i,scale:a})}handleSubmit(){(0,r.SS)(this.props.mime,this.props.avatar,this.state.left,this.state.top,this.state.width,this.state.height,this.state.scale).then((e=>{this.props.onSubmit(e.mime,e.blob,e.width,e.height)})).catch((e=>{this.props.onError(e)}))}render(){return a().createElement("div",{className:"panel-form"},a().createElement("div",{className:"panel-form-row"},a().createElement(o,{source:this.props.avatar,onChange:this.handleChange})),a().createElement("div",{className:"dialog-buttons"},this.props.onCancel?a().createElement("button",{className:"secondary",onClick:this.props.onCancel},a().createElement(n.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})):null,a().createElement("button",{className:"primary",onClick:this.handleSubmit},a().createElement(n.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"}))))}}},5431:(e,t,s)=>{s.d(t,{c:()=>c});var i=s(6376),a=s.n(i),n=s(4092),o=s(888),r=s(2796),l=s(2380);class c extends a().Component{constructor(e){super(e),this.state={source:e.avatar},this.handleFileReceived=this.handleFileReceived.bind(this)}componentDidUpdate(e){this.props.avatar!=e.avatar&&this.setState({source:this.props.avatar})}handleFileReceived(e){const t=e.target.files[0];this.props.onImageUpdated(t.type,URL.createObjectURL(t),t.name),e.target.value=""}render(){const e="file-input-avatar-"+(""+Math.random()).substring(0,4),t="avatar-upload"+(this.props.readOnly?" read-only":"");return a().createElement("div",{className:t},this.props.readOnly||!this.state.source?null:a().createElement("a",{href:"#",className:"clear-avatar",onClick:e=>{e.preventDefault(),this.props.onImageUpdated()}},a().createElement("i",{className:"material-icons"},"clear")),this.state.source?a().createElement("img",{src:this.props.tinode.authorizeURL((0,r.mM)(this.state.source,"image")),className:"preview"}):this.props.readOnly&&this.props.uid?a().createElement("div",{className:"avatar-box"},a().createElement(n.c,{tinode:this.props.tinode,avatar:!0,topic:this.props.uid,title:this.props.title})):a().createElement("div",{className:"blank"},l.kz,"×",l.kz),this.props.readOnly?null:a().createElement("input",{type:"file",id:e,className:"inputfile hidden",accept:"image/*",onChange:this.handleFileReceived}),this.props.readOnly?null:a().createElement("label",{htmlFor:e,className:"round"},a().createElement("i",{className:"material-icons"},"file_upload")),a().createElement(o.c,{show:this.props.uploading,large:!0,clear:!0,centered:!0}))}}},7296:(e,t,s)=>{s.d(t,{c:()=>c});var i=s(6376),a=s.n(i),n=s(6648);const o={staff:"verified_user"},r=(0,n.defineMessages)({badge_verified:{id:"badge_verified",defaultMessage:"Verified/official",description:"Explanation of a verified account or topic badge"},badge_staff:{id:"badge_staff",defaultMessage:"Staff-managed",description:"Explanation of a staff-managed account or topic badge"},badge_danger:{id:"badge_danger",defaultMessage:"Untrustworthy",description:"Suspicious or untrustworthy account or topic badge"}});class l extends a().PureComponent{render(){const{formatMessage:e}=this.props.intl;let t=null;return this.props.trustedBadges&&this.props.trustedBadges.length>0?(t=[],this.props.trustedBadges.map((s=>{const i=this.props.short?null:e(r["badge_"+s]),n="material-icons "+s+"-color";t.push(a().createElement("div",{className:"trusted-badge",key:s},a().createElement("i",{className:n},o[s]||s)," ",i))})),a().createElement(a().Fragment,null,t)):null}}const c=(0,n.injectIntl)(l)},3976:(e,t,s)=>{s.d(t,{c:()=>n});var i=s(6376),a=s.n(i);class n extends a().PureComponent{constructor(e){super(e),this.handleChange=this.handleChange.bind(this)}handleChange(){this.props.onChange(this.props.name,!this.props.checked)}render(){let e,t=["material-icons"];Array.isArray(this.props.className)?t.push(...this.props.className):this.props.className&&t.push(this.props.className),this.props.onChange?this.props.checked?(t.push("blue","clickable"),e="check_box"):!1===this.props.checked?(t.push("blue","clickable"),e="check_box_outline_blank"):(t.push("lt-blue"),e="indeterminate_check_box"):e=this.props.checked?"check_box":"check_box_outline_blank";let s={className:t.join(" "),id:this.props.id};return this.props.onChange&&(s.onClick=this.handleChange),a().createElement("i",s,e)}}},4092:(e,t,s)=>{s.d(t,{c:()=>l});var i=s(6376),a=s.n(i),n=s(6841),o=s(7928),r=s(2796);class l extends a().PureComponent{render(){let e;if(!0===this.props.avatar){const t=n.Tinode.isGroupTopicName(this.props.topic),s=(0,o.YZ)(this.props.topic,t);if(this.props.topic&&this.props.title&&this.props.title.trim()){const t=this.props.title.trim().charAt(0),i="lettertile "+s+(this.props.deleted?" disabled":"");e=a().createElement("div",{className:i},a().createElement("div",null,t))}else{const i="material-icons "+s+(this.props.deleted?" disabled":"");e=t?a().createElement("i",{className:i},"group"):a().createElement("i",{className:i},"person")}}else if(this.props.avatar){const t=this.props.tinode.authorizeURL((0,r.mM)(this.props.avatar,"image")),s="avatar"+(this.props.deleted?" deleted":"");e=a().createElement("img",{className:s,alt:"avatar",src:t,onError:e=>{e.target.onerror=null,e.target.src="../img/broken_image.png"}})}else e=null;return e}}},888:(e,t,s)=>{s.d(t,{c:()=>n});var i=s(6376),a=s.n(i);class n extends a().PureComponent{render(){const e="load-spinner-box"+(this.props.large?" large":"")+(this.props.clear?" clear":"")+(this.props.centered?" centered":"");return this.props.show?a().createElement("div",{className:e},a().createElement("div",{className:"loader-spinner"})):null}}},4048:(e,t,s)=>{s.d(t,{c:()=>n});var i=s(6376),a=s.n(i);class n extends a().PureComponent{constructor(e){super(e),this.inputRef=a().createRef(),this.state={value:this.props.value||"",visible:!1},this.handleVisibility=this.handleVisibility.bind(this),this.handeTextChange=this.handeTextChange.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleEditingFinished=this.handleEditingFinished.bind(this)}componentDidMount(){this.props.autoFocus&&this.inputRef.current.focus()}handeTextChange(e){this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e)}handleVisibility(e){e.preventDefault(),this.setState({visible:!this.state.visible})}handleKeyDown(e){27==e.keyCode?(this.setState({value:this.props.value||"",visible:!1}),this.props.onFinished&&this.props.onFinished()):13==e.keyCode&&this.handleEditingFinished()}handleEditingFinished(e){if(e){let t=e.currentTarget;setTimeout((e=>{t.contains(document.activeElement)||this.props.onFinished&&this.props.onFinished(this.state.value)}),0)}else this.props.onFinished&&this.props.onFinished(this.state.value.trim())}render(){return a().createElement("div",{tabIndex:"-1",className:"group-focus",onBlur:this.handleEditingFinished},a().createElement("input",{className:"with-visibility",type:this.state.visible?"text":"password",value:this.state.value,placeholder:this.props.placeholder,required:this.props.required?"required":"",autoFocus:this.props.autoFocus?"autoFocus":"",autoComplete:this.props.autoComplete,onChange:this.handeTextChange,onKeyDown:this.handleKeyDown,ref:this.inputRef}),a().createElement("span",{onClick:this.handleVisibility},a().createElement("i",{className:"material-icons clickable light-gray"},this.state.visible?"visibility":"visibility_off")))}}},8352:(e,t,s)=>{var i=s(9944);t.C=i.createRoot,i.hydrateRoot},6376:e=>{e.exports=React},9944:e=>{e.exports=ReactDOM},6648:e=>{e.exports=ReactIntl},6841:e=>{e.exports=tinode}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={exports:{}};return a[e].call(s.exports,s,s.exports,o),s.exports}o.m=a,o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(s,i){if(1&i&&(s=this(s)),8&i)return s;if("object"==typeof s&&s){if(4&i&&s.__esModule)return s;if(16&i&&"function"==typeof s.then)return s}var a=Object.create(null);o.r(a);var n={};e=e||[null,t({}),t([]),t(t)];for(var r=2&i&&s;"object"==typeof r&&!~e.indexOf(r);r=t(r))Object.getOwnPropertyNames(r).forEach((e=>n[e]=()=>s[e]));return n.default=()=>s,o.d(a,n),a},o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,s)=>(o.f[s](e,t),t)),[])),o.u=e=>e+".prod.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},i="tinode-webapp:",o.l=(e,t,a,n)=>{if(s[e])s[e].push(t);else{var r,l;if(void 0!==a)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var h=c[d];if(h.getAttribute("src")==e||h.getAttribute("data-webpack")==i+a){r=h;break}}r||(l=!0,(r=document.createElement("script")).charset="utf-8",r.timeout=120,o.nc&&r.setAttribute("nonce",o.nc),r.setAttribute("data-webpack",i+a),r.src=e),s[e]=[t];var p=(t,i)=>{r.onerror=r.onload=null,clearTimeout(m);var a=s[e];if(delete s[e],r.parentNode&&r.parentNode.removeChild(r),a&&a.forEach((e=>e(i))),t)return t(i)},m=setTimeout(p.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=p.bind(null,r.onerror),r.onload=p.bind(null,r.onload),l&&document.head.appendChild(r)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="/umd/",(()=>{var e={656:0};o.f.j=(t,s)=>{var i=o.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var a=new Promise(((s,a)=>i=e[t]=[s,a]));s.push(i[2]=a);var n=o.p+o.u(t),r=new Error;o.l(n,(s=>{if(o.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=s&&("load"===s.type?"missing":s.type),n=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+a+": "+n+")",r.name="ChunkLoadError",r.type=a,r.request=n,i[1](r)}}),"chunk-"+t,t)}};var t=(t,s)=>{var i,a,[n,r,l]=s,c=0;if(n.some((t=>0!==e[t]))){for(i in r)o.o(r,i)&&(o.m[i]=r[i]);if(l)l(o)}for(t&&t(s);c<n.length;c++)a=n[c],o.o(e,a)&&e[a]&&e[a][0](),e[a]=0},s=globalThis.webpackChunktinode_webapp=globalThis.webpackChunktinode_webapp||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),(()=>{var e=o(6376),t=o.n(e),s=o(8352),i=o(6648);const a=function(e){const t=[];let s=0;for(let i=0;i<e.length;i++){let a=e.charCodeAt(i);a<128?t[s++]=a:a<2048?(t[s++]=a>>6|192,t[s++]=63&a|128):55296==(64512&a)&&i+1<e.length&&56320==(64512&e.charCodeAt(i+1))?(a=65536+((1023&a)<<10)+(1023&e.charCodeAt(++i)),t[s++]=a>>18|240,t[s++]=a>>12&63|128,t[s++]=a>>6&63|128,t[s++]=63&a|128):(t[s++]=a>>12|224,t[s++]=a>>6&63|128,t[s++]=63&a|128)}return t},n={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const s=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let t=0;t<e.length;t+=3){const a=e[t],n=t+1<e.length,o=n?e[t+1]:0,r=t+2<e.length,l=r?e[t+2]:0,c=a>>2,d=(3&a)<<4|o>>4;let h=(15&o)<<2|l>>6,p=63&l;r||(p=64,n||(h=64)),i.push(s[c],s[d],s[h],s[p])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(a(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let s=0,i=0;for(;s<e.length;){const a=e[s++];if(a<128)t[i++]=String.fromCharCode(a);else if(a>191&&a<224){const n=e[s++];t[i++]=String.fromCharCode((31&a)<<6|63&n)}else if(a>239&&a<365){const n=((7&a)<<18|(63&e[s++])<<12|(63&e[s++])<<6|63&e[s++])-65536;t[i++]=String.fromCharCode(55296+(n>>10)),t[i++]=String.fromCharCode(56320+(1023&n))}else{const n=e[s++],o=e[s++];t[i++]=String.fromCharCode((15&a)<<12|(63&n)<<6|63&o)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const s=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let t=0;t<e.length;){const a=s[e.charAt(t++)],n=t<e.length?s[e.charAt(t)]:0;++t;const o=t<e.length?s[e.charAt(t)]:64;++t;const l=t<e.length?s[e.charAt(t)]:64;if(++t,null==a||null==n||null==o||null==l)throw new r;const c=a<<2|n>>4;if(i.push(c),64!==o){const e=n<<4&240|o>>2;if(i.push(e),64!==l){const e=o<<6&192|l;i.push(e)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class r extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const l=function(e){return function(e){const t=a(e);return n.encodeByteArray(t,!0)}(e).replace(/\./g,"")},c=function(e){try{return n.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};const d=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==o.g)return o.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,h=()=>{try{return d()||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&c(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},p=()=>{var e;return null===(e=h())||void 0===e?void 0:e.config};class m{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,s))}}}class u extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name="FirebaseError",Object.setPrototypeOf(this,u.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,g.prototype.create)}}class g{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,a=this.errors[e],n=a?function(e,t){return e.replace(f,((e,s)=>{const i=t[s];return null!=i?String(i):`<${s}?>`}))}(a,s):"Error",o=`${this.serviceName}: ${n} (${i}).`;return new u(i,o,s)}}const f=/\{\$([^}]+)}/g;function b(e,t){if(e===t)return!0;const s=Object.keys(e),i=Object.keys(t);for(const a of s){if(!i.includes(a))return!1;const s=e[a],n=t[a];if(v(s)&&v(n)){if(!b(s,n))return!1}else if(s!==n)return!1}for(const e of i)if(!s.includes(e))return!1;return!0}function v(e){return null!==e&&"object"==typeof e}class w{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const E="[DEFAULT]";class C{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new m;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const s=this.getOrInitializeService({instanceIdentifier:t});s&&e.resolve(s)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const s=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),i=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(s)&&!this.shouldAutoInitialize()){if(i)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:s})}catch(e){if(i)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:E})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const s=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:s});t.resolve(e)}catch(e){}}}}clearInstance(e=E){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=E){return this.instances.has(e)}getOptions(e=E){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[e,t]of this.instancesDeferred.entries()){s===this.normalizeInstanceIdentifier(e)&&t.resolve(i)}return i}onInit(e,t){var s;const i=this.normalizeInstanceIdentifier(t),a=null!==(s=this.onInitCallbacks.get(i))&&void 0!==s?s:new Set;a.add(e),this.onInitCallbacks.set(i,a);const n=this.instances.get(i);return n&&e(n,i),()=>{a.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:(i=e,i===E?void 0:i),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch(e){}var i;return s||null}normalizeInstanceIdentifier(e=E){return this.component?this.component.multipleInstances?e:E:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class S{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new C(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const y=[];var M;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(M||(M={}));const _={debug:M.DEBUG,verbose:M.VERBOSE,info:M.INFO,warn:M.WARN,error:M.ERROR,silent:M.SILENT},T=M.INFO,k={[M.DEBUG]:"log",[M.VERBOSE]:"log",[M.INFO]:"info",[M.WARN]:"warn",[M.ERROR]:"error"},A=(e,t,...s)=>{if(t<e.logLevel)return;const i=(new Date).toISOString(),a=k[t];if(!a)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[a](`[${i}]  ${e.name}:`,...s)};const D=(e,t)=>t.some((t=>e instanceof t));let N,I;const P=new WeakMap,R=new WeakMap,x=new WeakMap,F=new WeakMap,U=new WeakMap;let L={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return R.get(e);if("objectStoreNames"===t)return e.objectStoreNames||x.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return q(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function O(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(I||(I=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(j(this),t),q(P.get(this))}:function(...t){return q(e.apply(j(this),t))}:function(t,...s){const i=e.call(j(this),t,...s);return x.set(i,t.sort?t.sort():[t]),q(i)}}function B(e){return"function"==typeof e?O(e):(e instanceof IDBTransaction&&function(e){if(R.has(e))return;const t=new Promise(((t,s)=>{const i=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",n),e.removeEventListener("abort",n)},a=()=>{t(),i()},n=()=>{s(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",a),e.addEventListener("error",n),e.addEventListener("abort",n)}));R.set(e,t)}(e),D(e,N||(N=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,L):e)}function q(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const i=()=>{e.removeEventListener("success",a),e.removeEventListener("error",n)},a=()=>{t(q(e.result)),i()},n=()=>{s(e.error),i()};e.addEventListener("success",a),e.addEventListener("error",n)}));return t.then((t=>{t instanceof IDBCursor&&P.set(t,e)})).catch((()=>{})),U.set(t,e),t}(e);if(F.has(e))return F.get(e);const t=B(e);return t!==e&&(F.set(e,t),U.set(t,e)),t}const j=e=>U.get(e);function V(e,t,{blocked:s,upgrade:i,blocking:a,terminated:n}={}){const o=indexedDB.open(e,t),r=q(o);return i&&o.addEventListener("upgradeneeded",(e=>{i(q(o.result),e.oldVersion,e.newVersion,q(o.transaction),e)})),s&&o.addEventListener("blocked",(e=>s(e.oldVersion,e.newVersion,e))),r.then((e=>{n&&e.addEventListener("close",(()=>n())),a&&e.addEventListener("versionchange",(e=>a(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),r}function H(e,{blocked:t}={}){const s=indexedDB.deleteDatabase(e);return t&&s.addEventListener("blocked",(e=>t(e.oldVersion,e))),q(s).then((()=>{}))}const W=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],K=new Map;function Q(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(K.get(t))return K.get(t);const s=t.replace(/FromIndex$/,""),i=t!==s,a=z.includes(s);if(!(s in(i?IDBIndex:IDBObjectStore).prototype)||!a&&!W.includes(s))return;const n=async function(e,...t){const n=this.transaction(e,a?"readwrite":"readonly");let o=n.store;return i&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),a&&n.done]))[0]};return K.set(t,n),n}L=(e=>({...e,get:(t,s,i)=>Q(t,s)||e.get(t,s,i),has:(t,s)=>!!Q(t,s)||e.has(t,s)}))(L);class G{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const $="@firebase/app",Y="0.9.27",X=new class{constructor(e){this.name=e,this._logLevel=T,this._logHandler=A,this._userLogHandler=null,y.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in M))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?_[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,M.DEBUG,...e),this._logHandler(this,M.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,M.VERBOSE,...e),this._logHandler(this,M.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,M.INFO,...e),this._logHandler(this,M.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,M.WARN,...e),this._logHandler(this,M.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,M.ERROR,...e),this._logHandler(this,M.ERROR,...e)}}("@firebase/app"),J="[DEFAULT]",Z={[$]:"fire-core","@firebase/app-compat":"fire-core-compat","@firebase/analytics":"fire-analytics","@firebase/analytics-compat":"fire-analytics-compat","@firebase/app-check":"fire-app-check","@firebase/app-check-compat":"fire-app-check-compat","@firebase/auth":"fire-auth","@firebase/auth-compat":"fire-auth-compat","@firebase/database":"fire-rtdb","@firebase/database-compat":"fire-rtdb-compat","@firebase/functions":"fire-fn","@firebase/functions-compat":"fire-fn-compat","@firebase/installations":"fire-iid","@firebase/installations-compat":"fire-iid-compat","@firebase/messaging":"fire-fcm","@firebase/messaging-compat":"fire-fcm-compat","@firebase/performance":"fire-perf","@firebase/performance-compat":"fire-perf-compat","@firebase/remote-config":"fire-rc","@firebase/remote-config-compat":"fire-rc-compat","@firebase/storage":"fire-gcs","@firebase/storage-compat":"fire-gcs-compat","@firebase/firestore":"fire-fst","@firebase/firestore-compat":"fire-fst-compat","fire-js":"fire-js",firebase:"fire-js-all"},ee=new Map,te=new Map;function se(e,t){try{e.container.addComponent(t)}catch(s){X.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,s)}}function ie(e){const t=e.name;if(te.has(t))return X.debug(`There were multiple attempts to register component ${t}.`),!1;te.set(t,e);for(const t of ee.values())se(t,e);return!0}function ae(e,t){const s=e.container.getProvider("heartbeat").getImmediate({optional:!0});return s&&s.triggerHeartbeat(),e.container.getProvider(t)}const ne=new g("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class oe{constructor(e,t,s){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new w("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw ne.create("app-deleted",{appName:this._name})}}function re(e,t={}){let s=e;if("object"!=typeof t){t={name:t}}const i=Object.assign({name:J,automaticDataCollectionEnabled:!1},t),a=i.name;if("string"!=typeof a||!a)throw ne.create("bad-app-name",{appName:String(a)});if(s||(s=p()),!s)throw ne.create("no-options");const n=ee.get(a);if(n){if(b(s,n.options)&&b(i,n.config))return n;throw ne.create("duplicate-app",{appName:a})}const o=new S(a);for(const e of te.values())o.addComponent(e);const r=new oe(s,i,o);return ee.set(a,r),r}function le(e,t,s){var i;let a=null!==(i=Z[e])&&void 0!==i?i:e;s&&(a+=`-${s}`);const n=a.match(/\s|\//),o=t.match(/\s|\//);if(n||o){const e=[`Unable to register library "${a}" with version "${t}":`];return n&&e.push(`library name "${a}" contains illegal characters (whitespace or "/")`),n&&o&&e.push("and"),o&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void X.warn(e.join(" "))}ie(new w(`${a}-version`,(()=>({library:a,version:t})),"VERSION"))}const ce="firebase-heartbeat-database",de=1,he="firebase-heartbeat-store";let pe=null;function me(){return pe||(pe=V(ce,de,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(he)}catch(e){console.warn(e)}}}).catch((e=>{throw ne.create("idb-open",{originalErrorMessage:e.message})}))),pe}async function ue(e,t){try{const s=(await me()).transaction(he,"readwrite"),i=s.objectStore(he);await i.put(t,ge(e)),await s.done}catch(e){if(e instanceof u)X.warn(e.message);else{const t=ne.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});X.warn(t.message)}}}function ge(e){return`${e.name}!${e.options.appId}`}class fe{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new ve(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const s=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),i=be();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==i&&!this._heartbeatsCache.heartbeats.some((e=>e.date===i)))return this._heartbeatsCache.heartbeats.push({date:i,agent:s}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=be(),{heartbeatsToSend:s,unsentEntries:i}=function(e,t=1024){const s=[];let i=e.slice();for(const a of e){const e=s.find((e=>e.agent===a.agent));if(e){if(e.dates.push(a.date),we(s)>t){e.dates.pop();break}}else if(s.push({agent:a.agent,dates:[a.date]}),we(s)>t){s.pop();break}i=i.slice(1)}return{heartbeatsToSend:s,unsentEntries:i}}(this._heartbeatsCache.heartbeats),a=l(JSON.stringify({version:2,heartbeats:s}));return this._heartbeatsCache.lastSentHeartbeatDate=t,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),a}}function be(){return(new Date).toISOString().substring(0,10)}class ve{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let s=!0;const i="validate-browser-context-for-indexeddb-analytics-module",a=self.indexedDB.open(i);a.onsuccess=()=>{a.result.close(),s||self.indexedDB.deleteDatabase(i),e(!0)},a.onupgradeneeded=()=>{s=!1},a.onerror=()=>{var e;t((null===(e=a.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await me()).transaction(he),s=await t.objectStore(he).get(ge(e));return await t.done,s}catch(e){if(e instanceof u)X.warn(e.message);else{const t=ne.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});X.warn(t.message)}}}(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return ue(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return ue(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}}}function we(e){return l(JSON.stringify({version:2,heartbeats:e})).length}var Ee;Ee="",ie(new w("platform-logger",(e=>new G(e)),"PRIVATE")),ie(new w("heartbeat",(e=>new fe(e)),"PRIVATE")),le($,Y,Ee),le($,Y,"esm2017"),le("fire-js","");le("firebase","10.8.0","app");const Ce="@firebase/installations",Se="0.6.5",ye=1e4,Me=`w:${Se}`,_e="FIS_v2",Te="https://firebaseinstallations.googleapis.com/v1",ke=36e5,Ae=new g("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function De(e){return e instanceof u&&e.code.includes("request-failed")}function Ne({projectId:e}){return`${Te}/projects/${e}/installations`}function Ie(e){return{token:e.token,requestStatus:2,expiresIn:(t=e.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()};var t}async function Pe(e,t){const s=(await t.json()).error;return Ae.create("request-failed",{requestName:e,serverCode:s.code,serverMessage:s.message,serverStatus:s.status})}function Re({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}function xe(e,{refreshToken:t}){const s=Re(e);return s.append("Authorization",function(e){return`${_e} ${e}`}(t)),s}async function Fe(e){const t=await e();return t.status>=500&&t.status<600?e():t}function Ue(e){return new Promise((t=>{setTimeout(t,e)}))}const Le=/^[cdef][\w-]{21}$/,Oe="";function Be(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const t=function(e){const t=(s=e,btoa(String.fromCharCode(...s)).replace(/\+/g,"-").replace(/\//g,"_"));var s;return t.substr(0,22)}(e);return Le.test(t)?t:Oe}catch(e){return Oe}}function qe(e){return`${e.appName}!${e.appId}`}const je=new Map;function Ve(e,t){const s=qe(e);He(s,t),function(e,t){const s=ze();s&&s.postMessage({key:e,fid:t});Ke()}(s,t)}function He(e,t){const s=je.get(e);if(s)for(const e of s)e(t)}let We=null;function ze(){return!We&&"BroadcastChannel"in self&&(We=new BroadcastChannel("[Firebase] FID Change"),We.onmessage=e=>{He(e.data.key,e.data.fid)}),We}function Ke(){0===je.size&&We&&(We.close(),We=null)}const Qe="firebase-installations-database",Ge=1,$e="firebase-installations-store";let Ye=null;function Xe(){return Ye||(Ye=V(Qe,Ge,{upgrade:(e,t)=>{if(0===t)e.createObjectStore($e)}})),Ye}async function Je(e,t){const s=qe(e),i=(await Xe()).transaction($e,"readwrite"),a=i.objectStore($e),n=await a.get(s);return await a.put(t,s),await i.done,n&&n.fid===t.fid||Ve(e,t.fid),t}async function Ze(e){const t=qe(e),s=(await Xe()).transaction($e,"readwrite");await s.objectStore($e).delete(t),await s.done}async function et(e,t){const s=qe(e),i=(await Xe()).transaction($e,"readwrite"),a=i.objectStore($e),n=await a.get(s),o=t(n);return void 0===o?await a.delete(s):await a.put(o,s),await i.done,!o||n&&n.fid===o.fid||Ve(e,o.fid),o}async function tt(e){let t;const s=await et(e.appConfig,(s=>{const i=function(e){const t=e||{fid:Be(),registrationStatus:0};return at(t)}(s),a=function(e,t){if(0===t.registrationStatus){if(!navigator.onLine){return{installationEntry:t,registrationPromise:Promise.reject(Ae.create("app-offline"))}}const s={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},i=async function(e,t){try{const s=await async function({appConfig:e,heartbeatServiceProvider:t},{fid:s}){const i=Ne(e),a=Re(e),n=t.getImmediate({optional:!0});if(n){const e=await n.getHeartbeatsHeader();e&&a.append("x-firebase-client",e)}const o={fid:s,authVersion:_e,appId:e.appId,sdkVersion:Me},r={method:"POST",headers:a,body:JSON.stringify(o)},l=await Fe((()=>fetch(i,r)));if(l.ok){const e=await l.json();return{fid:e.fid||s,registrationStatus:2,refreshToken:e.refreshToken,authToken:Ie(e.authToken)}}throw await Pe("Create Installation",l)}(e,t);return Je(e.appConfig,s)}catch(s){throw De(s)&&409===s.customData.serverCode?await Ze(e.appConfig):await Je(e.appConfig,{fid:t.fid,registrationStatus:0}),s}}(e,s);return{installationEntry:s,registrationPromise:i}}return 1===t.registrationStatus?{installationEntry:t,registrationPromise:st(e)}:{installationEntry:t}}(e,i);return t=a.registrationPromise,a.installationEntry}));return s.fid===Oe?{installationEntry:await t}:{installationEntry:s,registrationPromise:t}}async function st(e){let t=await it(e.appConfig);for(;1===t.registrationStatus;)await Ue(100),t=await it(e.appConfig);if(0===t.registrationStatus){const{installationEntry:t,registrationPromise:s}=await tt(e);return s||t}return t}function it(e){return et(e,(e=>{if(!e)throw Ae.create("installation-not-found");return at(e)}))}function at(e){return 1===(t=e).registrationStatus&&t.registrationTime+ye<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t}async function nt({appConfig:e,heartbeatServiceProvider:t},s){const i=function(e,{fid:t}){return`${Ne(e)}/${t}/authTokens:generate`}(e,s),a=xe(e,s),n=t.getImmediate({optional:!0});if(n){const e=await n.getHeartbeatsHeader();e&&a.append("x-firebase-client",e)}const o={installation:{sdkVersion:Me,appId:e.appId}},r={method:"POST",headers:a,body:JSON.stringify(o)},l=await Fe((()=>fetch(i,r)));if(l.ok){return Ie(await l.json())}throw await Pe("Generate Auth Token",l)}async function ot(e,t=!1){let s;const i=await et(e.appConfig,(i=>{if(!lt(i))throw Ae.create("not-registered");const a=i.authToken;if(!t&&function(e){return 2===e.requestStatus&&!function(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+ke}(e)}(a))return i;if(1===a.requestStatus)return s=async function(e,t){let s=await rt(e.appConfig);for(;1===s.authToken.requestStatus;)await Ue(100),s=await rt(e.appConfig);const i=s.authToken;return 0===i.requestStatus?ot(e,t):i}(e,t),i;{if(!navigator.onLine)throw Ae.create("app-offline");const t=function(e){const t={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},e),{authToken:t})}(i);return s=async function(e,t){try{const s=await nt(e,t),i=Object.assign(Object.assign({},t),{authToken:s});return await Je(e.appConfig,i),s}catch(s){if(!De(s)||401!==s.customData.serverCode&&404!==s.customData.serverCode){const s=Object.assign(Object.assign({},t),{authToken:{requestStatus:0}});await Je(e.appConfig,s)}else await Ze(e.appConfig);throw s}}(e,t),t}}));return s?await s:i.authToken}function rt(e){return et(e,(e=>{if(!lt(e))throw Ae.create("not-registered");const t=e.authToken;return 1===(s=t).requestStatus&&s.requestTime+ye<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e;var s}))}function lt(e){return void 0!==e&&2===e.registrationStatus}async function ct(e,t=!1){const s=e;await async function(e){const{registrationPromise:t}=await tt(e);t&&await t}(s);return(await ot(s,t)).token}function dt(e){return Ae.create("missing-app-config-values",{valueName:e})}const ht="installations",pt=e=>{const t=ae(e.getProvider("app").getImmediate(),ht).getImmediate();return{getId:()=>async function(e){const t=e,{installationEntry:s,registrationPromise:i}=await tt(t);return i?i.catch(console.error):ot(t).catch(console.error),s.fid}(t),getToken:e=>ct(t,e)}};ie(new w(ht,(e=>{const t=e.getProvider("app").getImmediate(),s=function(e){if(!e||!e.options)throw dt("App Configuration");if(!e.name)throw dt("App Name");const t=["projectId","apiKey","appId"];for(const s of t)if(!e.options[s])throw dt(s);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(t);return{app:t,appConfig:s,heartbeatServiceProvider:ae(t,"heartbeat"),_delete:()=>Promise.resolve()}}),"PUBLIC")),ie(new w("installations-internal",pt,"PRIVATE")),le(Ce,Se),le(Ce,Se,"esm2017");const mt="/firebase-messaging-sw.js",ut="/firebase-cloud-messaging-push-scope",gt="BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4",ft="https://fcmregistrations.googleapis.com/v1",bt="google.c.a.c_id",vt="google.c.a.c_l",wt="google.c.a.ts";var Et,Ct;function St(e){const t=new Uint8Array(e);return btoa(String.fromCharCode(...t)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function yt(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),s=atob(t),i=new Uint8Array(s.length);for(let e=0;e<s.length;++e)i[e]=s.charCodeAt(e);return i}!function(e){e[e.DATA_MESSAGE=1]="DATA_MESSAGE",e[e.DISPLAY_NOTIFICATION=3]="DISPLAY_NOTIFICATION"}(Et||(Et={})),function(e){e.PUSH_RECEIVED="push-received",e.NOTIFICATION_CLICKED="notification-clicked"}(Ct||(Ct={}));const Mt="fcm_token_details_db",_t=5,Tt="fcm_token_object_Store";const kt="firebase-messaging-database",At=1,Dt="firebase-messaging-store";let Nt=null;function It(){return Nt||(Nt=V(kt,At,{upgrade:(e,t)=>{if(0===t)e.createObjectStore(Dt)}})),Nt}async function Pt(e){const t=xt(e),s=await It(),i=await s.transaction(Dt).objectStore(Dt).get(t);if(i)return i;{const t=await async function(e){if("databases"in indexedDB){const e=(await indexedDB.databases()).map((e=>e.name));if(!e.includes(Mt))return null}let t=null;return(await V(Mt,_t,{upgrade:async(s,i,a,n)=>{var o;if(i<2)return;if(!s.objectStoreNames.contains(Tt))return;const r=n.objectStore(Tt),l=await r.index("fcmSenderId").get(e);if(await r.clear(),l)if(2===i){const e=l;if(!e.auth||!e.p256dh||!e.endpoint)return;t={token:e.fcmToken,createTime:null!==(o=e.createTime)&&void 0!==o?o:Date.now(),subscriptionOptions:{auth:e.auth,p256dh:e.p256dh,endpoint:e.endpoint,swScope:e.swScope,vapidKey:"string"==typeof e.vapidKey?e.vapidKey:St(e.vapidKey)}}}else if(3===i){const e=l;t={token:e.fcmToken,createTime:e.createTime,subscriptionOptions:{auth:St(e.auth),p256dh:St(e.p256dh),endpoint:e.endpoint,swScope:e.swScope,vapidKey:St(e.vapidKey)}}}else if(4===i){const e=l;t={token:e.fcmToken,createTime:e.createTime,subscriptionOptions:{auth:St(e.auth),p256dh:St(e.p256dh),endpoint:e.endpoint,swScope:e.swScope,vapidKey:St(e.vapidKey)}}}}})).close(),await H(Mt),await H("fcm_vapid_details_db"),await H("undefined"),function(e){if(!e||!e.subscriptionOptions)return!1;const{subscriptionOptions:t}=e;return"number"==typeof e.createTime&&e.createTime>0&&"string"==typeof e.token&&e.token.length>0&&"string"==typeof t.auth&&t.auth.length>0&&"string"==typeof t.p256dh&&t.p256dh.length>0&&"string"==typeof t.endpoint&&t.endpoint.length>0&&"string"==typeof t.swScope&&t.swScope.length>0&&"string"==typeof t.vapidKey&&t.vapidKey.length>0}(t)?t:null}(e.appConfig.senderId);if(t)return await Rt(e,t),t}}async function Rt(e,t){const s=xt(e),i=(await It()).transaction(Dt,"readwrite");return await i.objectStore(Dt).put(t,s),await i.done,t}function xt({appConfig:e}){return e.appId}const Ft=new g("messaging","Messaging",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"only-available-in-window":"This method is available in a Window context.","only-available-in-sw":"This method is available in a service worker context.","permission-default":"The notification permission was not granted and dismissed instead.","permission-blocked":"The notification permission was not granted and blocked instead.","unsupported-browser":"This browser doesn't support the API's required to use the Firebase SDK.","indexed-db-unsupported":"This browser doesn't support indexedDb.open() (ex. Safari iFrame, Firefox Private Browsing, etc)","failed-service-worker-registration":"We are unable to register the default service worker. {$browserErrorMessage}","token-subscribe-failed":"A problem occurred while subscribing the user to FCM: {$errorInfo}","token-subscribe-no-token":"FCM returned no token when subscribing the user to push.","token-unsubscribe-failed":"A problem occurred while unsubscribing the user from FCM: {$errorInfo}","token-update-failed":"A problem occurred while updating the user from FCM: {$errorInfo}","token-update-no-token":"FCM returned no token when updating the user to push.","use-sw-after-get-token":"The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.","invalid-sw-registration":"The input to useServiceWorker() must be a ServiceWorkerRegistration.","invalid-bg-handler":"The input to setBackgroundMessageHandler() must be a function.","invalid-vapid-key":"The public VAPID key must be a string.","use-vapid-key-after-get-token":"The usePublicVapidKey() method may only be called once and must be called before calling getToken() to ensure your VAPID key is used."});async function Ut(e,t){const s={method:"DELETE",headers:await Ot(e)};try{const i=await fetch(`${Lt(e.appConfig)}/${t}`,s),a=await i.json();if(a.error){const e=a.error.message;throw Ft.create("token-unsubscribe-failed",{errorInfo:e})}}catch(e){throw Ft.create("token-unsubscribe-failed",{errorInfo:null==e?void 0:e.toString()})}}function Lt({projectId:e}){return`${ft}/projects/${e}/registrations`}async function Ot({appConfig:e,installations:t}){const s=await t.getToken();return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e.apiKey,"x-goog-firebase-installations-auth":`FIS ${s}`})}function Bt({p256dh:e,auth:t,endpoint:s,vapidKey:i}){const a={web:{endpoint:s,auth:t,p256dh:e}};return i!==gt&&(a.web.applicationPubKey=i),a}const qt=6048e5;async function jt(e){const t=await async function(e,t){const s=await e.pushManager.getSubscription();if(s)return s;return e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:yt(t)})}(e.swRegistration,e.vapidKey),s={vapidKey:e.vapidKey,swScope:e.swRegistration.scope,endpoint:t.endpoint,auth:St(t.getKey("auth")),p256dh:St(t.getKey("p256dh"))},i=await Pt(e.firebaseDependencies);if(i){if(function(e,t){const s=t.vapidKey===e.vapidKey,i=t.endpoint===e.endpoint,a=t.auth===e.auth,n=t.p256dh===e.p256dh;return s&&i&&a&&n}(i.subscriptionOptions,s))return Date.now()>=i.createTime+qt?async function(e,t){try{const s=await async function(e,t){const s=await Ot(e),i=Bt(t.subscriptionOptions),a={method:"PATCH",headers:s,body:JSON.stringify(i)};let n;try{const s=await fetch(`${Lt(e.appConfig)}/${t.token}`,a);n=await s.json()}catch(e){throw Ft.create("token-update-failed",{errorInfo:null==e?void 0:e.toString()})}if(n.error){const e=n.error.message;throw Ft.create("token-update-failed",{errorInfo:e})}if(!n.token)throw Ft.create("token-update-no-token");return n.token}(e.firebaseDependencies,t),i=Object.assign(Object.assign({},t),{token:s,createTime:Date.now()});return await Rt(e.firebaseDependencies,i),s}catch(t){throw await Vt(e),t}}(e,{token:i.token,createTime:Date.now(),subscriptionOptions:s}):i.token;try{await Ut(e.firebaseDependencies,i.token)}catch(e){console.warn(e)}return Ht(e.firebaseDependencies,s)}return Ht(e.firebaseDependencies,s)}async function Vt(e){const t=await Pt(e.firebaseDependencies);t&&(await Ut(e.firebaseDependencies,t.token),await async function(e){const t=xt(e),s=(await It()).transaction(Dt,"readwrite");await s.objectStore(Dt).delete(t),await s.done}(e.firebaseDependencies));const s=await e.swRegistration.pushManager.getSubscription();return!s||s.unsubscribe()}async function Ht(e,t){const s=await async function(e,t){const s=await Ot(e),i=Bt(t),a={method:"POST",headers:s,body:JSON.stringify(i)};let n;try{const t=await fetch(Lt(e.appConfig),a);n=await t.json()}catch(e){throw Ft.create("token-subscribe-failed",{errorInfo:null==e?void 0:e.toString()})}if(n.error){const e=n.error.message;throw Ft.create("token-subscribe-failed",{errorInfo:e})}if(!n.token)throw Ft.create("token-subscribe-no-token");return n.token}(e,t),i={token:s,createTime:Date.now(),subscriptionOptions:t};return await Rt(e,i),i.token}function Wt(e){const t={from:e.from,collapseKey:e.collapse_key,messageId:e.fcmMessageId};return function(e,t){if(!t.notification)return;e.notification={};const s=t.notification.title;s&&(e.notification.title=s);const i=t.notification.body;i&&(e.notification.body=i);const a=t.notification.image;a&&(e.notification.image=a);const n=t.notification.icon;n&&(e.notification.icon=n)}(t,e),function(e,t){if(!t.data)return;e.data=t.data}(t,e),function(e,t){var s,i,a,n,o;if(!t.fcmOptions&&!(null===(s=t.notification)||void 0===s?void 0:s.click_action))return;e.fcmOptions={};const r=null!==(a=null===(i=t.fcmOptions)||void 0===i?void 0:i.link)&&void 0!==a?a:null===(n=t.notification)||void 0===n?void 0:n.click_action;r&&(e.fcmOptions.link=r);const l=null===(o=t.fcmOptions)||void 0===o?void 0:o.analytics_label;l&&(e.fcmOptions.analyticsLabel=l)}(t,e),t}function zt(e,t){const s=[];for(let i=0;i<e.length;i++)s.push(e.charAt(i)),i<t.length&&s.push(t.charAt(i));return s.join("")}function Kt(e){return Ft.create("missing-app-config-values",{valueName:e})}zt("hts/frbslgigp.ogepscmv/ieo/eaylg","tp:/ieaeogn-agolai.o/1frlglgc/o"),zt("AzSCbw63g1R0nCw85jG8","Iaya3yLKwmgvh7cF0q4");class Qt{constructor(e,t,s){this.deliveryMetricsExportedToBigQueryEnabled=!1,this.onBackgroundMessageHandler=null,this.onMessageHandler=null,this.logEvents=[],this.isLogServiceStarted=!1;const i=function(e){if(!e||!e.options)throw Kt("App Configuration Object");if(!e.name)throw Kt("App Name");const t=["projectId","apiKey","appId","messagingSenderId"],{options:s}=e;for(const e of t)if(!s[e])throw Kt(e);return{appName:e.name,projectId:s.projectId,apiKey:s.apiKey,appId:s.appId,senderId:s.messagingSenderId}}(e);this.firebaseDependencies={app:e,appConfig:i,installations:t,analyticsProvider:s}}_delete(){return Promise.resolve()}}async function Gt(e){try{e.swRegistration=await navigator.serviceWorker.register(mt,{scope:ut}),e.swRegistration.update().catch((()=>{}))}catch(e){throw Ft.create("failed-service-worker-registration",{browserErrorMessage:null==e?void 0:e.message})}}async function $t(e,t){if(!navigator)throw Ft.create("only-available-in-window");if("default"===Notification.permission&&await Notification.requestPermission(),"granted"!==Notification.permission)throw Ft.create("permission-blocked");return await async function(e,t){t?e.vapidKey=t:e.vapidKey||(e.vapidKey=gt)}(e,null==t?void 0:t.vapidKey),await async function(e,t){if(t||e.swRegistration||await Gt(e),t||!e.swRegistration){if(!(t instanceof ServiceWorkerRegistration))throw Ft.create("invalid-sw-registration");e.swRegistration=t}}(e,null==t?void 0:t.serviceWorkerRegistration),jt(e)}async function Yt(e,t,s){const i=function(e){switch(e){case Ct.NOTIFICATION_CLICKED:return"notification_open";case Ct.PUSH_RECEIVED:return"notification_foreground";default:throw new Error}}(t);(await e.firebaseDependencies.analyticsProvider.get()).logEvent(i,{message_id:s[bt],message_name:s[vt],message_time:s[wt],message_device_time:Math.floor(Date.now()/1e3)})}async function Xt(e,t){const s=t.data;if(!s.isFirebaseMessaging)return;e.onMessageHandler&&s.messageType===Ct.PUSH_RECEIVED&&("function"==typeof e.onMessageHandler?e.onMessageHandler(Wt(s)):e.onMessageHandler.next(Wt(s)));const i=s.data;var a;"object"==typeof(a=i)&&a&&bt in a&&"1"===i["google.c.a.e"]&&await Yt(e,s.messageType,i)}const Jt="@firebase/messaging",Zt="0.12.6",es=e=>{const t=e.getProvider("messaging").getImmediate();return{getToken:e=>$t(t,e)}};function ts(e){var t;return async function(e){if(!navigator)throw Ft.create("only-available-in-window");return e.swRegistration||await Gt(e),Vt(e)}(e=(t=e)&&t._delegate?t._delegate:t)}ie(new w("messaging",(e=>{const t=new Qt(e.getProvider("app").getImmediate(),e.getProvider("installations-internal").getImmediate(),e.getProvider("analytics-internal"));return navigator.serviceWorker.addEventListener("message",(e=>Xt(t,e))),t}),"PUBLIC")),ie(new w("messaging-internal",es,"PRIVATE")),le(Jt,Zt),le(Jt,Zt,"esm2017");var ss=o(6841);class is extends t().PureComponent{render(){return t().createElement("div",{className:"alert-container"},t().createElement("div",{className:"alert"},t().createElement("div",{className:"title"},this.props.title),t().createElement("div",{className:"content"},this.props.content),t().createElement("div",{className:"dialog-buttons"},this.props.onReject?t().createElement("button",{className:"outline",onClick:this.props.onReject},this.props.reject||t().createElement(i.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})):null,this.props.onConfirm?t().createElement("button",{className:"primary",onClick:this.props.onConfirm},this.props.confirm||t().createElement(i.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"})):null)))}}var as=o(2380);const ns=(0,i.defineMessages)({info:{id:"menu_item_info",defaultMessage:"Info",description:"Show extended topic information"},clear_messages:{id:"menu_item_clear_messages",defaultMessage:"Clear messages",description:"Delete all messages"},clear_for_all:{id:"menu_item_clear_messages_for_all",defaultMessage:"Clear for All",description:"Delete all message(s) for all members"},delete:{id:"menu_item_delete",defaultMessage:"Delete",description:"Delete selected messages"},delete_for_all:{id:"menu_item_delete_for_all",defaultMessage:"Delete for All",description:"Delete selected message(s) for all members"},send_retry:{id:"menu_item_send_retry",defaultMessage:"Retry",description:"Retry sending message"},mute:{id:"menu_item_mute",defaultMessage:"Mute",description:"Turn off notifications"},unmute:{id:"menu_item_unmute",defaultMessage:"Unmute",description:"Turn notifications on"},reply:{id:"menu_item_reply",defaultMessage:"Reply",description:"Reply to message"},forward:{id:"menu_item_forward",defaultMessage:"Forward",description:"Forward message"},edit:{id:"menu_item_edit",defaultMessage:"Edit",description:"Edit message"},topic_delete:{id:"menu_item_delete_topic",defaultMessage:"Delete",description:"Delete entire topic"},topic_delete_warning:{id:"topic_delete_warning",defaultMessage:"Are you sure you want to delete this conversation? It cannot be undone.",description:"Alert warning when deleting entire topic"},delete_messages_warning:{id:"delete_messages_warning",defaultMessage:"Are you sure you want to delete all messages for everyone? It cannot be undone.",description:"Alert dialog warning when hard-deleting all messages."},unblock:{id:"menu_item_unblock",defaultMessage:"Unblock",description:"Unblock topic or user"},block:{id:"menu_item_block",defaultMessage:"Block",description:"Block topic or user"},topic_block_warning:{id:"topic_block_warning",defaultMessage:"Are you sure you want to block this conversation?",description:"Alert warning when blocking a topic."},member_delete:{id:"menu_item_member_delete",defaultMessage:"Remove",description:"Remove user from topic"},archive:{id:"menu_item_archive_topic",defaultMessage:"Archive",description:"Move topic from the list of active chats to archive"},unarchive:{id:"menu_item_restore_topic",defaultMessage:"Restore",description:"Restore topic from archive"},edit_permissions:{id:"menu_item_edit_permissions",defaultMessage:"Edit permissions",description:"Menu item [Edit permissions]"},clear_messages_warning:{id:"clear_messages_warning",defaultMessage:"Are you sure you want to clear all messages? It cannot be undone.",description:"Alert dialog warning when deleting all messages."}});class os extends t().Component{constructor(e){super(e),this.selfRef=t().createRef();const{formatMessage:s}=e.intl;this.handlePageClick=this.handlePageClick.bind(this),this.handleEscapeKey=this.handleEscapeKey.bind(this),this.handleClick=this.handleClick.bind(this),this.MenuItems={topic_info:{id:"topic_info",title:s(ns.info),handler:null},messages_clear:{id:"messages_clear",title:s(ns.clear_messages),handler:(t,i)=>e.onShowAlert(s(ns.clear_messages),s(ns.clear_messages_warning),(e=>{this.deleteMessages(!0,!1,t,i)}),null,!0,null)},messages_clear_hard:{id:"messages_clear_hard",title:s(ns.clear_for_all),handler:(t,i)=>e.onShowAlert(s(ns.clear_for_all),s(ns.delete_messages_warning),(e=>this.deleteMessages(!0,!0,t,i)),null,!0,null)},message_delete:{id:"message_delete",title:s(ns.delete),handler:(e,t)=>this.deleteMessages(!1,!1,e,t)},message_delete_hard:{id:"message_delete_hard",title:s(ns.delete_for_all),handler:(e,t)=>this.deleteMessages(!1,!0,e,t)},menu_item_send_retry:{id:"menu_item_send_retry",title:s(ns.send_retry),handler:(e,t)=>this.retryMessage(e,t)},menu_item_reply:{id:"menu_item_reply",title:s(ns.reply),handler:(e,t)=>this.replyToMessage(e,t)},menu_item_forward:{id:"menu_item_forward",title:s(ns.forward),handler:e=>{}},menu_item_edit:{id:"menu_item_edit",title:s(ns.edit),handler:(e,t)=>this.editMessage(e,t)},topic_unmute:{id:"topic_unmute",title:s(ns.unmute),handler:this.topicPermissionSetter.bind(this,"+P")},topic_mute:{id:"topic_mute",title:s(ns.mute),handler:this.topicPermissionSetter.bind(this,"-P")},topic_unblock:{id:"topic_unblock",title:s(ns.unblock),handler:this.topicPermissionSetter.bind(this,"+JP")},topic_block:{id:"topic_block",title:s(ns.block),handler:(t,i)=>e.onShowAlert(s(ns.block),s(ns.topic_block_warning),(e=>this.topicPermissionSetter("-JP",t,i).then((e=>(this.props.onTopicRemoved(t.topicName),e)))),null,!0,null)},topic_delete:{id:"topic_delete",title:s(ns.topic_delete),handler:(t,i)=>e.onShowAlert(s(ns.topic_delete),s(ns.topic_delete_warning),(e=>{const s=this.props.tinode.getTopic(t.topicName);if(s)return s.delTopic(!0).catch((e=>{i&&i(e.message,"err")}));console.warn("Topic not found: ",t.topicName)}),null,!0,null)},topic_archive:{id:"topic_archive",title:s(ns.archive),handler:(e,t)=>{const s=this.props.tinode.getTopic(e.topicName);if(s)return s.archive(!0).catch((e=>{t&&t(e.message,"err")}));console.warn("Topic not found: ",e.topicName)}},topic_restore:{id:"topic_restore",title:s(ns.unarchive),handler:(e,t)=>{const s=this.props.tinode.getTopic(e.topicName);if(s)return s.archive(!1).catch((e=>{t&&t(e.message,"err")}));console.warn("Topic not found: ",e.topicName)}},permissions:{id:"permissions",title:s(ns.edit_permissions),handler:null},member_delete:{id:"member_delete",title:s(ns.member_delete),handler:(e,t)=>{const s=this.props.tinode.getTopic(e.topicName);if(s&&e.user)return s.delSubscription(e.user).catch((e=>{t&&t(e.message,"err")}));console.warn("Topic or user not found: '"+e.topicName+"', '"+e.user+"'")}},member_mute:{id:"member_mute",title:s(ns.mute),handler:this.topicPermissionSetter.bind(this,"-P")},member_unmute:{id:"member_unmute",title:s(ns.unmute),handler:this.topicPermissionSetter.bind(this,"+P")},member_block:{id:"member_block",title:s(ns.block),handler:this.topicPermissionSetter.bind(this,"-JP")},member_unblock:{id:"member_unblock",title:s(ns.unblock),handler:this.topicPermissionSetter.bind(this,"+JP")}}}componentDidMount(){document.addEventListener("mousedown",this.handlePageClick,!1),document.addEventListener("keyup",this.handleEscapeKey,!1)}componentWillUnmount(){document.removeEventListener("mousedown",this.handlePageClick,!1),document.removeEventListener("keyup",this.handleEscapeKey,!1)}handlePageClick(e){this.selfRef.current.contains(e.target)||(e.preventDefault(),e.stopPropagation(),this.props.hide())}handleEscapeKey(e){27===e.keyCode&&this.props.hide()}handleClick(e){e.preventDefault(),e.stopPropagation(),this.props.hide();let t=this.props.items[e.currentTarget.dataset.id];"string"==typeof t&&(t=this.MenuItems[t]),t?this.props.onAction(t.id,t.handler(this.props.params,this.props.onError),this.props.params):console.error("Invalid menu item ID",e.currentTarget.dataset.id)}deleteMessages(e,t,s,i){const a=this.props.tinode.getTopic(s.topicName);if(!a)return void console.warn("Topic not found: ",s.topicName);if(!e&&a.cancelSend(s.seq))return;return(e?a.delMessagesAll(t):s.replace>0?a.delMessagesEdits(s.replace,t):a.delMessagesList([s.seq],t)).catch((e=>{i&&i(e.message,"err")}))}retryMessage(e,t){const s=this.props.tinode.getTopic(e.topicName);if(!s||!s.flushMessage(e.seq))return;const i=s.createMessage(e.content,!1);return s.publishDraft(i).catch((e=>{t&&t(e.message,"err")}))}topicPermissionSetter(e,t,s){const i=this.props.tinode.getTopic(t.topicName);if(!i)return void console.warn("Topic not found",t.topicName);let a=i.updateMode(t.user,e);return s&&(a=a.catch((e=>s(e.message,"err")))),a}replyToMessage(e,t){e.pickReply(e.seq,e.content,e.userFrom,e.userName,t)}editMessage(e,t){e.editMessage(e.replace||e.seq,e.content,t)}render(){const e=[];let s=0;this.props.items.map((i=>{"string"==typeof i&&(i=this.MenuItems[i]),i&&i.title&&e.push("-"==i.title?t().createElement("li",{className:"separator",key:s}):t().createElement("li",{onClick:this.handleClick,"data-id":s,key:s},i.title)),s++}));const i=12*as._0,a=as._0*(.7+2.5*e.length),n={left:(this.props.bounds.right-this.props.clickAt.x<i?this.props.clickAt.x-this.props.bounds.left-i:this.props.clickAt.x-this.props.bounds.left)+"px",top:(this.props.bounds.bottom-this.props.clickAt.y<a?this.props.clickAt.y-this.props.bounds.top-a:this.props.clickAt.y-this.props.bounds.top)+"px"};return t().createElement("ul",{className:"menu",style:n,ref:this.selfRef},e)}}const rs=(0,i.injectIntl)(os),ls={muted:"notifications_off",banned:"block",staff:"verified_user"};class cs extends t().PureComponent{render(){let e=null;return this.props.badges&&this.props.badges.length>0?(e=[],this.props.badges.map((s=>{const i=s.color?" "+s.color:"";s.icon?e.push(t().createElement("i",{className:"material-icons as-badge"+i,key:s.key||s.icon},ls[s.icon]||s.icon)):e.push(t().createElement("span",{className:"badge"+i,key:s.key||s.name},s.name))})),t().createElement(t().Fragment,null,e)):null}}var ds=o(4092);class hs extends t().PureComponent{render(){return this.props.count>0?t().createElement("span",{className:"unread"},this.props.count>9?"9+":this.props.count):null}}var ps=o(9672),ms=o(7928);class us extends t().PureComponent{render(){const e=["busy","declined","disconnected","missed"].includes(this.props.callState),s="material-icons medium "+(e?"red":"green"),a=this.props.incoming?e?"call_missed":"call_received":e?"call_missed_outgoing":"call_made";let n;if(e)switch(this.props.callState){case"busy":n=t().createElement(i.FormattedMessage,{id:"call_busy",defaultMessage:"busy",description:"Label for busy call line"});break;case"declined":n=t().createElement(i.FormattedMessage,{id:"call_declined",defaultMessage:"declined",description:"Label for declined call"});break;case"missed":n=this.props.incoming?t().createElement(i.FormattedMessage,{id:"call_missed",defaultMessage:"missed",description:"Label for missed incoming call"}):t().createElement(i.FormattedMessage,{id:"call_cancelled",defaultMessage:"cancelled",description:"Label for cancelled outgoing call"});break;default:n=t().createElement(i.FormattedMessage,{id:"call_disconnected",defaultMessage:"disconnected",description:"Label for disconnected call"})}else n=t().createElement("span",null,(0,ms.sj)(this.props.duration/1e3));return t().createElement("div",{className:"call-message"},t().createElement("div",null,t().createElement("i",{className:"material-icons big gray"},"call")),t().createElement("div",{className:"flex-column narrow"},t().createElement("div",null,this.props.incoming?t().createElement(i.FormattedMessage,{id:"calls_incoming",defaultMessage:"Incoming call",description:"Incoming call label"}):t().createElement(i.FormattedMessage,{id:"calls_outgoing",defaultMessage:"Outgoing call",description:"Outgoing call label"})),t().createElement("div",{className:"duration"},t().createElement("i",{className:s},a)," ",n)))}}class gs extends t().PureComponent{render(){const e=["busy","declined","disconnected","missed"].includes(this.props.callState),s=this.props.incoming?e?"call_missed":"call_received":e?"call_missed_outgoing":"call_made";let a;if(e)switch(this.props.callState){case"busy":a=t().createElement(i.FormattedMessage,{id:"call_busy",defaultMessage:"busy",description:"Label for busy call line"});break;case"declined":a=t().createElement(i.FormattedMessage,{id:"call_declined",defaultMessage:"declined",description:"Label for declined call"});break;case"missed":a=this.props.incoming?t().createElement(i.FormattedMessage,{id:"call_missed",defaultMessage:"missed",description:"Label for missed incoming call"}):t().createElement(i.FormattedMessage,{id:"call_cancelled",defaultMessage:"cancelled",description:"Label for cancelled outgoing call"});break;default:a=t().createElement(i.FormattedMessage,{id:"call_disconnected",defaultMessage:"disconnected",description:"Label for disconnected call"})}else a=["accepted","started"].includes(this.props.callState)&&!this.props.duration?t().createElement(i.FormattedMessage,{id:"call_in_progress",defaultMessage:"in progress",description:"Label for call in progress"}):t().createElement("span",null,(0,ms.sj)(this.props.duration/1e3));return t().createElement(t().Fragment,null,t().createElement("div",{className:"composed-material"},t().createElement("i",{className:"material-icons"},"call"),t().createElement("i",{className:"material-icons second"},s))," ",a)}}class fs extends t().PureComponent{constructor(e){super(e),this.videoRef=t().createRef(),this.handleClick=this.handleClick.bind(this)}handleClick(e){this.props.onClick&&this.props.onClick(e)}render(){const e=(0,ms.sj)(this.props["data-duration"]/1e3),s="inline-video"+(this.props.onClick?" image-clickable":"");return t().createElement("div",{className:s},t().createElement("img",this.props),t().createElement("div",{className:"play-control"},this.props.onClick?t().createElement("i",{className:"material-icons white bigger"},"play_arrow"):t().createElement("img",{src:"img/broken_video.png",style:{filter:"invert(100%)"},width:"36",height:"36"})),e?t().createElement("div",{className:"duration"},e):null)}}class bs extends t().PureComponent{constructor(e){super(e),this.state={src:this.props.isvideo?"img/blankvid.png":"img/blankimg.png",style:Object.assign({padding:"4px"},this.props.style),className:this.props.className,alt:this.props.alt,onClick:this.props.onClick}}componentDidMount(){this.props.whenDone.promise.then((e=>this.setState({src:e.src,style:{...this.state.style,padding:0}}))).catch((e=>this.setState({src:this.props.isvideo?"img/broken_video.png":"img/broken_image.png"})))}componentWillUnmount(){this.props.whenDone.cancel()}componentDidUpdate(e){e.whenDone!=this.props.whenDone&&(this.setState({src:this.props.isvideo?"img/blankvid.png":"img/blankimg.png",style:{...this.state.style,padding:"4px"}}),this.props.whenDone.promise.then((e=>this.setState({src:e.src,style:{...this.state.style,padding:0}}))).catch((e=>this.setState({src:this.props.isvideo?"img/broken_video.png":"img/broken_image.png"}))))}render(){return t().createElement("img",this.state)}}class vs extends t().PureComponent{render(){return t().createElement("div",{className:"uploader"},t().createElement("div",null,t().createElement("span",{style:{width:100*this.props.progress+"%"}})),this.props.progress<.999?t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onCancel()}},t().createElement("i",{className:"material-icons"},"close")," ",t().createElement(i.FormattedMessage,{id:"action_cancel",defaultMessage:"cancel",description:"Call to action [cancel]"})):t().createElement(i.FormattedMessage,{id:"upload_finishing",defaultMessage:"finishing...",description:"Notification that upload is finishing"}))}}class ws extends t().PureComponent{constructor(e){super(e)}render(){return t().createElement("div",{className:"inline-image"},t().createElement("img",this.props),t().createElement("div",{className:"rounded-container"},t().createElement(vs,{progress:this.props.progress,onCancel:this.props.onCancelUpload})))}}var Es=o(3092),Cs=o(2796);const Ss=(0,i.defineMessages)({drafty_form:{id:"drafty_form",defaultMessage:"Form: ",description:"Comment for form in Drafty"},drafty_attachment:{id:"drafty_attachment",defaultMessage:"Attachment",description:"Comment for attachment in Drafty"},drafty_image:{id:"drafty_image",defaultMessage:"Picture",description:"Comment for embedded images in Drafty"},drafty_video:{id:"drafty_video",defaultMessage:"Video recording",description:"Comment for videos embedded in Drafty"},drafty_unknown:{id:"drafty_unknown",defaultMessage:"Unsupported",description:"Unsupported entity in drafty"}});function ys(e,s,i,a,n){if(n.includes("QQ"))return Ds.call(this,e,s,i,a);if(!e)return i;let o=ss.Drafty.tagName(e),r=ss.Drafty.attrValue(e,s)||{};switch(r.key=a,e){case"AU":r.src&&(r.src=this.authorizeURL((0,Cs.mM)(r.src,"audio")),r.duration=s.duration>0?0|s.duration:void 0,r.preview=s.preview,r.loading="lazy"),o=ps.c,i=null;break;case"BR":i=null;break;case"EX":case"RW":break;case"HL":r.className="highlight";break;case"HD":o=null,i=null;break;case"IM":o=Ms.call(this,o,s,r),i=null;break;case"BN":r.onClick=this.onFormButtonClick;let e=t().Children.map(i,(e=>"string"==typeof e?e:void 0));e&&0!=e.length||(e=[r.name]),r["data-title"]=e.join("");break;case"LN":r&&(r.href="string"==typeof r.href?(0,Cs.oR)(r.href,as.yQ):"");break;case"MN":r.className="mention",s&&(r.className+=" "+(0,ms.YZ)(s.val,!1,!0));break;case"FM":r.className="bot-form";break;case"QQ":r.className="reply-quote",r.onClick=this.onQuoteClick;break;case"VC":o=us,i=null,s&&(r.callState=s.state,r.incoming=s.incoming,r.duration=s.duration);break;case"VD":o=_s.call(this,o,s,r),i=null;break;default:if(!o){o=t().Fragment,r={key:a};let e=i;Array.isArray(i)&&i.join("").trim()||(e=[t().createElement("span",{key:"x1",className:"gray"},this.formatMessage(Ss.drafty_unknown))]),i=[t().createElement("i",{key:"x0",className:"material-icons gray"},"extension")," "].concat(e)}}return o?t().createElement(o,r,i):i}function Ms(e,t,s){if(!t)return s.src="img/broken_image.png",s.style={width:as.A1+"px",height:as.A1+"px"},e;s.className="inline-image";const i=(0,Es.yg)(t.width,t.height,this.viewportWidth>0?Math.min(this.viewportWidth-6.5*as._0,34.5*as._0):34.5*as._0,24*as._0,!1)||{dstWidth:as.I1,dstHeight:as.I1};return s.style={width:i.dstWidth+"px",height:i.dstHeight+"px",minWidth:i.dstWidth+"px",minHeight:i.dstHeight+"px"},ss.Drafty.isProcessing(t)?e=ws:(s.src=this.authorizeURL((0,Cs.mM)(s.src,"image")),s.alt=t.name,s.src?(Math.max(t.width||0,t.height||0)>as.A1&&(s.onClick=this.onImagePreview,s.className+=" image-clickable"),s.loading="lazy"):s.src=null),e}function _s(e,t,s){if(!t)return s.src="img/broken_video.png",s.style={width:as.A1+"px",height:as.A1+"px"},e;s.className="inline-image";const i=(0,Es.yg)(t.width,t.height,this.viewportWidth>0?Math.min(this.viewportWidth-6.5*as._0,34.5*as._0):34.5*as._0,24*as._0,!1)||{dstWidth:as.Km,dstHeight:as.Km};return s.style={width:i.dstWidth+"px",height:i.dstHeight+"px",minWidth:i.dstWidth+"px",minHeight:i.dstHeight+"px"},ss.Drafty.isProcessing(t)?e=ws:(s.src=this.authorizeURL((0,Cs.mM)(s.src,"image")),s.alt=t.name,(t.ref||t.val)&&(s.onClick=this.onVideoPreview,s.loading="lazy"),e=fs),e}function Ts(e,s,i,a){if(!e)return i;let n=ss.Drafty.tagName(e);const o={key:a};switch(e){case"AU":n=t().Fragment,i=[t().createElement("i",{key:"au",className:"material-icons"},"mic")," ",(0,ms.sj)(s.duration/1e3)];break;case"BR":n=t().Fragment,i=[" "];break;case"HL":o.className="highlight preview";break;case"LN":case"MN":n="span";break;case"IM":n=t().Fragment,i=[t().createElement("i",{key:"im",className:"material-icons"},"photo")," ",this.formatMessage(Ss.drafty_image)];break;case"BN":n="span",o.className="flat-button faux";break;case"FM":n=t().Fragment,i=[t().createElement("i",{key:"fm",className:"material-icons"},"dashboard"),this.formatMessage(Ss.drafty_form)].concat(" ",i||[]);break;case"RW":n=t().Fragment;break;case"EX":if(s){if("application/json"==s.mime)return null;delete s.val,delete s.ref}n=t().Fragment,i=[t().createElement("i",{key:"ex",className:"material-icons"},"attachment")," ",this.formatMessage(Ss.drafty_attachment)];break;case"VC":n=gs,s&&(o.callState=s.state,o.incoming=s.incoming,o.duration=s.duration),i=null;break;case"QQ":case"HD":n=null,i=null;break;case"VD":n=t().Fragment,i=[t().createElement("i",{key:"im",className:"material-icons"},"play_circle_outline")," ",this.formatMessage(Ss.drafty_video)];break;default:n||(n=t().Fragment,i=[t().createElement("i",{key:"x0",className:"material-icons gray"},"extension")," ",this.formatMessage(Ss.drafty_unknown)])}return n?t().createElement(n,o,i):i}function ks(e,t){return e.style={width:as.A1+"px",height:as.A1+"px",maxWidth:as.A1+"px",maxHeight:as.A1+"px"},e.className="inline-image",e.alt=this.formatMessage(Ss.drafty_image),e.src=t&&e.src||"img/broken_image.png",e.title=e.alt,e}function As(e,t){const s=(0,Es.yg)(t.width,t.height,as.uW,as.A1);return e.style={width:s.width+"px",height:s.height+"px",maxWidth:as.uW+"px",maxHeight:as.A1+"px"},e.className="inline-image",e.alt=this.formatMessage(Ss.drafty_video),e.title=e.alt,e.src=t&&e.src||"img/broken_video.png",e}function Ds(e,s,i,a){if(["BR","EX","IM","MN","VD"].includes(e)){let n=ss.Drafty.tagName(e),o=ss.Drafty.attrValue(e,s)||{};switch(o.key=a,e){case"BR":i=null;break;case"IM":o=ks.call(this,o,s),i=[t().createElement("img",o,null)," ",o.alt],n=t().Fragment,o={key:a};break;case"VD":o=As.call(this,o,s),i=[t().createElement("img",o,null)," ",o.alt],n=t().Fragment,o={key:a};break;case"MN":n="span",o.className="mention",s&&(o.className+=" "+(0,ms.YZ)(s.val,!1,!0));break;case"EX":let e;if(s){if("application/json"==s.mime)return null;e=s.name,delete s.val,delete s.ref}n=t().Fragment,i=[t().createElement("i",{key:"ex",className:"material-icons"},"attachment"),(0,ms.is)(e,16)||this.formatMessage(Ss.drafty_attachment)]}return t().createElement(n,o,i)}return Ts.call(this,e,s,i,a)}function Ns(e,t){let s,i,a,n;if(t?(i=e.preview,n=e.premime||"image/jpeg",a=e.preref):(i=e.val,n=e.mime,a=e.ref),i){const e=(0,Es.YJ)(i,n);if(!e)throw new Error("Invalid image");s=Promise.resolve(e)}else{if(!a)throw new Error("Missing image data");s=fetch(this.authorizeURL((0,Cs.mM)(a,"image"))).then((e=>{if(e.ok)return e.blob();throw new Error(`Image fetch unsuccessful: ${e.status} ${e.statusText}`)}))}return s.then((e=>(0,Es._k)(e,t?as.uW:as.A1,as.A1,-1,!t))).then((s=>(t?e.premime=s.mime:e.mime=s.mime,e.size=s.blob.size,e.width=s.width,e.height=s.height,delete e.ref,delete e.preref,e.src=URL.createObjectURL(s.blob),(0,Es._K)(s.blob)))).then((s=>(t?e.preview=s.bits:e.val=s.bits,e))).catch((t=>{throw delete e.val,delete e.preview,delete e.src,e.width=as.A1,e.height=as.A1,t}))}function Is(e,s,i,a,n){if("IM"==e||"VD"==e){const n="IM"==e?ks.call(this,{key:a},s):As.call(this,{key:a},s);let o;try{o=(0,Cs.oH)(Ns.call(this,s,"VD"==e))}catch(e){console.warn("Failed to quote image:",e.message),o=(0,Cs.oH)(e)}return n.whenDone=o,i=[t().createElement(bs,n,null)," ",n.alt],t().createElement(t().Fragment,{key:a},i)}if("QQ"==e){if(n.includes("QQ"))return t().createElement("span",{key:a},[t().createElement("i",{key:"qq",className:"material-icons"},"format_quote")," "]);const e=ss.Drafty.attrValue("QQ",s)||{};return e.key=a,e.className="reply-quote",t().createElement(ss.Drafty.tagName("QQ"),e,i)}return Ds.call(this,e,s,i,a)}class Ps extends t().Component{constructor(e){super(e),this.handleClick=this.handleClick.bind(this),this.handleContextClick=this.handleContextClick.bind(this)}handleClick(e){e.preventDefault(),e.stopPropagation(),this.props.onSelected&&this.props.onSelected(this.props.item,this.props.index)}handleContextClick(e){e.preventDefault(),e.stopPropagation(),this.props.showContextMenu({topicName:this.props.item,y:e.pageY,x:e.pageX})}render(){let e=this.props.title;e?e.length>30&&(e=e.substring(0,28)+"…"):e=t().createElement("i",null,t().createElement(i.FormattedMessage,{id:"unnamed_topic",defaultMessage:"Unnamed",description:"Title shown when the topic has no name"}));const s=this.props.now?"online":"offline",a=!this.props.avatar||this.props.avatar,n=this.props.badges?this.props.badges.slice():[],o=[];let r;this.props.isVerified&&o.push({icon:"verified",color:"verified-color"}),this.props.isStaff&&o.push({icon:"staff",color:"staff-color"}),this.props.isDangerous&&o.push({icon:"dangerous",color:"danger-color"}),this.props.acs&&(this.props.showMode&&n.push({name:this.props.acs.getMode(),key:"mode"}),this.props.acs.isMuted()&&o.push({icon:"muted"}),this.props.acs.isJoiner()||o.push({icon:"banned"})),"string"==typeof this.props.preview?r=this.props.preview:ss.Drafty.isValid(this.props.preview)?r=t().createElement(t().Fragment,null,ss.Drafty.format(this.props.preview,Ts,{formatMessage:this.props.intl.formatMessage,previewIsResponse:this.props.previewIsResponse})):this.props.preview&&(r=t().createElement(t().Fragment,null,t().createElement("i",{className:"material-icons gray"},"warning_amber")," ",t().createElement("i",{className:"gray"},t().createElement(i.FormattedMessage,{id:"invalid_content",defaultMessage:"invalid content",description:"Shown when the message is unreadable"}))));const l=(0,Cs.Ut)(this.props.received),c=l?t().createElement("i",{className:"material-icons small space-right"+(l.color?" "+l.color:"")},l.name):null,d="contact-title"+(this.props.deleted?" deleted":"");return t().createElement("li",{className:!this.props.showCheckmark&&this.props.selected?"selected":null,onClick:this.handleClick},t().createElement("div",{className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:a,title:this.props.title,topic:this.props.item,deleted:this.props.deleted}),this.props.deleted?t().createElement("i",{className:"deleted material-icons"},"cancel"):this.props.showOnline?t().createElement("span",{className:s}):this.props.showCheckmark&&this.props.selected?t().createElement("i",{className:"checkmark material-icons"},"check_circle"):null),t().createElement("div",{className:"text-box"},t().createElement("div",null,t().createElement("span",{className:d},e),this.props.isGroup?t().createElement("i",{className:"material-icons as-badge"},"group"):null,this.props.isChannel?t().createElement("img",{src:"/img/channel.png",className:"channel",alt:"channel"}):null,t().createElement(cs,{badges:o}),this.props.deleted?null:t().createElement(hs,{count:this.props.unread})),this.props.showMode?t().createElement("span",null,t().createElement(cs,{badges:n})):this.props.small?null:t().createElement("div",{className:"contact-comment"},c,t().createElement("span",null,r||this.props.comment||" "))),this.props.showContextMenu?t().createElement("span",{className:"menuTrigger"},t().createElement("a",{href:"#",onClick:this.handleContextClick},t().createElement("i",{className:"material-icons"},"expand_more"))):null)}}const Rs=(0,i.injectIntl)(Ps);class xs extends t().PureComponent{constructor(e){super(e),this.handleClick=this.handleClick.bind(this)}handleClick(e){e.preventDefault(),e.stopPropagation(),this.props.onAction(this.props.action)}render(){const{formatMessage:e}=this.props.intl;return t().createElement("li",{onClick:this.handleClick,className:"action"},t().createElement("div",{className:"action-text"},e(this.props.title,this.props.values)))}}const Fs=(0,i.injectIntl)(xs),Us=(0,i.defineMessages)({badge_you:{id:"badge_you",defaultMessage:"you",description:"Badge for indicating the current user"},badge_owner:{id:"badge_owner",defaultMessage:"owner",description:"Badge for indicating the owner"}});class Ls extends t().Component{render(){const{formatMessage:e}=this.props.intl,s=Array.isArray(this.props.topicSelected),i=[];let a=0;return this.props.contacts&&this.props.contacts.length>0&&this.props.contacts.map((n=>{if(n.action)i.push(t().createElement(Fs,{title:n.title,action:n.action,values:n.values,key:n.action,onAction:this.props.onAction}));else{const o=this.props.showMode?n.user:n.topic||n.user;if(this.props.filterFunc&&this.props.filter){const e=[o];if(n.private&&n.private.comment&&e.push((""+n.private.comment).toLowerCase()),n.public&&n.public.fn&&e.push((""+n.public.fn).toLowerCase()),!this.props.filterFunc(this.props.filter,e))return}const r=ss.Tinode.isChannelTopicName(o),l=!r&&ss.Tinode.isGroupTopicName(o),c=s?this.props.topicSelected.indexOf(o)>-1:this.props.topicSelected===o,d=[];this.props.showMode&&(o==this.props.myUserId&&d.push({name:e(Us.badge_you),color:"green"}),n.acs&&n.acs.isOwner()&&d.push({name:e(Us.badge_owner),color:"blue"}));const h=Array.isArray(n.private)?n.private.join(","):n.private?n.private.comment:null;let p,m,u,g;if(!this.props.showMode&&n.latestMessage){const e=n.latestMessage();e&&(m=e.head?e.head.forwarded:null,g=e._status||n.msgStatus(e,!0),u=e.from!=this.props.myUserId,e.content&&(p="string"==typeof e.content?e.content.substr(0,as.s3):ss.Drafty.preview(e.content,as.s3)))}i.push(t().createElement(Rs,{tinode:this.props.tinode,title:n.public?n.public.fn:null,avatar:(0,Es.Qn)(n.public?n.public.photo:null),comment:h,preview:p,previewIsResponse:u,forwarded:m,received:g,unread:this.props.showUnread?n.unread:0,now:n.online&&this.props.connected,acs:n.acs,showMode:this.props.showMode,badges:d,showCheckmark:s,selected:c,showOnline:this.props.showOnline&&!r,isChannel:r,isGroup:l,showContextMenu:this.props.showContextMenu,isVerified:n.trusted&&n.trusted.verified,isStaff:n.trusted&&n.trusted.staff,isDangerous:n.trusted&&n.trusted.danger,deleted:n._deleted,onSelected:this.props.onTopicSelected,item:o,index:i.length,key:o})),a++}}),this),t().createElement("div",{className:this.props.noScroll?null:"scrollable-panel"},0==a?t().createElement("div",{className:"center-medium-text",dangerouslySetInnerHTML:{__html:this.props.emptyListMessage}}):null,i.length>0?t().createElement("ul",{className:"contact-box"},i):null)}}const Os=(0,i.injectIntl)(Ls);class Bs extends t().PureComponent{constructor(e){super(e),this.state={edited:!1,search:""},this.handleSearchChange=this.handleSearchChange.bind(this),this.handleSearch=this.handleSearch.bind(this),this.handleClear=this.handleClear.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentWillUnmount(){this.state.edited&&(this.setState({search:"",edited:!1}),this.props.onSearchContacts(ss.Tinode.DEL_CHAR))}handleSearchChange(e){this.setState({search:e.target.value})}handleSearch(e){e.preventDefault();const t=this.state.search.trim();this.setState({edited:t.length>0}),this.props.onSearchContacts(t.length>0?t:ss.Tinode.DEL_CHAR)}handleClear(e){e.preventDefault(),this.state.edited&&this.props.onSearchContacts(ss.Tinode.DEL_CHAR),this.setState({search:"",edited:!1})}handleKeyDown(e){"Enter"===e.key?this.handleSearch(e):"Escape"===e.key&&this.handleClear()}render(){return t().createElement("div",{className:"panel-form"},t().createElement("div",{className:"panel-form-row"},t().createElement("i",{className:"material-icons search"},"search"),t().createElement("input",{className:"search",type:"text",placeholder:this.props.placeholder,value:this.state.search,onChange:this.handleSearchChange,onKeyDown:this.handleKeyDown,required:!0,autoFocus:!0}),this.state.search?t().createElement("a",{href:"#",onClick:this.handleClear},t().createElement("i",{className:"material-icons"},"highlight_off")):t().createElement("span",null,t().createElement("i",{className:"material-icons"}," "))))}}class qs extends t().Component{constructor(e){super(e),this.state={query:null},this.handleEscapeKey=this.handleEscapeKey.bind(this),this.handleClose=this.handleClose.bind(this),this.handleSearchContacts=this.handleSearchContacts.bind(this),this.handleContactSelected=this.handleContactSelected.bind(this)}componentDidMount(){this.props.onInitFind()}handleEscapeKey(e){27===e.keyCode&&this.props.hide(!1)}handleClose(e){e.preventDefault(),this.props.hide(!1)}handleSearchContacts(e){this.setState({query:ss.Tinode.isNullValue(e)?null:e}),this.props.onSearchContacts(e)}handleContactSelected(e){this.props.onTopicSelected(e),this.props.hide(!0)}render(){let e=null!=this.state.query?this.props.searchResults:this.props.contacts;return e=e.filter((e=>e.name!=this.props.topicSelected&&e.acs.isJoiner()&&e.acs.isWriter())),t().createElement("div",{className:"alert-container"},t().createElement("div",{className:"forward-dialog"},t().createElement("div",{className:"title with-control"},t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"forward_to",defaultMessage:"Forward to",desription:"Title of the contact selector dialog when forwarding a message"})),t().createElement("div",null,t().createElement("a",{href:"#",onClick:this.handleClose},t().createElement("i",{className:"material-icons"},"close")))),t().createElement(i.FormattedMessage,{id:"forward_to_search_placeholder",defaultMessage:"Search contacts",description:"Contact search prompt when forwarding a message."},(e=>t().createElement(Bs,{placeholder:e,onSearchContacts:this.handleSearchContacts}))),t().createElement(i.FormattedMessage,{id:"search_no_results",defaultMessage:"Search returned no results",description:"Text shown in contacts view when query returned no results."},(s=>t().createElement(Os,{tinode:this.props.tinode,contacts:e,myUserId:this.props.myUserId,emptyListMessage:s,showOnline:!1,showUnread:!1,showContextMenu:!1,onTopicSelected:this.handleContactSelected})))))}}var js=o(7296);const Vs="started",Hs=new Audio("audio/call-in.m4a");class Ws extends t().Component{constructor(e){super(e),this.state={topic:null,fullName:void 0,avatar:null,trustedBadges:[],previousMetaDesc:void 0},this.resetDesc=this.resetDesc.bind(this),this.onMetaDesc=this.onMetaDesc.bind(this),this.handleRejectCall=this.handleRejectCall.bind(this),this.handleAcceptCall=this.handleAcceptCall.bind(this),this.ringTimer=null}componentDidMount(){const e=this.props.tinode.getTopic(this.props.topic);e&&(this.resetDesc(e),2==this.props.callState&&(Hs.play().catch((e=>{})),this.ringTimer=setInterval((e=>{Hs.play().catch((e=>{}))}),2e3),this.props.onRinging(this.props.topic,this.props.seq)))}componentDidUpdate(e){const t=this.props.tinode.getTopic(e.topic);t&&(this.onMetaDesc!=t.onMetaDesc&&(this.previousMetaDesc=t.onMetaDesc,t.onMetaDesc=this.onMetaDesc),this.state.topic!=e.topic&&(this.setState({topic:e.topic}),this.resetDesc(t,e)))}componentWillUnmount(){null!=this.ringTimer&&(clearInterval(this.ringTimer),Hs.pause());const e=this.props.tinode.getTopic(this.props.topic);e&&(this.setState({topic:null}),e.onMetaDesc=this.previousMetaDesc)}resetDesc(e){const t=[];if(e.trusted)for(const[s,i]of Object.entries(e.trusted))i&&t.push(s);this.setState({fullName:(0,Cs.KF)(e.public?e.public.fn:void 0,as.Yb),avatar:(0,Es.Qn)(e.public?e.public.photo:null),trustedBadges:t})}onMetaDesc(e){const t=this.props.tinode.getTopic(this.props.topic);t&&(this.resetDesc(t),this.previousMetaDesc&&this.previousMetaDesc!=this.onMetaDesc&&this.previousMetaDesc(e))}handleAcceptCall(){this.props.onAcceptCall(this.props.topic)}handleRejectCall(){this.props.onReject(this.props.topic,this.props.seq),this.props.onClose()}render(){return t().createElement("div",{className:"alert-container"},t().createElement("div",{className:"incoming-call"},t().createElement("div",{className:"caller-card incoming pulse"},t().createElement("div",{className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:this.state.avatar||!0,topic:this.props.topic,title:this.state.fullName})),t().createElement("div",{className:"caller-name"},(0,Cs.KF)(this.state.fullName,as.q),t().createElement(js.c,{short:!0,trustedBadges:this.state.trustedBadges}))),t().createElement("div",{className:"controls"},2==this.props.callState?t().createElement(t().Fragment,null,t().createElement("button",{className:"danger",onClick:this.handleRejectCall},t().createElement("i",{className:"material-icons"},"call_end")),t().createElement("button",{className:"positive",onClick:this.handleAcceptCall},t().createElement("i",{className:"material-icons"},"call"))):null)))}}var zs=o(5431),Ks=o(3976);class Qs extends t().PureComponent{render(){return t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onCancel()}},t().createElement("i",{className:"material-icons"},"close"))}}class Gs extends t().PureComponent{constructor(e){super(e),this.state={show:!1},this.hide=this.hide.bind(this)}componentDidUpdate(e){e.level!==this.props.level&&this.setState({show:!!this.props.level})}hide(){this.setState({show:!1}),this.props.onClearError&&this.props.onClearError()}render(){const e={err:"error",warn:"warning",info:"info"}[this.props.level]||"",s="info-box "+e;return t().createElement("div",{className:s+" "+this.props.class},t().createElement("div",{style:{display:"flex",alignItems:"center"}},t().createElement("div",{className:"icon"},t().createElement("i",{className:"material-icons"},e)),t().createElement("span",null,this.props.text,this.props.action?t().createElement(t().Fragment,null,"  ",t().createElement("a",{href:"#",style:{whiteSpace:"nowrap"},onClick:e=>{e.preventDefault(),this.props.action()}},this.props.actionText)):null)),t().createElement("div",{className:"cancel"},t().createElement(Qs,{onCancel:this.hide})))}}class $s extends t().PureComponent{constructor(e){super(e),this.handleCancel=this.handleCancel.bind(this)}handleCancel(e){e.preventDefault(),this.props.onCancel(this.props.topic,this.props.index)}render(){const e=this.props.title||this.props.topic,s=this.props.invalid?"chip invalid":"chip";return t().createElement("div",{className:s},this.props.noAvatar?t().createElement("span",{className:"spacer"}):t().createElement("div",{className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:this.props.avatar||!0,topic:this.props.topic,title:this.props.title})),t().createElement("span",null,e),this.props.onCancel&&!this.props.required?t().createElement("a",{href:"#",onClick:this.handleCancel},"×"):t().createElement("span",{className:"spacer"}))}}class Ys extends t().Component{constructor(e){super(e),this.state=Ys.deriveStateFromProps(e),this.state.input="",this.state.focused=!1,this.handleTextInput=this.handleTextInput.bind(this),this.removeChipAt=this.removeChipAt.bind(this),this.handleChipCancel=this.handleChipCancel.bind(this),this.handleFocusGained=this.handleFocusGained.bind(this),this.handleFocusLost=this.handleFocusLost.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}static deriveStateFromProps(e){return{placeholder:e.chips?"":e.prompt,sortedChips:Ys.sortChips(e.chips,e.staticMembers),chipIndex:Ys.indexChips(e.chips)}}componentDidUpdate(e,t){e.chips==this.props.chips&&e.staticMembers==this.props.staticMembers&&e.prompt==this.props.prompt||this.setState(Ys.deriveStateFromProps(this.props)),(!t||this.props.chips.length>t.sortedChips.length)&&this.setState({input:""})}static indexChips(e){const t={};let s=0;return e.map((e=>{t[e.user]=s,s++})),t}static sortChips(e,t){const s=[],i=[];return e.map((e=>{t&&t.includes(e.user)?s.push(e):i.push(e)})),s.concat(i)}handleTextInput(e){this.setState({input:e.target.value}),this.props.filterFunc&&this.props.filterFunc(e.target.value)}removeChipAt(e){const t=this.state.sortedChips[e];this.props.onChipRemoved(t.user,this.state.chipIndex[t.user])}handleChipCancel(e,t){this.removeChipAt(t)}handleFocusGained(){this.setState({focused:!0})}handleFocusLost(){this.setState({focused:!1}),this.props.onFocusLost&&this.props.onFocusLost(this.state.input)}handleKeyDown(e){if("Backspace"===e.key){if(0==this.state.input.length&&this.state.sortedChips.length>0){const e=this.state.sortedChips.length-1;this.state.sortedChips[e].user!==this.props.staticMembers&&this.removeChipAt(e)}}else"Enter"===e.key?this.props.onEnter&&this.props.onEnter(this.state.input):"Escape"===e.key&&this.props.onCancel&&this.props.onCancel()}render(){const e=[];let s=0;const i=this.props.staticMembers||[];this.state.sortedChips.map((a=>{e.push(t().createElement($s,{tinode:this.props.tinode,onCancel:this.handleChipCancel,avatar:(0,Es.Qn)(a.public?a.public.photo:null),title:a.public?a.public.fn:void 0,noAvatar:this.props.avatarDisabled,topic:a.user,required:i.includes(a.user),invalid:a.invalid,index:s,key:a.user})),s++}));const a="chip-input"+(this.state.focused?" focused":""),n=!(this.props.tabIndex>0);return t().createElement("div",{className:a},e,t().createElement("input",{type:"text",placeholder:this.state.placeholder,onChange:this.handleTextInput,onFocus:this.handleFocusGained,onBlur:this.handleFocusLost,onKeyDown:this.handleKeyDown,value:this.state.input,tabIndex:this.props.tabIndex,autoFocus:n}))}}const Xs=(0,i.defineMessages)({no_contacts:{id:"no_contacts",defaultMessage:"You have no contacts :-(",description:"Shown in ContactsView when the user has no contacts"},contacts_not_found_short:{id:"contacts_not_found_short",defaultMessage:"No contacts match ''{query}''",description:"Shown in ContactsView when search returned no results"}});class Js extends t().Component{constructor(e){super(e),this.state={members:e.members,index:Js.indexMembers(e.members),staticMembers:Js.staticMembers(e.members,e.keepInitialMembers,e.requiredMember),contactFilter:"",noContactsMessage:e.intl.formatMessage(Xs.no_contacts),selectedContacts:Js.selectedContacts(e.members)},this.handleContactSelected=this.handleContactSelected.bind(this),this.handleMemberRemoved=this.handleMemberRemoved.bind(this),this.handleContactFilter=this.handleContactFilter.bind(this),this.handleSubmit=this.handleSubmit.bind(this),this.handleCancel=this.handleCancel.bind(this)}static indexMembers(e){let t={};return e.map((e=>{t[e.user]={delta:0,present:!0}})),t}static staticMembers(e,t,s){let i=[];return e.map((e=>{(t||e.user==s)&&i.push(e.user)})),i}static selectedContacts(e){let t=[];return e.map((e=>{t.push(e.user)})),t}handleContactSelected(e,t){let s=this.state.index[e];if(s){if(s.present)return;s.delta+=1,s.present=!0}else s={delta:1,present:!0};let i=this.state.members.slice();i.push(this.props.contacts[t]);const a=Js.selectedContacts(i),n=this.state.index;n[e]=s,this.setState({members:i,index:n,selectedContacts:a})}handleMemberRemoved(e,t){const s=this.state.index[e];if(!s||!s.present)return;s.present=!1,s.delta-=1;let i=this.state.members.slice();i.splice(t,1);const a=Js.selectedContacts(i),n=this.state.index;n[e]=s,this.setState({members:i,index:n,selectedContacts:a})}handleContactFilter(e){const{formatMessage:t}=this.props.intl,s=e?t(Xs.contacts_not_found_short,{query:e}):t(Xs.no_contacts);this.setState({contactFilter:e,noContactsMessage:s})}static doContactFiltering(e,t){if(e){for(let s=0;s<t.length;s++)if(t[s].indexOf(e)>=0)return!0;return!1}return!0}handleSubmit(){var e=this,t=[],s=[],i=[];Object.keys(this.state.index).map((function(a){e.state.index[a].present&&t.push(a),e.state.index[a].delta>0?s.push(a):e.state.index[a].delta<0&&i.push(a)})),this.props.onSubmit(t,s,i)}handleCancel(){this.props.onCancel()}render(){const{formatMessage:e}=this.props.intl;return t().createElement("div",{id:"group-manager"},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"title_group_members",defaultMessage:"Group Members",description:"Section title"}))),t().createElement("div",{className:"panel-form-row"},t().createElement(Ys,{tinode:this.props.tinode,chips:this.state.members,staticMembers:this.state.staticMembers,prompt:"add members",filterFunc:this.handleContactFilter,onChipRemoved:this.handleMemberRemoved})),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"title_all_contacts",defaultMessage:"All Contacts",description:"Section title [All Contacts]"}))),t().createElement(Os,{tinode:this.props.tinode,contacts:this.props.contacts,myUserId:this.props.myUserId,topicSelected:this.state.selectedContacts,filter:this.state.contactFilter,filterFunc:Js.doContactFiltering,emptyListMessage:this.state.noContactsMessage,showOnline:!1,showUnread:!1,onTopicSelected:this.handleContactSelected}),t().createElement("div",{id:"group-manager-buttons",className:"panel-form-row"},t().createElement("button",{className:"secondary",onClick:this.handleCancel},t().createElement(i.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})),t().createElement("button",{className:"primary",onClick:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"}))))}}const Zs=(0,i.injectIntl)(Js),ei=(0,i.defineMessages)({joiner:{id:"permission_join",defaultMessage:"Join ({val})",description:"Name of J permission"},reader:{id:"permission_read",defaultMessage:"Read ({val})",description:"Name of R permission"},writer:{id:"permission_write",defaultMessage:"Write ({val})",description:"Name of W permission"},preser:{id:"permission_pres",defaultMessage:"Get notified ({val})",description:"Name of P permission"},approver:{id:"permission_admin",defaultMessage:"Approve ({val})",description:"Name of A permission"},sharer:{id:"permission_share",defaultMessage:"Share ({val})",description:"Name of S permission"},deleter:{id:"permission_delete",defaultMessage:"Delete ({val})",description:"Name of D permission"},owner:{id:"permission_owner",defaultMessage:"Owner ({val})",description:"Name of O permission"}});class ti extends t().Component{constructor(e){super(e),this.state={mode:(e.mode||"").replace("N","")},this.handleChange=this.handleChange.bind(this),this.handleSubmit=this.handleSubmit.bind(this),this.handleCancel=this.handleCancel.bind(this)}handleChange(e){let t=this.state.mode;-1==t.indexOf(e)?t+=e:t=t.replace(e,""),this.setState({mode:t})}handleSubmit(){const e=(this.state.mode||"N").split("").sort().join("");e!==(this.props.mode||"N").split("").sort().join("")?this.props.onSubmit(e):this.props.onCancel()}handleCancel(){this.props.onCancel()}render(){const{formatMessage:e}=this.props.intl,s="JRWPASDO",a={J:e(ei.joiner,{val:"J"}),R:e(ei.reader,{val:"R"}),W:e(ei.writer,{val:"W"}),P:e(ei.preser,{val:"P"}),A:e(ei.approver,{val:"A"}),S:e(ei.sharer,{val:"S"}),D:e(ei.deleter,{val:"D"}),O:e(ei.owner,{val:"O"})};let n=this.props.skip||"",o=this.state.mode,r=(this.props.compare||"").replace("N",""),l=[];for(let e=0;e<8;e++){let i=s.charAt(e);n.indexOf(i)>=0&&o.indexOf(i)<0||l.push(t().createElement("tr",{key:i},t().createElement("td",null,a[i]),t().createElement("td",{className:"checkbox"},n.indexOf(i)<0?t().createElement(Ks.c,{name:i,checked:o.indexOf(i)>=0,onChange:this.handleChange}):t().createElement(Ks.c,{name:i,checked:o.indexOf(i)>=0})),this.props.compare?t().createElement("td",{className:"checkbox"},t().createElement(Ks.c,{name:i,checked:r.indexOf(i)>=0})):null))}return t().createElement("div",{className:"panel-form-column"},this.props.userTitle?t().createElement("ul",{className:"contact-box small"},t().createElement(Rs,{tinode:this.props.tinode,item:this.props.item,title:this.props.userTitle,small:!0,avatar:(0,Es.Qn)(this.props.userAvatar?this.props.userAvatar:null)})):null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"title_permissions",defaultMessage:"Permissions",description:"Section title"})),t().createElement("table",{className:"permission-editor"},this.props.compare?t().createElement("thead",null,t().createElement("tr",null,t().createElement("th",null),t().createElement("th",null,this.props.modeTitle),t().createElement("th",null,this.props.compareTitle))):null,t().createElement("tbody",null,l)),t().createElement("br",null),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:"outline",onClick:this.handleCancel},t().createElement(i.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})),t().createElement("button",{className:"primary",onClick:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"}))))}}const si=(0,i.injectIntl)(ti),ii=QRCode;var ai=o.n(ii);class ni extends t().PureComponent{constructor(e){super(e),this.qrCodeRef=t().createRef()}componentDidMount(){new(ai())(this.qrCodeRef.current,{text:this.props.uri,width:as.eV,height:as.eV})}render(){return t().createElement("div",{className:"panel-form-column"},t().createElement("br",null),t().createElement("div",{className:"qr-code",ref:this.qrCodeRef}),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:"outline",onClick:this.props.onCancel},t().createElement(i.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"}))))}}var oi=o(1320),ri=o(4048);class li extends t().Component{constructor(e){super(e),this.selfRef=t().createRef(),this.state={active:e.active,initialValue:e.value||"",value:e.value||""},this.handeTextChange=this.handeTextChange.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleStartEditing=this.handleStartEditing.bind(this),this.handleEditingFinished=this.handleEditingFinished.bind(this),this.handlePasswordFinished=this.handlePasswordFinished.bind(this)}componentDidUpdate(e,t){const s=this.props.value||"";t.initialValue==s||t.active||this.setState({initialValue:s,value:s})}handeTextChange(e){this.setState({value:e.target.value||""})}handleKeyDown(e){27===e.keyCode?this.setState({value:this.props.value,active:!1}):13===e.keyCode&&this.handleEditingFinished(e)}handleStartEditing(){this.props.readOnly||this.setState({active:!0},(e=>{this.selfRef.current&&this.selfRef.current.focus()}))}handleEditingFinished(e){const t=this.state.value.trim();!this.props.required||e.target.checkValidity()&&t?(this.setState({active:!1}),(t||this.props.value)&&t!==this.props.value&&this.props.onFinished(t)):this.setState({value:this.props.value,active:!1})}handlePasswordFinished(e){this.setState({active:!1}),e&&e!==this.props.value&&this.props.onFinished(e)}render(){if(!this.state.active){let e="password"==this.props.type?"••••••••":this.state.value,s="in-place-edit"+(this.props.readOnly?" disabled":"");return e||(e=this.props.placeholder,s+=" placeholder"),this.props.multiline&&1!=this.props.multiline||(s+=" short"),t().createElement("span",{className:s,onClick:this.handleStartEditing},t().createElement("span",null,e))}let e;const s={};return"password"==this.props.type?(e=ri.c,s.onFinished=this.handlePasswordFinished):(this.props.multiline>1?(e="textarea",s.rows=this.props.multiline,s.className="inplace-edit"):(e="input",s.type=this.props.type||"text"),s.value=this.state.value,s.ref=this.selfRef,s.onChange=this.handeTextChange,s.onKeyDown=this.handleKeyDown,s.onBlur=this.handleEditingFinished),s.placeholder=this.props.placeholder,s.required=this.props.required?"required":"",s.autoComplete=this.props.autoComplete,s.autoFocus=!0,t().createElement(e,s,null)}}class ci extends t().Component{constructor(e){super(e),this.state={tags:this.props.tags||[],tagInput:"",activated:this.props.activated},this.handleTagInput=this.handleTagInput.bind(this),this.handleAddTag=this.handleAddTag.bind(this),this.handleRemoveTag=this.handleRemoveTag.bind(this),this.handleSubmit=this.handleSubmit.bind(this),this.handleCancel=this.handleCancel.bind(this)}static getDerivedStateFromProps(e,t){const s=e.tags||[];return(0,Cs.oQ)(s,t.tags)||t.activated?null:{tags:s}}handleTagInput(e){if(this.setState({tagInput:e}),e.length>0){const t=e[e.length-1];'"'==e[0]?e.length>1&&'"'==t&&this.handleAddTag(e.substring(1,e.length-1)):","!=t&&" "!=t&&";"!=t&&'"'!=t||this.handleAddTag(e.substring(0,e.length-1).trim())}}handleAddTag(e){const t=this.props.tinode.getServerParam("maxTagCount",as.QJ);if(e.length>0&&this.state.tags.length<t){const t=this.state.tags.slice(0);return t.push(e),this.setState({tags:t,tagInput:""}),this.props.onTagsChanged&&this.props.onTagsChanged(t),t}return this.state.tags}handleRemoveTag(e,t){const s=this.state.tags.slice(0);s.splice(t,1),this.setState({tags:s}),this.props.onTagsChanged&&this.props.onTagsChanged(s)}handleSubmit(){this.props.onSubmit(this.handleAddTag(this.state.tagInput.trim())),this.setState({activated:!1,tags:this.props.tags||[]})}handleCancel(){this.setState({activated:!1,tagInput:"",tags:this.props.tags||[]}),this.props.onCancel&&this.props.onCancel()}render(){const e=this.props.tinode.getServerParam("minTagLength",as.iE),s=this.props.tinode.getServerParam("maxTagLength",as.cj);let a=[];return this.state.activated?this.state.tags.map((t=>{a.push({user:t,invalid:t.length<e||t.length>s})})):(this.state.tags.map((e=>{a.push(t().createElement("span",{className:"badge",key:a.length},e))})),0==a.length&&(a=t().createElement("i",null,t().createElement(i.FormattedMessage,{id:"tags_not_found",defaultMessage:"No tags defined. Add some.",description:""})))),t().createElement("div",{className:"panel-form-column"},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},this.props.title)),this.state.activated?t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"tags_editor_no_tags",defaultMessage:"Add some tags",description:"Tag editor prompt when no tags are found."},(e=>t().createElement(Ys,{tinode:this.props.tinode,chips:a,avatarDisabled:!0,prompt:e,tabIndex:this.props.tabIndex,onEnter:this.handleAddTag,onFocusLost:this.handleAddTag,onCancel:this.handleCancel,onChipRemoved:this.handleRemoveTag,filterFunc:this.handleTagInput}))),this.props.onSubmit||this.props.onCancel?t().createElement("div",{id:"tag-manager-buttons",className:"dialog-buttons panel-form-row"},t().createElement("button",{className:"outline",onClick:this.handleCancel},t().createElement(i.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})),t().createElement("button",{className:"primary",onClick:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"button_ok",defaultMessage:"OK",description:"Button [OK]"}))):null):t().createElement("div",{className:"quoted"},t().createElement("a",{href:"#",className:"flat-button",onClick:e=>{e.preventDefault(),this.setState({activated:!0})}},t().createElement("i",{className:"material-icons"},"edit"),"  ",t().createElement(i.FormattedMessage,{id:"title_manage_tags",defaultMessage:"Manage",description:"Section title for the list of tags"})),t().createElement(t().Fragment,null,a)))}}class di extends t().Component{constructor(e){super(e);const t=this.props.tinode.getTopic(this.props.topic),s=t.getAccessMode();this.state={isMe:ss.Tinode.isMeTopicName(this.props.topic),owner:s&&s.isOwner(),fullName:t.public?t.public.fn:void 0,private:t.private?t.private.comment:null,description:t.public?t.public.note:void 0,avatar:(0,Es.Qn)(t.public?t.public.photo:null),tags:t.tags()||[],newAvatar:null,newAvatarMime:null},this.previousOnTags=null,this.tnNewTags=this.tnNewTags.bind(this),this.handleFullNameUpdate=this.handleFullNameUpdate.bind(this),this.handleImageUpdated=this.handleImageUpdated.bind(this),this.handleAvatarCropped=this.handleAvatarCropped.bind(this),this.handleAvatarCropCancel=this.handleAvatarCropCancel.bind(this),this.uploadAvatar=this.uploadAvatar.bind(this),this.handlePrivateUpdate=this.handlePrivateUpdate.bind(this),this.handleDescriptionUpdate=this.handleDescriptionUpdate.bind(this),this.handleTagsUpdated=this.handleTagsUpdated.bind(this)}componentDidMount(){const e=this.props.tinode.getTopic(this.props.topic);this.previousOnTags=e.onTagsUpdated,e.onTagsUpdated=this.tnNewTags}componentWillUnmount(){this.props.tinode.getTopic(this.props.topic).onTagsUpdated=this.previousOnTags}tnNewTags(e){this.setState({tags:e})}handleFullNameUpdate(e){(e=e.trim().substring(0,as.Yb))&&this.state.fullName!==e&&(this.setState({fullName:e}),this.props.onUpdateTopicDesc(this.props.topic,(0,Cs.QB)(e,null)))}handlePrivateUpdate(e){e=e.trim().substring(0,as.Yb),this.state.private!==e&&(this.setState({private:e}),this.props.onUpdateTopicDesc(this.props.topic,null,e||ss.Tinode.DEL_CHAR))}handleDescriptionUpdate(e){(e=e.trim().substring(0,as.aq))&&(this.setState({description:e}),this.props.onUpdateTopicDesc(this.props.topic,(0,Cs.QB)(null,null,null,e)))}handleImageUpdated(e,t){this.setState({newAvatar:t,newAvatarMime:e}),t||(this.setState({avatar:null}),this.props.onUpdateTopicDesc(this.props.topic,(0,Cs.QB)(null,ss.Tinode.DEL_CHAR)))}handleAvatarCropped(e,t,s,i){const a=t?URL.createObjectURL(t):null;this.setState({avatar:a,newAvatar:null,newAvatarMime:null}),t&&this.uploadAvatar(e,t,s,i)}uploadAvatar(e,t,s,i){const a=e=>{let{mime:t,blob:s}=e;if(s.size>as.cH){this.props.tinode.getLargeFileHelper().upload(s).then((e=>this.props.onUpdateTopicDesc(this.props.topic,(0,Cs.QB)(null,e)))).catch((e=>this.props.onError(e.message,"err")))}else(0,Es._K)(s).then((e=>{const s=(0,Es.Qn)({data:e.bits,type:t});this.setState({source:s}),this.props.onUpdateTopicDesc(this.props.topic,(0,Cs.QB)(null,s))}))};s>as.kz||i>as.kz||s!=i?(0,Es._k)(t,as.kz,as.kz,as._c,!0).then((e=>a(e))).catch((e=>this.props.onError(e.message,"err"))):a({mime:e,blob:t,width:s,height:i})}handleAvatarCropCancel(){this.setState({newAvatar:null,newAvatarMime:null})}handleTagsUpdated(e){(0,Cs.oQ)(this.state.tags.slice(0),e.slice(0))||this.props.onUpdateTags(e)}render(){if(this.state.newAvatar)return t().createElement(oi.c,{avatar:this.state.newAvatar,mime:this.state.newAvatarMime,onSubmit:this.handleAvatarCropped,onCancel:this.handleAvatarCropCancel,onError:this.props.onError});const e=this.state.isMe||this.state.owner;return t().createElement(t().Fragment,null,t().createElement("div",{className:"panel-form-column"},t().createElement("center",null,t().createElement(zs.c,{tinode:this.props.tinode,avatar:this.state.avatar,readOnly:!e,uid:this.props.topic,title:this.state.fullName,onImageUpdated:this.handleImageUpdated,onError:this.props.onError})),this.state.isMe?t().createElement("div",{className:"group"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_your_name",defaultMessage:"Your name",description:"Label for full name editing"})),t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"full_name_prompt",defaultMessage:"Full name, e.g. John Doe",description:"Input placeholder for person's full name"},(e=>t().createElement(li,{placeholder:e,value:this.state.fullName,required:!0,onFinished:this.handleFullNameUpdate}))))):t().createElement(t().Fragment,null,t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_topic_name",defaultMessage:"Name",description:"Label for editing topic name"}))),t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"topic_name_editing_placeholder",defaultMessage:"Freeform name of the group",description:"Prompt for entering topic name"},(s=>t().createElement(li,{placeholder:s,readOnly:!e,value:this.state.fullName,required:!0,onFinished:this.handleFullNameUpdate}))))),t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_private",defaultMessage:"Private comment",description:"Label for editing 'private'"}))),t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"private_editing_placeholder",defaultMessage:"Visible to you only",description:"Placeholder for editing 'private'"},(e=>t().createElement(li,{placeholder:e,value:this.state.private,onFinished:this.handlePrivateUpdate})))))),e||this.state.description?t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_description",defaultMessage:"Description",description:"Label for editing topic description"}))),t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"description_editing_placeholder",defaultMessage:"Description (optional)",description:"Placeholder for editing topic description"},(s=>t().createElement(li,{placeholder:s,readOnly:!e,value:this.state.description,multiline:2,onFinished:this.handleDescriptionUpdate}))))):null),e?t().createElement(t().Fragment,null,t().createElement("div",{className:"hr"}),t().createElement(i.FormattedMessage,{id:"title_tag_manager",defaultMessage:"Tags (search & discovery)",description:"Section title for TagManager"},(e=>t().createElement(ci,{tinode:this.props.tinode,title:e,activated:!1,tags:this.state.tags,onSubmit:this.handleTagsUpdated})))):null)}}class hi extends t().Component{constructor(e){super(e);this.props.tinode.getTopic(this.props.topic).getAccessMode();this.state={tags:[]},this.previousTagsUpdated=void 0,this.onTagsUpdated=this.onTagsUpdated.bind(this),this.handleTagsUpdated=this.handleTagsUpdated.bind(this)}componentDidUpdate(e){const t=this.props.tinode.getTopic(e.topic);t&&(t.onTagsUpdated!=this.onTagsUpdated&&("grp"==t.getType()?(this.previousTagsUpdated=t.onTagsUpdated,t.onTagsUpdated=this.onTagsUpdated):this.previousTagsUpdated=void 0),this.state.topic!=e.topic&&this.setState({topic:e.topic}))}componentWillUnmount(){this.props.tinode.getTopic(this.props.topic).onTagsUpdated=this.previousTagsUpdated}onTagsUpdated(e){this.setState({tags:e}),this.previousTagsUpdated&&this.previousTagsUpdated!=this.onTagsUpdated&&this.previousTagsUpdated(e)}handleTagsUpdated(e){(0,Cs.oQ)(this.state.tags.slice(0),e.slice(0))||this.props.onUpdateTagsRequest(this.props.topic,e)}render(){return t().createElement("div",{className:"scrollable-panel"},t().createElement(di,{tinode:this.props.tinode,topic:this.props.topic,onUpdateTopicDesc:this.props.onUpdateTopicDesc,onUpdateTags:this.handleTagsUpdated,onError:this.props.onError}))}}const pi=(0,i.defineMessages)({clear_messages:{id:"action_clear_messages",defaultMessage:"Clear Messages",description:"Flat button [Clear Messages] (soft-delete messages)"},clear_messages_warning:{id:"clear_messages_warning",defaultMessage:"Are you sure you want to clear all messages? It cannot be undone.",description:"Alert dialog warning when deleting all messages."},delete_messages:{id:"action_delete_messages",defaultMessage:"Clear Messages for All",description:"Flat button [Clear for All] (hard-delete all messages)"},delete_messages_warning:{id:"delete_messages_warning",defaultMessage:"Are you sure you want to delete all messages for everyone? It cannot be undone.",description:"Alert dialog warning when hard-deleting all messages."},topic_delete:{id:"topic_delete",defaultMessage:"Delete Conversation",description:"Alert title when deleting the topic."},topic_delete_warning:{id:"topic_delete_warning",defaultMessage:"Are you sure you want to delete this conversation? It cannot be undone.",description:"Alert warning when deleting entire topic"},leave_chat:{id:"action_leave_chat",defaultMessage:"Leave Conversation",description:"Flat button [Leave Conversation]"},leave_chat_warning:{id:"leave_chat_warning",defaultMessage:"Are you sure you want to leave this conversation?",description:"Alert dialog warning when unsubscribing from a chat."},block_contact:{id:"action_block_contact",defaultMessage:"Block Contact",description:"Flat button [Block Contact]"},block_contact_warning:{id:"block_contact_warning",defaultMessage:"Are you sure you want to block this contact?",description:"Alert dialog warning when blocking a contact."},report_chat:{id:"action_report_chat",defaultMessage:"Report Conversation",description:"Flat button [Report Group]"},report_chat_warning:{id:"report_chat_warning",defaultMessage:"Are you sure you want to block and report this conversation?",description:"Alert dialog warning when reporting a conversation for abuse"},other_user:{id:"label_other_user",defaultMessage:"Other",description:"Label for the other user when the user is unnamed"}});class mi extends t().PureComponent{constructor(e){super(e),this.handleDeleteTopic=this.handleDeleteTopic.bind(this),this.handleDeleteMessages=this.handleDeleteMessages.bind(this),this.handleLeave=this.handleLeave.bind(this),this.handleBlock=this.handleBlock.bind(this),this.handleReport=this.handleReport.bind(this)}handleDeleteTopic(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(pi.topic_delete),t(pi.topic_delete_warning),(e=>this.props.onDeleteTopic(this.props.topic)),null,!0,null)}handleDeleteMessages(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(this.props.deleter?pi.delete_messages:pi.clear_messages),t(this.props.deleter?pi.delete_messages_warning:pi.clear_messages_warning),(e=>this.props.onDeleteMessages(this.props.topic)),null,!0,null)}handleLeave(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(pi.leave_chat),t(pi.leave_chat_warning),(e=>this.props.onLeaveTopic(this.props.topic)),null,!0,null)}handleBlock(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(pi.block_contact),t(pi.block_contact_warning),(e=>this.props.onBlockTopic(this.props.topic)),null,!0,null)}handleReport(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(pi.report_chat),t(pi.report_chat_warning),(e=>{this.props.onReportTopic(this.props.topic)}),null,!0,null)}render(){const{formatMessage:e}=this.props.intl;return t().createElement("div",{className:"scrollable-panel"},t().createElement("div",{className:"panel-form-column"},this.props.channel?null:t().createElement("a",{href:"#",className:"flat-button",onClick:this.handleDeleteMessages},t().createElement("i",{className:"material-icons"},"delete_outline"),"  ",e(this.props.deleter?pi.delete_messages:pi.clear_messages)),this.props.owner?t().createElement("a",{href:"#",className:"danger flat-button",onClick:this.handleDeleteTopic},t().createElement("i",{className:"material-icons"},"delete"),"  ",e(pi.topic_delete)):t().createElement("a",{href:"#",className:"danger flat-button",onClick:this.handleLeave},t().createElement("i",{className:"material-icons"},"exit_to_app"),"  ",e(pi.leave_chat)),this.props.groupTopic?null:t().createElement("a",{href:"#",className:"danger flat-button",onClick:this.handleBlock},t().createElement("i",{className:"material-icons"},"block"),"  ",e(pi.block_contact)),this.props.owner?null:t().createElement("a",{href:"#",className:"danger flat-button",onClick:this.handleReport},t().createElement("i",{className:"material-icons"},"report"),"  ",e(pi.report_chat))),t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-column"},this.props.groupTopic?t().createElement(t().Fragment,null,t().createElement("div",{className:"group"},t().createElement("label",null,t().createElement(i.FormattedMessage,{id:"label_your_permissions",defaultMessage:"Your permissions:",description:"Label for current user permissions"}))," ",t().createElement("tt",{className:"clickable",onClick:e=>{e.preventDefault(),this.props.onLaunchPermissionsEditor("want")}},this.props.access)),this.props.channel?null:t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_default_access_mode",defaultMessage:"Default access mode:",description:"Label for default access mode"}))),t().createElement("div",{className:"quoted"},t().createElement("div",null,"Auth: ",t().createElement("tt",{className:this.props.owner?"clickable":null,onClick:e=>{e.preventDefault(),this.props.owner&&this.props.onLaunchPermissionsEditor("auth")}},this.props.auth)),t().createElement("div",null,"Anon: ",t().createElement("tt",{className:this.props.owner?"clickable":null,onClick:e=>{e.preventDefault(),this.props.owner&&this.props.onLaunchPermissionsEditor("anon")}},this.props.anon))))):t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_permissions",defaultMessage:"Permissions:",description:"Section title"}))),t().createElement("div",{className:"quoted"},t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"label_you",defaultMessage:"You:",description:"Label for the current user"})," ",t().createElement("tt",{className:"clickable",onClick:e=>{e.preventDefault(),this.props.onLaunchPermissionsEditor("want")}},this.props.access)),t().createElement("div",null,this.props.fullName?this.props.fullName:e(pi.other_user),":  ",t().createElement("tt",{className:"clickable",onClick:e=>{e.preventDefault(),this.props.onLaunchPermissionsEditor("given")}},this.props.modeGiven2))))))}}const ui=(0,i.injectIntl)(mi),gi=(0,i.defineMessages)({info:{id:"panel_title_info",description:"Title for InfoView",defaultMessage:"Info"},general:{id:"panel_title_general",description:"Title for TopicCommon.",defaultMessage:"General"},security:{id:"panel_title_security",description:"Title for TopicSecirity and AccSecurity.",defaultMessage:"Security"},members:{id:"panel_title_members",description:"Title for managing group members view.",defaultMessage:"Members"},crop:{id:"panel_title_crop",description:"Title for AvatarCropView.",defaultMessage:"Drag to Adjust"},perm_want:{id:"requested_permissions",defaultMessage:"Requested",description:"Title for permissions"},perm_given:{id:"granted_permissions",defaultMessage:"Granted",description:"Title for permissions"},perm_auth:{id:"permissions_authenticated",defaultMessage:"Authenticated",description:"Title for editing default authenticated permissions"},perm_anon:{id:"permissions_anonymous",defaultMessage:"Anonymous",description:"Title for editing default anonymous permissions"},perm_user:{id:"permissions_user",defaultMessage:"User's Permissions",description:"Title for editing user's permissions"},edit_permissions:{id:"menu_item_edit_permissions",defaultMessage:"Edit permissions",description:"Menu item [Edit permissions]"},qrcode:{id:"scan_qr_code",defaultMessage:"Scan QR Code",description:"Title for scanning QR code"}});class fi extends t().Component{constructor(e){super(e),this.state={topic:null,owner:!1,admin:!1,sharer:!1,deleter:!1,muted:!1,address:null,groupTopic:void 0,channel:void 0,fullName:void 0,description:void 0,avatar:null,private:null,selectedContact:null,access:null,modeGiven:null,modeWant:null,modeGiven2:null,modeWant2:null,auth:null,anon:null,contactList:[],trustedBadges:[],previousMetaDesc:void 0,previousSubsUpdated:void 0},this.resetSubs=this.resetSubs.bind(this),this.resetDesc=this.resetDesc.bind(this),this.resetTags=this.resetTags.bind(this),this.onMetaDesc=this.onMetaDesc.bind(this),this.onSubsUpdated=this.onSubsUpdated.bind(this),this.handleImageChanged=this.handleImageChanged.bind(this),this.handleMuted=this.handleMuted.bind(this),this.handleUnarchive=this.handleUnarchive.bind(this),this.handlePermissionsChanged=this.handlePermissionsChanged.bind(this),this.handleLaunchPermissionsEditor=this.handleLaunchPermissionsEditor.bind(this),this.handleCopyID=this.handleCopyID.bind(this),this.handleShowQRCode=this.handleShowQRCode.bind(this),this.handleShowAddMembers=this.handleShowAddMembers.bind(this),this.handleMemberUpdateRequest=this.handleMemberUpdateRequest.bind(this),this.handleMemberSelected=this.handleMemberSelected.bind(this),this.handleContextMenu=this.handleContextMenu.bind(this),this.handleBackNavigate=this.handleBackNavigate.bind(this)}componentDidUpdate(e){const t=this.props.tinode.getTopic(e.topic);t&&(this.onMetaDesc!=t.onMetaDesc&&(this.previousMetaDesc=t.onMetaDesc,t.onMetaDesc=this.onMetaDesc,this.previousSubsUpdated=t.onSubsUpdated,t.onSubsUpdated=this.onSubsUpdated),this.state.topic!=e.topic&&(this.setState({topic:e.topic}),this.resetDesc(t,e),this.resetSubs(t,e),this.resetTags(t)))}componentWillUnmount(){const e=this.props.tinode.getTopic(this.props.topic);e&&(this.setState({topic:null}),e.onMetaDesc=this.previousMetaDesc,e.onSubsUpdated=this.previousSubsUpdated)}resetSubs(e,t){const s={contactList:[]};if("p2p"==e.getType()){const i=e.subscriber(t.topic);i?(s.modeGiven2=i.acs.getGiven(),s.modeWant2=i.acs.getWant()):(s.modeGiven2=as.Ir,s.modeWant2=as.Ir)}else e.subscribers((e=>{s.contactList.push(e)}),this);this.setState(s)}resetDesc(e,t){const s=e.getDefaultAccess()||{},i=e.getAccessMode(),a=[];if(e.trusted)for(const[t,s]of Object.entries(e.trusted))s&&a.push(t);this.setState({owner:i&&i.isOwner(),admin:i&&i.isAdmin(),sharer:i&&i.isSharer(),deleter:i&&i.isDeleter(),muted:i&&i.isMuted(),fullName:(0,Cs.KF)(e.public&&e.public.fn,as.Yb),description:(0,Cs.KF)(e.public&&e.public.note,as.aq),avatar:(0,Es.Qn)(e.public?e.public.photo:null),trustedBadges:a,private:(0,Cs.KF)(e.private&&e.private.comment,as.Yb),archived:e.isArchived(),address:e.name,groupTopic:e.isGroupType(),channel:e.isChannelType()||e.chan,access:i?i.getMode():void 0,modeGiven:i?i.getGiven():void 0,modeWant:i?i.getWant():void 0,auth:s.auth,anon:s.anon})}resetTags(e){if("grp"!=e.getType())return;const t=e.getAccessMode();t&&t.isOwner()&&e.getMeta(e.startMetaQuery().withTags().build())}onMetaDesc(e){const t=this.props.tinode.getTopic(this.props.topic);t&&(this.resetDesc(t,this.props),this.previousMetaDesc&&this.previousMetaDesc!=this.onMetaDesc&&this.previousMetaDesc(e))}onSubsUpdated(e){const t=this.props.tinode.getTopic(this.props.topic);t&&(this.resetSubs(t,this.props),this.previousSubsUpdated&&this.previousSubsUpdated!=this.onSubsUpdated&&this.previousSubsUpdated(e))}handleImageChanged(e,t){this.setState({avatar:t}),this.props.onTopicDescUpdate(this.props.topic,(0,Cs.QB)(null,t||ss.Tinode.DEL_CHAR),null)}handleMuted(e,t){this.setState({muted:t}),this.props.onChangePermissions(this.props.topic,t?"-P":"+P")}handleUnarchive(e,t){this.props.onTopicUnArchive(this.props.topic)}handlePermissionsChanged(e,t){switch(e){case"auth":this.props.onTopicDescUpdateRequest(this.props.topic,null,null,{auth:t});break;case"anon":this.props.onTopicDescUpdateRequest(this.props.topic,null,null,{anon:t});break;case"mode":case"want":this.props.onChangePermissions(this.props.topic,t);break;case"given":this.props.onChangePermissions(this.props.topic,t,this.props.topic);break;case"user":this.props.onChangePermissions(this.props.topic,t,this.state.userPermissionsEdited)}this.handleBackNavigate()}handleLaunchPermissionsEditor(e,t){const{formatMessage:s}=this.props.intl;let i,a,n,o,r,l,c;switch(e){case"mode":i=this.state.access;break;case"want":i=this.state.modeWant,a=this.state.modeGiven,this.state.owner?n="O":(n=ss.AccessMode.encode(ss.AccessMode.diff("ASDO",this.state.modeGiven)),this.state.channel&&(n+="W")),o=s(gi.perm_want),r=s(gi.perm_given);break;case"given":i=this.state.modeGiven2,a=this.state.modeWant2,n=this.state.groupTopic?this.state.owner?"":"O":"ASDO",o=s(gi.perm_given),r=s(gi.perm_want);break;case"auth":i=this.state.auth,n="O";break;case"anon":i=this.state.anon,n="O";break;case"user":{const e=this.props.tinode.getTopic(this.props.topic);if(!e)return;const d=e.subscriber(t);if(!d||!d.acs)return;i=d.acs.getGiven(),a=d.acs.getWant(),n=this.state.owner?"":"O",o=s(gi.perm_given),r=s(gi.perm_want),d.public&&(l=d.public.fn,c=d.public.photo);break}default:return void console.error("Unknown permission editing mode '"+e+"'")}this.setState({userPermissionsEdited:t,userPermissionsTitle:l,userPermissionsAvatar:c,editedPermissions:i,immutablePermissions:a,editedPermissionsTitle:o,immutablePermissionsTitle:r,editedPermissionsSkipped:n}),this.props.onNavigate(`perm/${e}`)}handleCopyID(e){e.preventDefault(),navigator.clipboard.writeText(this.props.myUserId)}handleShowQRCode(e){e.preventDefault(),this.props.onNavigate("qrcode")}handleShowAddMembers(e){e.preventDefault(),this.props.onInitFind(),this.props.onNavigate("members")}handleMemberUpdateRequest(e,t,s){this.props.onMemberUpdateRequest(this.props.topic,t,s),this.props.onNavigate("info")}handleMemberSelected(e){this.setState({selectedContact:e})}handleBackNavigate(){const e=(this.props.panel||"info").split("/");"info"==e[0]?this.props.onNavigate(null):"perm"==e[0]?"user"==e[1]?this.props.onNavigate("info"):this.props.onNavigate("security"):this.props.onNavigate("info")}handleContextMenu(e){const{formatMessage:t}=this.props.intl,s=this.props.tinode.getTopic(this.props.topic);if(!s)return;const i=s.subscriber(e.topicName);if(!i||!i.acs)return;const a=this.props.tinode.isMe(e.topicName),n=[{title:t(gi.edit_permissions),handler:t=>this.handleLaunchPermissionsEditor(a?"want":"user",e.topicName)}];a||n.push("member_delete"),n.push(i.acs.isMuted()?"member_unmute":"member_mute"),a||n.push(i.acs.isJoiner()?"member_block":"member_unblock"),this.props.showContextMenu({topicName:this.props.topic,x:e.x,y:e.y,user:e.topicName},n)}render(){const e=(this.props.panel||"info").split("/"),s=e[0];e.shift();const{formatMessage:a}=this.props.intl,n=a(("perm"==s?gi["perm_"+e[0]]:gi[s])||gi.info);return t().createElement("div",{id:"info-view"},t().createElement("div",{className:"caption-panel",id:"info-caption-panel"},t().createElement("div",{className:"panel-title",id:"info-title"},n),t().createElement("div",null,t().createElement(Qs,{onCancel:this.handleBackNavigate}))),this.props.displayMobile?t().createElement(Gs,{level:this.props.errorLevel,text:this.props.errorText,onClearError:this.props.onError}):null,"members"==s?t().createElement(Zs,{tinode:this.props.tinode,members:this.state.contactList,requiredMember:this.props.myUserId,keepInitialMembers:!this.state.admin&&!this.state.owner,myUserId:this.props.myUserId,contacts:this.props.searchableContacts,onCancel:this.handleBackNavigate,onSubmit:this.handleMemberUpdateRequest}):"perm"==s&&e.length>0?t().createElement(si,{tinode:this.props.tinode,mode:this.state.editedPermissions,compare:this.state.immutablePermissions,skip:this.state.editedPermissionsSkipped,modeTitle:this.state.editedPermissionsTitle,compareTitle:this.state.immutablePermissionsTitle,userTitle:this.state.userPermissionsTitle,item:this.state.userPermissionsEdited,userAvatar:this.state.userPermissionsAvatar,onSubmit:t=>this.handlePermissionsChanged(e[0],t),onCancel:this.handleBackNavigate}):"general"==s?t().createElement(hi,{tinode:this.props.tinode,topic:this.props.topic,reqCredMethod:this.props.reqCredMethod,onCredAdd:this.props.onCredAdd,onUpdateTagsRequest:this.props.onTopicTagsUpdateRequest,onCredConfirm:this.props.onCredConfirm,onCredDelete:this.props.onCredDelete,onUpdateTopicDesc:this.props.onTopicDescUpdateRequest,onError:this.props.onError}):"security"==s?t().createElement(ui,{topic:this.props.topic,owner:this.state.owner,admin:this.state.admin,sharer:this.state.sharer,deleter:this.state.deleter,muted:this.state.muted,groupTopic:this.state.groupTopic,channel:this.state.channel,access:this.state.access,modeGiven:this.state.modeGiven,modeWant:this.state.modeWant,modeGiven2:this.state.modeGiven2,modeWant2:this.state.modeWant2,auth:this.state.auth,anon:this.state.anon,onShowAlert:this.props.onShowAlert,onDeleteMessages:this.props.onDeleteMessages,onLeaveTopic:this.props.onLeaveTopic,onBlockTopic:this.props.onBlockTopic,onReportTopic:this.props.onReportTopic,onLaunchPermissionsEditor:this.handleLaunchPermissionsEditor,onNavigate:this.props.onNavigate}):"qrcode"==s?t().createElement(ni,{uri:ss.Tinode.URI_TOPIC_ID_PREFIX+this.props.tinode.myUserId,onCancel:this.handleBackNavigate}):t().createElement("div",{id:"info-view-content",className:"scrollable-panel"},t().createElement("div",{className:"panel-form-column"},t().createElement("a",{href:"#",className:"flat-button float-right",onClick:e=>{e.preventDefault(),this.props.onNavigate("general")}},t().createElement("i",{className:"material-icons"},"edit")," ",t().createElement(i.FormattedMessage,{id:"button_edit",defaultMessage:"Edit",description:"Call to action [Edit]"})),t().createElement("center",null,t().createElement(zs.c,{tinode:this.props.tinode,avatar:this.state.avatar,readOnly:!0,uid:this.props.topic,title:this.state.fullName})),t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_topic_name",defaultMessage:"Name",description:"Label for editing topic name"}))),t().createElement("div",{className:"large ellipsized"},this.state.fullName,this.state.channel?t().createElement("img",{src:"/img/channel.png",className:"channel",alt:"channel"}):null)),this.state.private?t().createElement("div",{className:"group"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_private",defaultMessage:"Private comment",description:"Label for editing 'private'"}))),t().createElement("div",{className:"large ellipsized"},this.state.private)):null,t().createElement("div",{className:"panel-form-row"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_user_id",defaultMessage:"ID:",description:"Label for user address (ID)"}))," ",t().createElement("tt",null,this.state.address)),t().createElement("div",{style:{marginLeft:"auto"}}," ",t().createElement("a",{href:"#",onClick:this.handleCopyID},t().createElement("i",{className:"material-icons"},"content_copy")),"   ",t().createElement("a",{href:"#",onClick:this.handleShowQRCode},t().createElement("i",{className:"material-icons"},"qr_code"))," ")),t().createElement("div",{className:"group"},t().createElement(js.c,{trustedBadges:this.state.trustedBadges})),this.state.description?t().createElement("div",{className:"group"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_description",defaultMessage:"Description",description:"Label for editing topic description"})),t().createElement("div",null,this.state.description)):null),t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-row"},t().createElement("label",null,t().createElement(i.FormattedMessage,{id:"label_muting_topic",defaultMessage:"Muted:",description:"Label for Muting/unmuting the topic"})),t().createElement(Ks.c,{name:"P",checked:this.state.muted,onChange:this.handleMuted})),this.state.archived?t().createElement("div",{className:"panel-form-row"},t().createElement("label",null,t().createElement(i.FormattedMessage,{id:"label_unarchive_topic",defaultMessage:"Archived:",description:"Label for unarchiving the topic"})),t().createElement(Ks.c,{name:"archived",checked:!0,onChange:this.handleUnarchive})):null,t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-row"},t().createElement("a",{href:"#",className:"flat-button",onClick:e=>{e.preventDefault(),this.props.onNavigate("security")}},t().createElement("i",{className:"material-icons"},"security")," ",t().createElement(i.FormattedMessage,{id:"button_security",defaultMessage:"Security",description:"Navigaton button for security panel."}))),this.state.groupTopic&&this.state.sharer?t().createElement(t().Fragment,null,t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_group_members",defaultMessage:"Group members:",description:"Section title or label"}))),t().createElement("div",{className:"panel-form-row"},t().createElement("a",{href:"#",className:"flat-button",onClick:this.handleShowAddMembers},t().createElement("i",{className:"material-icons"},"person_add"),"  ",t().createElement(i.FormattedMessage,{id:"button_add_members",defaultMessage:"Add members",description:"Flat button [Add members] (to topic)"}))),t().createElement(i.FormattedMessage,{id:"group_has_no_members",defaultMessage:"No members",description:"Shown in place of group members"},(e=>t().createElement(Os,{tinode:this.props.tinode,contacts:this.state.contactList,myUserId:this.props.myUserId,emptyListMessage:e,topicSelected:this.state.selectedContact,showOnline:!1,showUnread:!1,showMode:!0,noScroll:!0,onTopicSelected:this.handleMemberSelected,showContextMenu:!!this.state.admin&&this.handleContextMenu})))):null))}}const bi=(0,i.injectIntl)(fi),vi=new Audio("audio/call-out.m4a");vi.loop=!0;const wi=new Audio("audio/call-end.m4a");wi.loop=!0;const Ei=new Audio("audio/dialing.m4a"),Ci="video:muted",Si="video:unmuted",yi=(0,i.defineMessages)({already_in_call:{id:"already_in_call",defaultMessage:"You already in an ongoing call!",description:"Error message when the user tried to accept a new call without finishing pervious one"}});class Mi extends t().PureComponent{constructor(e){super(e),this.state={localStream:void 0,remoteStream:void 0,pc:void 0,dataChannel:void 0,previousOnInfo:void 0,waitingForPeer:!1,callInitialSetupComplete:!1,audioOnly:e.callAudioOnly,videoToggleInProgress:!1,remoteVideoLive:!1},this.localStreamConstraints={audio:!0,video:!e.callAudioOnly},this.isOutgoingCall=1==e.callState,this.localRef=t().createRef(),this.remoteRef=t().createRef(),this.remoteIceCandidatesCache=[],this.onInfo=this.onInfo.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.createPeerConnection=this.createPeerConnection.bind(this),this.canSendOffer=this.canSendOffer.bind(this),this.drainRemoteIceCandidatesCache=this.drainRemoteIceCandidatesCache.bind(this),this.handleNegotiationNeededEvent=this.handleNegotiationNeededEvent.bind(this),this.handleICECandidateEvent=this.handleICECandidateEvent.bind(this),this.handleNewICECandidateMsg=this.handleNewICECandidateMsg.bind(this),this.handleICEConnectionStateChangeEvent=this.handleICEConnectionStateChangeEvent.bind(this),this.handleSignalingStateChangeEvent=this.handleSignalingStateChangeEvent.bind(this),this.handleICEGatheringStateChangeEvent=this.handleICEGatheringStateChangeEvent.bind(this),this.handleIceCandidateErrorEvent=this.handleIceCandidateErrorEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.handleVideoOfferMsg=this.handleVideoOfferMsg.bind(this),this.handleVideoAnswerMsg=this.handleVideoAnswerMsg.bind(this),this.handleNewICECandidateMsg=this.handleNewICECandidateMsg.bind(this),this.reportError=this.reportError.bind(this),this.handleGetUserMediaError=this.handleGetUserMediaError.bind(this),this.stopTracks=this.stopTracks.bind(this),this.disconnectMedia=this.disconnectMedia.bind(this),this.handleCloseClick=this.handleCloseClick.bind(this),this.handleToggleCameraClick=this.handleToggleCameraClick.bind(this),this.handleToggleMicClick=this.handleToggleMicClick.bind(this),this.handleRemoteHangup=this.handleRemoteHangup.bind(this),this.handleVideoCallAccepted=this.handleVideoCallAccepted.bind(this),this.muteVideo=this.muteVideo.bind(this),this.unmuteVideo=this.unmuteVideo.bind(this),this.emptyVideoTrack=this.emptyVideoTrack.bind(this),this.handleDataChannelEvent=this.handleDataChannelEvent.bind(this),this.handleDataChannelError=this.handleDataChannelError.bind(this),this.handleDataChannelMessage=this.handleDataChannelMessage.bind(this),this.handleDataChannelOpen=this.handleDataChannelOpen.bind(this),this.handleDataChannelClose=this.handleDataChannelClose.bind(this)}componentDidMount(){const e=this.props.tinode.getTopic(this.props.topic);this.previousOnInfo=e.onInfo,e.onInfo=this.onInfo,1!=this.props.callState&&3!=this.props.callState||!this.localRef.current||this.start()}componentWillUnmount(){this.props.tinode.getTopic(this.props.topic).onInfo=this.previousOnInfo,this.stop()}handleVideoCallAccepted(e){vi.pause();const t=this.createPeerConnection(!0),s=this.state.localStream;s.getTracks().forEach((e=>{t.addTrack(e,s),"video"==e.kind&&this.state.audioOnly&&(e.enabled=!1,e.stop(),s.removeTrack(e))}))}onInfo(e){if("call"==e.what)switch(e.event){case"accept":this.handleVideoCallAccepted(e);break;case"answer":this.handleVideoAnswerMsg(e);break;case"ice-candidate":this.handleNewICECandidateMsg(e);break;case"hang-up":this.handleRemoteHangup(e);break;case"offer":this.handleVideoOfferMsg(e);break;case"ringing":vi.play().catch((e=>{}));break;default:console.warn("Unknown call event",e.event)}}emptyVideoTrack(){const e=Object.assign(document.createElement("canvas"),{width:640,height:480});e.getContext("2d").fillRect(0,0,640,480);const t=e.captureStream(0);return Object.assign(t.getVideoTracks()[0],{enabled:!1})}start(){this.state.localStream?this.props.onError(this.props.intl.formatMessage(yi.already_in_call),"info"):3!=this.props.callState?navigator.mediaDevices.getUserMedia(this.localStreamConstraints).then((e=>{this.localStreamConstraints.video||e.addTrack(this.emptyVideoTrack()),this.setState({localStream:e,waitingForPeer:!0}),this.localRef.current.srcObject=e,Ei.play(),this.props.onInvite(this.props.topic,this.props.seq,this.props.callState,this.props.callAudioOnly)})).catch(this.handleGetUserMediaError):this.props.onInvite(this.props.topic,this.props.seq,3,this.props.callAudioOnly)}stop(){wi.pause(),wi.currentTime=0,vi.pause(),vi.currentTime=0,this.stopTracks(this.state.localStream),this.stopTracks(this.state.remoteStream),this.disconnectMedia(this.localRef.current),this.disconnectMedia(this.remoteRef.current),this.state.pc&&(this.state.pc.ontrack=null,this.state.pc.onremovetrack=null,this.state.pc.onremovestream=null,this.state.pc.onicecandidate=null,this.state.pc.oniceconnectionstatechange=null,this.state.pc.onsignalingstatechange=null,this.state.pc.onicegatheringstatechange=null,this.state.pc.onnegotiationneeded=null,this.state.pc.onicecandidateerror=null,this.state.pc.ondatachannel=null,!this.state.dataChannel||"open"!=this.state.dataChannel.readyState&&"connecting"!=this.state.dataChannel.readyState||this.state.dataChannel.close(),this.state.pc.close()),this.setState({pc:null,waitingForPeer:!1})}disconnectMedia(e){e&&(e.srcObject=null,e.src="")}stopTracks(e){if(!e)return;let t=e.getTracks();t&&t.forEach((e=>{e.stop(),e.enabled=!1}))}handleDataChannelError(e){console.error("data channel error",e)}handleDataChannelMessage(e){switch(e.data){case Ci:this.setState({remoteVideoLive:!1},(e=>{this.remoteRef.current.srcObject=this.state.remoteStream}));break;case Si:this.setState({remoteVideoLive:!0},(e=>{this.remoteRef.current.srcObject=this.state.remoteStream}))}}handleDataChannelOpen(e){this.state.audioOnly||e.target.send(Si)}handleDataChannelClose(e){console.log("close data channel:",e)}handleDataChannelEvent(e){console.log("data channel event:",e);const t=e.channel;t.onerror=this.handleDataChannelError,t.onmessage=this.handleDataChannelMessage,t.onopen=this.handleDataChannelOpen,t.onclose=this.handleDataChannelClose,this.setState({dataChannel:t})}createPeerConnection(e){const t=this.props.tinode.getServerParam("iceServers",null),s=t?new RTCPeerConnection({iceServers:t}):new RTCPeerConnection;s.onicecandidate=this.handleICECandidateEvent,s.oniceconnectionstatechange=this.handleICEConnectionStateChangeEvent,s.onicegatheringstatechange=this.handleICEGatheringStateChangeEvent,s.onsignalingstatechange=this.handleSignalingStateChangeEvent,s.onnegotiationneeded=this.handleNegotiationNeededEvent,s.onicecandidateerror=this.handleIceCandidateErrorEvent,s.ontrack=this.handleTrackEvent,s.ondatachannel=this.handleDataChannelEvent;let i={pc:s,waitingForPeer:!1};if(e){const e=s.createDataChannel("events",{ordered:!0});e.onerror=this.handleDataChannelError,e.onmessage=this.handleDataChannelMessage,e.onopen=this.handleDataChannelOpen,e.onclose=this.handleDataChannelClose,i.dataChannel=e}return this.setState(i),s}handleVideoAnswerMsg(e){const t=new RTCSessionDescription(e.payload);this.state.pc.setRemoteDescription(t).then((e=>{this.setState({callInitialSetupComplete:!0},(e=>this.drainRemoteIceCandidatesCache()))})).catch((e=>this.reportError(e)))}reportError(e){this.props.onError(e.message,"err")}canSendOffer(){return this.isOutgoingCall||this.state.callInitialSetupComplete}handleNegotiationNeededEvent(e){const t=e.target;this.canSendOffer()&&t.createOffer().then((e=>t.setLocalDescription(e))).then((e=>{this.props.onSendOffer(this.props.topic,this.props.seq,t.localDescription.toJSON())})).catch((e=>this.reportError(e)))}handleIceCandidateErrorEvent(e){console.warn("ICE candidate error:",e)}handleICECandidateEvent(e){e.candidate&&this.props.onIceCandidate(this.props.topic,this.props.seq,e.candidate.toJSON())}handleNewICECandidateMsg(e){const t=new RTCIceCandidate(e.payload);this.state.callInitialSetupComplete?this.state.pc.addIceCandidate(t).catch((e=>{t.candidate&&this.reportError(e),console.warn("Error adding new ice candidate",t,e)})):this.remoteIceCandidatesCache.push(t)}drainRemoteIceCandidatesCache(){this.remoteIceCandidatesCache.forEach((e=>{this.state.pc.addIceCandidate(e).catch((t=>{e.candidate&&this.reportError(t),console.warn("Error adding cached ice candidate",e,t)}))})),this.remoteIceCandidatesCache=[]}handleICEConnectionStateChangeEvent(e){switch(e.target.iceConnectionState){case"closed":case"failed":this.handleCloseClick()}}handleSignalingStateChangeEvent(e){"closed"==e.target.signalingState&&this.handleCloseClick()}handleICEGatheringStateChangeEvent(e){}handleTrackEvent(e){this.remoteRef.current.srcObject=e.streams[0],this.setState({remoteStream:e.streams[0]})}handleGetUserMediaError(e){switch(console.error("Error opening camera and/or microphone",e),e.name){case"NotFoundError":default:this.reportError(e);case"SecurityError":case"PermissionDeniedError":}this.handleCloseClick()}handleVideoOfferMsg(e){let t=null;const s=this.state.pc?this.state.pc:this.createPeerConnection(!1),i=new RTCSessionDescription(e.payload);s.setRemoteDescription(i).then((e=>navigator.mediaDevices.getUserMedia(this.localStreamConstraints))).then((e=>{let i;this.localStreamConstraints.video||(i=this.emptyVideoTrack(),e.addTrack(i)),t=e,this.localRef.current.srcObject=e,this.setState({localStream:e}),t.getTracks().forEach((e=>{s.addTrack(e,t)})),i&&(i.enabled=!1,i.stop(),e.removeTrack(i))})).then((e=>s.createAnswer())).then((e=>s.setLocalDescription(e))).then((e=>{this.props.onSendAnswer(this.props.topic,this.props.seq,s.localDescription.toJSON()),this.setState({callInitialSetupComplete:!0},(e=>this.drainRemoteIceCandidatesCache()))})).catch(this.handleGetUserMediaError)}handleRemoteHangup(){this.state.waitingForPeer?(this.setState({waitingForPeer:!1}),vi.pause(),vi.currentTime=0,wi.loop=!0,wi.play().catch((e=>{})),setTimeout((e=>{this.handleCloseClick()}),2e3)):this.handleCloseClick()}handleCloseClick(){this.stop(),this.props.onHangup(this.props.topic,this.props.seq)}muteVideo(){if(!this.state.pc||!this.state.dataChannel)return;const e=this.state.localStream,t=e.getVideoTracks()[0];t.enabled=!1,t.stop(),e.removeTrack(t),this.state.dataChannel.send(Ci),this.setState({videoToggleInProgress:!1})}unmuteVideo(){this.state.pc&&this.state.dataChannel&&navigator.mediaDevices.getUserMedia({video:!0}).then((e=>{this.localRef.current.srcObject=null;const t=this.state.pc.getSenders().find((e=>"video"==e.track.kind)),s=e.getVideoTracks()[0];return e.removeTrack(s),this.state.localStream.addTrack(s),t.replaceTrack(s)})).then((e=>{this.localRef.current.srcObject=this.state.localStream,this.state.dataChannel.send(Si)})).catch((e=>this.handleGetUserMediaError(e))).finally((e=>{this.setState({videoToggleInProgress:!1})}))}handleToggleCameraClick(){if(this.state.videoToggleInProgress)return;const e=this.state.localStream.getVideoTracks();this.setState({videoToggleInProgress:!0},(t=>{e&&e.length>0&&e[0].enabled&&"live"==e[0].readyState?this.muteVideo():this.unmuteVideo(),this.setState({audioOnly:!this.state.audioOnly})}))}handleToggleMicClick(){const e=this.state.localStream.getAudioTracks()[0];e.enabled=!e.enabled,this.forceUpdate()}render(){const e=this.state.localStream&&this.state.localStream.getAudioTracks(),s=!this.state.audioOnly&&this.state.localStream&&this.state.localStream.getVideoTracks(),a=!this.state.pc||!this.state.dataChannel||!(e&&e[0]),n=e&&e[0]&&e[0].enabled?"mic":"mic_off",o=s&&s[0]&&s[0].enabled&&"live"==s[0].readyState?"videocam":"videocam_off",r=(0,Cs.KF)(this.props.title,as.q),l=this.state.waitingForPeer?" pulse":"";let c=!1;if(this.remoteRef.current&&this.remoteRef.current.srcObject&&this.state.remoteVideoLive){const e=this.remoteRef.current.srcObject;if(e.getVideoTracks().length>0){const t=e.getVideoTracks()[0];c=t.enabled&&"live"==t.readyState}}return t().createElement(t().Fragment,null,t().createElement("div",{id:"video-container"},t().createElement("div",{id:"video-container-panel"},t().createElement("div",{className:"call-party self",disabled:this.state.audioOnly},t().createElement("video",{ref:this.localRef,autoPlay:!0,muted:!0,playsInline:!0}),t().createElement("div",{className:"caller-name inactive"},t().createElement(i.FormattedMessage,{id:"calls_you_label",defaultMessage:"You",description:"Shown over the local video screen"}))),t().createElement("div",{className:"call-party peer",disabled:!c},c?t().createElement(t().Fragment,null,t().createElement("video",{ref:this.remoteRef,autoPlay:!0,playsInline:!0}),t().createElement("div",{className:"caller-name inactive"},r)):t().createElement(t().Fragment,null,t().createElement("audio",{ref:this.remoteRef,autoPlay:!0}),t().createElement("div",{className:`caller-card${l}`},t().createElement("div",{className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:this.props.avatar,topic:this.props.topic,title:this.props.title})),t().createElement("div",{className:"caller-name"},r))))),t().createElement("div",{className:"controls"},t().createElement("button",{className:"danger",onClick:this.handleCloseClick},t().createElement("i",{className:"material-icons"},"call_end")),t().createElement("button",{className:"secondary",onClick:this.handleToggleCameraClick,disabled:a},t().createElement("i",{className:"material-icons"},o)),t().createElement("button",{className:"secondary",onClick:this.handleToggleMicClick,disabled:a},t().createElement("i",{className:"material-icons"},n)))))}}const _i=(0,i.injectIntl)(Mi);class Ti extends t().Component{constructor(e){super(e),this.state={downloader:null,progress:0},this.downloadFile=this.downloadFile.bind(this),this.handleCancel=this.handleCancel.bind(this)}downloadFile(e,t,s){if(!e)return void this.props.onError("Invalid download URL '"+e+"'");const i=this.props.tinode.getLargeFileHelper();this.setState({downloader:i}),i.download(e,t,s,(e=>this.setState({progress:e/this.props.size})),(e=>this.props.onError(e,"err"))).then((e=>this.setState({downloader:null,progress:0}))).catch((e=>{e&&this.props.onError("Error downloading file: "+e.message,"err"),this.setState({downloader:null,progress:0})}))}handleCancel(){this.props.uploading?this.props.onCancelUpload():this.state.downloader&&this.state.downloader.cancel()}render(){let e=this.props.filename||"file_attachment";e.length>36&&(e=e.substr(0,16)+"..."+e.substr(-16));let s,a,n=this.props.size>0?t().createElement("span",{className:"small gray"},"(",(0,ms.iW)(this.props.size),")"):null;this.props.uploading||this.state.downloader||!(0,Cs.QX)(this.props.downloadUrl)?(s=(0,Cs.oR)(this.props.downloadUrl),a=null):(s="#",a=e=>{e.preventDefault(),this.downloadFile(this.props.downloadUrl,this.props.filename,this.props.mimetype)});const o=t().createElement(t().Fragment,null,t().createElement("i",{className:"material-icons"},"file_download")," ",t().createElement(i.FormattedMessage,{id:"save_attachment",defaultMessage:"save",description:"Call to save an attachment"}));return t().createElement("div",{className:"attachment"},t().createElement("div",null,t().createElement("i",{className:"material-icons big gray"},"insert_drive_file")),t().createElement("div",{className:"flex-column"},t().createElement("div",null,e," ",n),this.props.uploading||this.state.downloader?t().createElement(vs,{progress:this.props.uploading?this.props.progress:this.state.progress,onCancel:this.handleCancel}):t().createElement("div",null,s?t().createElement("a",{href:s,download:this.props.filename,onClick:a},o):t().createElement("span",{className:"light-gray"},o))))}}const ki=(0,i.defineMessages)({message_sending:{id:"message_sending",defaultMessage:"sending...",description:"Message being sent, in place of time stamp"},message_sending_failed:{id:"message_sending_failed",defaultMessage:"failed",description:"Failed to send message, in place of time stamp"},message_edited_marker:{id:"message_edited_marker",defaultMessage:", edited",description:"Marker indicating that the message was edited"}});class Ai extends t().PureComponent{render(){const{formatMessage:e}=this.props.intl;let s;s=this.props.received<=ss.Tinode.MESSAGE_STATUS_SENDING?e(ki.message_sending):this.props.received==ss.Tinode.MESSAGE_STATUS_FAILED||this.props.received==ss.Tinode.MESSAGE_STATUS_FATAL?e(ki.message_sending_failed):this.props.timestamp.toLocaleTimeString(this.props.intl.locale,{timeStyle:"short"});const i=(0,Cs.Ut)(this.props.received),a=i?t().createElement("i",{className:"material-icons small "+i.color},i.name):null,n=this.props.edited?e(ki.message_edited_marker):null;return t().createElement("span",{className:"timestamp"},s,n," ",a)}}const Di=(0,i.injectIntl)(Ai);function Ni(){return Ni=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Ni.apply(this,arguments)}class Ii extends t().PureComponent{constructor(e){super(e),this.state={progress:0},e.uploader&&(e.uploader.onProgress=this.handleProgress.bind(this)),this.handleExpandImage=this.handleExpandImage.bind(this),this.handlePlayVideo=this.handlePlayVideo.bind(this),this.handleFormButtonClick=this.handleFormButtonClick.bind(this),this.handleContextClick=this.handleContextClick.bind(this),this.handleCancelUpload=this.handleCancelUpload.bind(this),this.handleQuoteClick=this.handleQuoteClick.bind(this),this.formatterContext={formatMessage:e.intl.formatMessage.bind(e.intl),viewportWidth:e.viewportWidth,authorizeURL:e.tinode.authorizeURL.bind(e.tinode),onImagePreview:this.handleExpandImage,onVideoPreview:this.handlePlayVideo,onFormButtonClick:this.handleFormButtonClick,onQuoteClick:this.handleQuoteClick}}handleExpandImage(e){e.preventDefault(),this.props.onExpandMedia({url:e.target.src,filename:e.target.dataset.name,width:e.target.dataset.width,height:e.target.dataset.height,size:e.target.dataset.size,type:e.target.dataset.mime})}handlePlayVideo(e){e.preventDefault(),this.props.onExpandMedia({video:!0,url:e.target.dataset.src,preview:e.target.src,filename:e.target.dataset.name,width:e.target.dataset.width,height:e.target.dataset.height,duration:e.target.dataset.duration,size:e.target.dataset.size,type:e.target.dataset.mime})}handleFormButtonClick(e){e.preventDefault();const t={seq:this.props.seq,resp:{}};e.target.dataset.name&&(t.resp[e.target.dataset.name]=e.target.dataset.val?e.target.dataset.val:void 0===e.target.dataset.val?1:""+e.target.dataset.val),"url"==e.target.dataset.act&&(t.ref=(0,Cs.oR)(e.target.dataset.ref)||"about:blank");const s=e.target.dataset.title||"unknown";this.props.onFormResponse(e.target.dataset.act,s,t)}handleContextClick(e){e.preventDefault(),e.stopPropagation();const t=[];if(this.props.received==ss.Tinode.MESSAGE_STATUS_FAILED&&t.push("menu_item_send_retry"),this.props.userIsWriter&&this.props.received>ss.Tinode.MESSAGE_STATUS_FATAL&&(t.push("menu_item_reply"),!this.props.response)){let e=!1;ss.Drafty.entities(this.props.content,((t,s,i)=>(e=["AU","EX","FM","IM","VC","VD"].includes(i),e))),e||ss.Drafty.styles(this.props.content,(t=>(e=["QQ"].includes(t),e))),e||t.push("menu_item_edit")}t.push("menu_item_forward"),this.props.showContextMenu({seq:this.props.seq,replace:this.props.edited?parseInt(this.props.edited.split(":")[1]):0,content:this.props.content,userFrom:this.props.userFrom,userName:this.props.userName,y:e.pageY,x:e.pageX,pickReply:this.props.pickReply,editMessage:this.props.editMessage},t)}handleProgress(e){this.setState({progress:e})}handleCancelUpload(){this.props.onCancelUpload(this.props.seq,this.props.uploader)}handleQuoteClick(e){e.preventDefault(),e.stopPropagation();const t=this.props.replyToSeq;t&&this.props.onQuoteClick(t)}render(){const e=this.props.sequence+" "+(this.props.response?"left":"right"),s="single"==this.props.sequence||"last"==this.props.sequence?"bubble tip":"bubble",a=this.props.userAvatar||!0,n=this.props.isGroup&&this.props.response&&("single"==this.props.sequence||"last"==this.props.sequence);let o=this.props.content;const r=[];if(this.props.mimeType==ss.Drafty.getContentType()&&ss.Drafty.isValid(o)){ss.Drafty.attachments(o,((e,s)=>{"application/json"!=e.mime&&r.push(t().createElement(Ti,{tinode:this.props.tinode,downloadUrl:ss.Drafty.getDownloadUrl(e),filename:e.name,uploading:ss.Drafty.isProcessing(e),mimetype:e.mime,size:ss.Drafty.getEntitySize(e),progress:this.state.progress,onCancelUpload:this.handleCancelUpload,onError:this.props.onError,key:s}))}),this);const e=ss.Drafty.format(o,ys,this.formatterContext);o=t().createElement(t().Fragment,null,e)}else"string"!=typeof o&&(o=t().createElement(t().Fragment,null,t().createElement("i",{className:"material-icons gray"},"warning_amber")," ",t().createElement("i",{className:"gray"},t().createElement(i.FormattedMessage,{id:"invalid_content",defaultMessage:"invalid content",description:"Shown when the message is unreadable"}))));return t().createElement("li",{ref:this.props.innerRef,className:e},this.props.isGroup&&this.props.response?t().createElement("div",{className:"avatar-box"},n?t().createElement(ds.c,{tinode:this.props.tinode,topic:this.props.userFrom,title:this.props.userName,avatar:a}):null):null,t().createElement("div",null,t().createElement("div",{className:s},t().createElement("div",{className:"content-meta"},t().createElement("div",{className:"message-content"},o,r),this.props.timestamp?t().createElement(Di,{edited:this.props.edited,timestamp:this.props.timestamp,received:this.props.received}):null),this.props.showContextMenu?t().createElement("span",{className:"menuTrigger"},t().createElement("a",{href:"#",onClick:this.handleContextClick},t().createElement("i",{className:"material-icons"},"expand_more"))):null),n?t().createElement("div",{className:"author"},this.props.userName||t().createElement("i",null,t().createElement(i.FormattedMessage,{id:"user_not_found",defaultMessage:"Not found",description:"In place of a user's full name when the user is not found."}))):null))}}const Pi=(0,i.injectIntl)(Ii),Ri=t().forwardRef(((e,s)=>t().createElement(Pi,Ni({innerRef:s},e)))),xi=t().lazy((e=>Promise.all([o.e(140),o.e(209)]).then(o.bind(o,7209)))),Fi=(0,i.defineMessages)({messaging_disabled:{id:"messaging_disabled_prompt",defaultMessage:"Messaging disabled",description:"Prompt in SendMessage in read-only topic"},type_new_message:{id:"new_message_prompt",defaultMessage:"New message",description:"Prompt in send message field"},add_image_caption:{id:"image_caption_prompt",defaultMessage:"Image caption",description:"Prompt in SendMessage for attached image"},file_attachment_too_large:{id:"file_attachment_too_large",defaultMessage:"The file size {size} exceeds the {limit} limit.",description:"Error message when attachment is too large"},cannot_initiate_upload:{id:"cannot_initiate_file_upload",defaultMessage:"Cannot initiate file upload.",description:"Generic error messagewhen attachment fails"},icon_title_record_voice:{id:"icon_title_record_voice",defaultMessage:"Record voice message",description:"Icon tool tip for recording a voice message"},icon_title_attach_file:{id:"icon_title_attach_file",defaultMessage:"Attach file",description:"Icon tool tip for attaching a file"},icon_title_add_image:{id:"icon_title_add_image",defaultMessage:"Add image",description:"Icon tool tip for attaching an image"},icon_title_send:{id:"icon_title_send",defaultMessage:"Send message",description:"Icon tool tip for sending a message"}});class Ui extends t().PureComponent{constructor(e){super(e),this.state={quote:null,message:"",audioRec:!1,audioAvailable:!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)},this.keypressTimestamp=0,this.handlePasteEvent=this.handlePasteEvent.bind(this),this.handleAttachImage=this.handleAttachImage.bind(this),this.handleAttachFile=this.handleAttachFile.bind(this),this.handleAttachAudio=this.handleAttachAudio.bind(this),this.handleSend=this.handleSend.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this),this.handleMessageTyping=this.handleMessageTyping.bind(this),this.handleDropAttach=this.handleDropAttach.bind(this),this.handleQuoteClick=this.handleQuoteClick.bind(this),this.formatReply=this.formatReply.bind(this)}componentDidMount(){this.messageEditArea&&(this.messageEditArea.addEventListener("paste",this.handlePasteEvent,!1),"all"==window.getComputedStyle(this.messageEditArea).getPropertyValue("transition-property")&&this.messageEditArea.focus()),this.setState({quote:this.formatReply()})}componentWillUnmount(){this.messageEditArea&&this.messageEditArea.removeEventListener("paste",this.handlePasteEvent,!1)}componentDidUpdate(e){if(this.messageEditArea&&("all"==window.getComputedStyle(this.messageEditArea).getPropertyValue("transition-property")&&this.messageEditArea.focus(),this.messageEditArea.style.height="0px",this.messageEditArea.style.height=this.messageEditArea.scrollHeight+"px"),e.topicName!=this.props.topicName)this.setState({message:this.props.initMessage||"",audioRec:!1,quote:null});else if(e.initMessage!=this.props.initMessage){const e=this.props.initMessage||"";this.setState({message:e},(t=>{this.messageEditArea.scrollTop=this.messageEditArea.scrollHeight,this.messageEditArea.setSelectionRange(e.length,e.length)}))}e.reply!=this.props.reply&&this.setState({quote:this.formatReply()})}formatReply(){return this.props.reply?ss.Drafty.format(this.props.reply.content,Is,{formatMessage:this.props.intl.formatMessage.bind(this.props.intl),authorizeURL:this.props.tinode.authorizeURL.bind(this.props.tinode)}):null}handlePasteEvent(e){this.props.disabled||(0,Es.Q3)(e,(e=>{this.props.onAttachImage(e)}),(e=>{this.props.onAttachFile(e)}),this.props.onError)&&e.preventDefault()}handleAttachImage(e){e.target.files&&e.target.files.length>0&&this.props.onAttachImage(e.target.files[0]),e.target.value=""}handleAttachFile(e){e.target.files&&e.target.files.length>0&&this.props.onAttachFile(e.target.files[0]),e.target.value=""}handleDropAttach(e){e&&e.length>0&&this.props.onAttachFile(e[0])}handleAttachAudio(e,t,s){this.setState({audioRec:!1}),this.props.onAttachAudio(e,t,s)}handleSend(e){e.preventDefault();const t=this.state.message.trim();(t||this.props.acceptBlank||this.props.noInput)&&(this.props.onSendMessage(t),this.setState({message:""}))}handleKeyPress(e){if(this.state.audioRec)return e.preventDefault(),void e.stopPropagation();"Enter"===e.key&&(e.shiftKey||(e.preventDefault(),e.stopPropagation(),this.handleSend(e)))}handleMessageTyping(e){if(this.setState({message:e.target.value}),this.props.onKeyPress){const e=(new Date).getTime();e-this.keypressTimestamp>as.mo&&(this.props.onKeyPress(),this.keypressTimestamp=e)}}handleQuoteClick(e){if(e.preventDefault(),e.stopPropagation(),this.props.reply&&this.props.onQuoteClick){const e=this.props.reply.seq;this.props.onQuoteClick(e)}}render(){const{formatMessage:s}=this.props.intl,a=this.props.disabled?s(Fi.messaging_disabled):this.props.messagePrompt?s(Fi[this.props.messagePrompt]):s(Fi.type_new_message),n=this.props.reply&&this.props.reply.editing?"check_circle":"send",o=this.state.quote?t().createElement("div",{id:"reply-quote-preview"},t().createElement("div",{className:"cancel"},t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onCancelReply()}},t().createElement("i",{className:"material-icons gray"},"close"))),this.state.quote):null,r=this.state.audioAvailable&&this.props.onAttachAudio;return t().createElement("div",{id:"send-message-wrapper"},this.props.noInput?null:o,t().createElement("div",{id:"send-message-panel"},this.props.disabled?t().createElement("div",{id:"writing-disabled"},a):t().createElement(t().Fragment,null,this.props.onAttachFile&&!this.state.audioRec?t().createElement(t().Fragment,null,t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.attachImage.click()},title:s(Fi.icon_title_add_image)},t().createElement("i",{className:"material-icons secondary"},"photo")),t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.attachFile.click()},title:s(Fi.icon_title_attach_file)},t().createElement("i",{className:"material-icons secondary"},"attach_file"))):null,this.props.noInput?o||t().createElement("div",{className:"hr thin"}):this.state.audioRec?t().createElement(e.Suspense,{fallback:t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"loading_note",defaultMessage:"Loading...",description:"Message shown when component is loading"}))},t().createElement(xi,{onRecordingProgress:e=>this.props.onKeyPress(!0),onDeleted:e=>this.setState({audioRec:!1}),onFinished:this.handleAttachAudio})):t().createElement("textarea",{id:"send-message-input",placeholder:a,value:this.state.message,onChange:this.handleMessageTyping,onKeyDown:this.handleKeyPress,ref:e=>{this.messageEditArea=e}}),this.state.message||!r?t().createElement("a",{href:"#",onClick:this.handleSend,title:s(Fi.icon_title_send)},t().createElement("i",{className:"material-icons"},n)):this.state.audioRec?null:t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.setState({audioRec:!0})},title:s(Fi.icon_title_record_voice)},t().createElement("i",{className:"material-icons"},"mic")),t().createElement("input",{type:"file",ref:e=>{this.attachFile=e},onChange:this.handleAttachFile,style:{display:"none"}}),t().createElement("input",{type:"file",ref:e=>{this.attachImage=e},accept:"image/*, video/*",onChange:this.handleAttachImage,style:{display:"none"}}))))}}const Li=(0,i.injectIntl)(Ui);class Oi extends t().PureComponent{constructor(e){super(e),this.handleSendDoc=this.handleSendDoc.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentDidMount(){document.addEventListener("keydown",this.handleKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){e.preventDefault(),"Escape"===e.key&&this.props.onClose()}handleSendDoc(e){this.props.onClose(),this.props.onSendMessage(this.props.content.file)}render(){return this.props.content?t().createElement("div",{id:"image-preview"},t().createElement("div",{id:"image-preview-caption-panel"},t().createElement("span",null,this.props.content.name),t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onClose()}},t().createElement("i",{className:"material-icons gray"},"close"))),t().createElement("div",{id:"image-preview-container"},t().createElement("div",{className:"flex-column narrow"},t().createElement("i",{className:"material-icons gray"},function(e){const t={default:"insert_drive_file",image:"image",text:"description",video:"theaters"};return t[e]||t[(e||"").split("/")[0]]||t.default}(this.props.content.type)),t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_file_name",defaultMessage:"File name:",description:"Label for a file name"}))," ",(0,ms.is)(this.props.content.name,24)||"-"),t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_content_type",defaultMessage:"Content type:",description:"Label for file content type (mime)"}))," ",this.props.content.type||"application/octet-stream"),t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_size",defaultMessage:"Size:",description:"Label for file size"}))," ",(0,ms.iW)(this.props.content.size)))),t().createElement(Li,{noInput:!0,tinode:this.props.tinode,reply:this.props.reply,onCancelReply:this.props.onCancelReply,onSendMessage:this.handleSendDoc,onError:this.props.onError})):null}}class Bi extends t().Component{constructor(e){super(e)}render(){const e=[],s=(this.props.subscribers||[]).length,a=Math.min(as.AP,s);return(this.props.subscribers||[]).some((s=>(e.push(t().createElement("div",{className:"avatar-box",key:s.user},t().createElement(ds.c,{tinode:this.props.tinode,topic:s.user,avatar:(0,Es.Qn)(s.public?s.public.photo:null)||!0,title:s.public?s.public.fn:null}))),e.length==a))),t().createElement("div",{id:"topic-users"},e," ",s>a?t().createElement("span",null,t().createElement(i.FormattedMessage,{id:"more_online_members",defaultMessage:"+{overflow} more",description:"Shown in MessagesView title bar when the number of online subscribers exceeds MAX_ONLINE_IN_TOPIC",values:{overflow:s-a}})):null)}}class qi extends t().PureComponent{constructor(e){super(e),this.state={width:0,height:0},this.handleSendImage=this.handleSendImage.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentDidMount(){document.addEventListener("keydown",this.handleKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){this.props.onSendMessage||(e.preventDefault(),"Escape"===e.key&&this.props.onClose())}assignWidth(e){if(e&&!this.state.width){const t=e.getBoundingClientRect();this.setState({width:0|t.width,height:0|t.height})}}handleSendImage(e){this.props.onClose(),this.props.onSendMessage(e,this.props.content.blob)}render(){if(!this.props.content)return null;const e=(0,Es.yg)(this.props.content.width,this.props.content.height,this.state.width,this.state.height,!1),s=e?{width:e.dstWidth+"px",height:e.dstHeight+"px"}:this.props.content.width>this.props.content.height?{width:"100%"}:{height:"100%"};s.maxWidth="100%",s.maxHeight="100%";const a=Math.max((this.state.width/as._0/1.5|0)-2,12),n=(0,ms.is)(this.props.content.filename,a)||"-",o=this.props.content.width||"-",r=this.props.content.height||"-",l=(0,Cs.WU)(this.props.content.url);return t().createElement("div",{id:"image-preview"},t().createElement("div",{id:"image-preview-caption-panel"},this.props.onSendMessage?t().createElement("span",null,n):t().createElement("a",{href:l,download:this.props.content.filename},t().createElement("i",{className:"material-icons"},"file_download")," ",t().createElement(i.FormattedMessage,{id:"download_action",defaultMessage:"download",description:"Call to action [download]"})),t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onClose()}},t().createElement("i",{className:"material-icons gray"},"close"))),t().createElement("div",{id:"image-preview-container",ref:e=>this.assignWidth(e)},t().createElement("img",{src:this.props.content.url,style:s,className:"image-preview",alt:this.props.content.filename})),this.props.onSendMessage?t().createElement(Li,{messagePrompt:"add_image_caption",acceptBlank:!0,tinode:this.props.tinode,reply:this.props.reply,onCancelReply:this.props.onCancelReply,onSendMessage:this.handleSendImage,onError:this.props.onError}):t().createElement("div",{id:"image-preview-footer"},t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_file_name",defaultMessage:"File name:",description:"Label for a file name"}))),t().createElement("div",null,t().createElement("span",{title:this.props.content.filename},n))),t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_content_type",defaultMessage:"Content type:",description:"Label for file content type (mime)"}))),t().createElement("div",null,this.props.content.type)),t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_size",defaultMessage:"Size:",description:"Label for file size"}))),t().createElement("div",null,o," × ",r," px; ",(0,ms.iW)(this.props.content.size)))))}}class ji extends t().PureComponent{constructor(e){super(e),this.handleButtonAction=this.handleButtonAction.bind(this)}handleButtonAction(e,t){e.preventDefault(),this.props.onAction(t)}render(){return t().createElement("div",{className:"accept-invite-panel"},t().createElement("div",{className:"title"},t().createElement(i.FormattedMessage,{id:"chat_invitation",defaultMessage:"You are invited to start a new chat. What would you like to do?",description:"New chat invitation message: [Accept] [Ignore] [Block]."})),t().createElement("div",{className:"footer"},t().createElement("button",{className:"primary",onClick:e=>{this.handleButtonAction(e,"accept")}},t().createElement(i.FormattedMessage,{id:"chat_invitation_accept",defaultMessage:"Accept",description:"Action [Accept] for chat invitation."})),t().createElement("button",{className:"secondary",onClick:e=>{this.handleButtonAction(e,"delete")}},t().createElement(i.FormattedMessage,{id:"chat_invitation_ignore",defaultMessage:"Ignore",description:"Action [Ignore] for chat invitation."})),t().createElement("button",{className:"secondary",onClick:e=>{this.handleButtonAction(e,"block")}},t().createElement(i.FormattedMessage,{id:"chat_invitation_block",defaultMessage:"Block",description:"Action [Block] for chat invitation."}))))}}var Vi=o(888);class Hi extends t().PureComponent{render(){as.Q5,ss.Tinode.getLibrary();return t().createElement("div",{id:"dummy-view"})}}class Wi extends t().PureComponent{constructor(e){super(e)}render(){let e=null,s="bubble";return this.props.date&&(e=t().createElement(t().Fragment,null,this.props.date),s+=" date"),e?t().createElement("li",{className:"meta"},t().createElement("div",{className:s},t().createElement("div",{className:"message-content"},e))):t().createElement(t().Fragment,null,null)}}const zi=(0,i.defineMessages)({unrecognized_video_format:{id:"unrecognized_video_format",defaultMessage:"Format of this video is not recognized",description:"Error message when uploaded video is invalid"}});class Ki extends t().PureComponent{constructor(e){super(e),this.videoRef=t().createRef(),this.handleSendVideo=this.handleSendVideo.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentDidMount(){document.addEventListener("keydown",this.handleKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){this.props.onSendMessage||(e.preventDefault(),"Escape"===e.key&&this.props.onClose())}handleSendVideo(e){this.props.onClose();const t={width:this.videoRef.current.videoWidth,height:this.videoRef.current.videoHeight,duration:1e3*this.videoRef.current.duration|0,mime:this.props.content.mime,name:this.props.content.filename};if(0==t.width||0==t.height)return void this.props.onError(this.props.intl.formatMessage(zi.unrecognized_video_format),"err");const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const i=s.getContext("2d");i.drawImage(this.videoRef.current,0,0,s.width,s.height),i.canvas.toBlob((s=>this.props.onSendMessage(e,this.props.content.blob,s,t)),"image/jpeg",.75)}render(){if(!this.props.content)return null;const e=this.props.content.width||"-",s=this.props.content.height||"-",a=this.props.onSendMessage?"nodownload":"",n=!this.props.onSendMessage;return t().createElement("div",{id:"image-preview"},t().createElement("div",{id:"image-preview-caption-panel"},t().createElement("span",null,this.props.content.filename),t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onClose()}},t().createElement("i",{className:"material-icons gray"},"close"))),t().createElement("div",{id:"image-preview-container"},t().createElement("video",{className:"image-preview",controls:!0,controlsList:a,disablePictureInPicture:!0,ref:this.videoRef,autoPlay:n,src:this.props.tinode.authorizeURL(this.props.content.url),poster:this.props.content.preview,alt:this.props.content.filename})),this.props.onSendMessage?t().createElement(Li,{messagePrompt:"add_image_caption",acceptBlank:!0,tinode:this.props.tinode,reply:this.props.reply,onCancelReply:this.props.onCancelReply,onSendMessage:this.handleSendVideo,onError:this.props.onError}):t().createElement("div",{id:"image-preview-footer"},t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_file_name",defaultMessage:"File name:",description:"Label for a file name"}))),t().createElement("div",null,t().createElement("span",{title:this.props.content.filename},this.props.content.filename))),t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_content_type",defaultMessage:"Content type:",description:"Label for file content type (mime)"}))),t().createElement("div",null,this.props.content.type)),t().createElement("div",null,t().createElement("div",null,t().createElement("b",null,t().createElement(i.FormattedMessage,{id:"label_size",defaultMessage:"Size:",description:"Label for file size"}))),t().createElement("div",null,e," × ",s," px; ",(0,ms.iW)(this.props.content.size)))))}}const Qi=(0,i.injectIntl)(Ki);var Gi=o(4652);const $i=(0,i.defineMessages)({online_now:{id:"online_now",defaultMessage:"online now",description:"Indicator that the user or topic is currently online"},last_seen:{id:"last_seen_timestamp",defaultMessage:"Last seen",description:"Label for the timestamp of when the user or topic was last online"},not_found:{id:"title_not_found",defaultMessage:"Not found",description:"Title shown when topic is not found"},channel:{id:"channel",defaultMessage:"channel",description:"Subtitle shown for channels in MessagesView instead of last seen"},file_attachment_too_large:{id:"file_attachment_too_large",defaultMessage:"The file size {size} exceeds the {limit} limit.",description:"Error message when attachment is too large"},invalid_content:{id:"invalid_content",defaultMessage:"invalid content",description:"Shown when the message is unreadable"},editing_message:{id:"editing_message",defaultMessage:"Editing",description:"Title over message editing preview"},drag_file:{id:"drag_file",defaultMessage:"Drag file here",description:"Prompt on the file drag-n-drop overlay banner"}});function Yi(e){if(e){const t=e.getExcessive()||"";return e.isJoiner("given")&&(t.includes("R")||t.includes("W"))}return!1}function Xi(e){if(e){const t=e.getMissing()||"";return e.isJoiner("want")&&(t.includes("R")||t.includes("W"))}return!1}function Ji(e){return 1==e||3==e}class Zi extends t().Component{constructor(e){super(e),this.state=Zi.getDerivedStateFromProps(e,{}),this.componentSetup=this.componentSetup.bind(this),this.leave=this.leave.bind(this),this.sendMessage=this.sendMessage.bind(this),this.retrySend=this.retrySend.bind(this),this.sendImageAttachment=this.sendImageAttachment.bind(this),this.sendVideoAttachment=this.sendVideoAttachment.bind(this),this.sendFileAttachment=this.sendFileAttachment.bind(this),this.sendAudioAttachment=this.sendAudioAttachment.bind(this),this.sendKeyPress=this.sendKeyPress.bind(this),this.subscribe=this.subscribe.bind(this),this.handleScrollReference=this.handleScrollReference.bind(this),this.mountDnDEvents=this.mountDnDEvents.bind(this),this.handleScrollEvent=this.handleScrollEvent.bind(this),this.handleDescChange=this.handleDescChange.bind(this),this.handleSubsUpdated=this.handleSubsUpdated.bind(this),this.handleMessageUpdate=this.handleMessageUpdate.bind(this),this.handleAllMessagesReceived=this.handleAllMessagesReceived.bind(this),this.handleInfoReceipt=this.handleInfoReceipt.bind(this),this.handleExpandMedia=this.handleExpandMedia.bind(this),this.handleClosePreview=this.handleClosePreview.bind(this),this.handleFormResponse=this.handleFormResponse.bind(this),this.handleContextClick=this.handleContextClick.bind(this),this.handleShowMessageContextMenu=this.handleShowMessageContextMenu.bind(this),this.handleNewChatAcceptance=this.handleNewChatAcceptance.bind(this),this.handleEnablePeer=this.handleEnablePeer.bind(this),this.handleAttachFile=this.handleAttachFile.bind(this),this.handleAttachImageOrVideo=this.handleAttachImageOrVideo.bind(this),this.handleCancelUpload=this.handleCancelUpload.bind(this),this.postReadNotification=this.postReadNotification.bind(this),this.clearNotificationQueue=this.clearNotificationQueue.bind(this),this.goToLatestMessage=this.goToLatestMessage.bind(this),this.handleFileDrop=this.handleFileDrop.bind(this),this.handlePickReply=this.handlePickReply.bind(this),this.handleEditMessage=this.handleEditMessage.bind(this),this.handleCancelReply=this.handleCancelReply.bind(this),this.handleQuoteClick=this.handleQuoteClick.bind(this),this.handleCallHangup=this.handleCallHangup.bind(this),this.isDragEnabled=this.isDragEnabled.bind(this),this.handleDragStart=this.handleDragStart.bind(this),this.handleDragIn=this.handleDragIn.bind(this),this.handleDragOut=this.handleDragOut.bind(this),this.handleDrag=this.handleDrag.bind(this),this.handleDrop=this.handleDrop.bind(this),this.chatMessageRefs={},this.getOrCreateMessageRef=this.getOrCreateMessageRef.bind(this),this.dragCounter=0,this.dndRef=null,this.readNotificationQueue=[],this.readNotificationTimer=null,this.keyPressTimer=null}getOrCreateMessageRef(e){if(this.chatMessageRefs.hasOwnProperty(e))return this.chatMessageRefs[e];const s=t().createRef();return this.chatMessageRefs[e]=s,s}componentDidMount(){this.messagesScroller&&this.messagesScroller.addEventListener("scroll",this.handleScrollEvent),this.mountDnDEvents(this.dndRef),this.componentSetup({},{})}componentWillUnmount(){this.messagesScroller&&this.messagesScroller.removeEventListener("scroll",this.handleScrollEvent),this.clearNotificationQueue(),this.dndRef&&(this.dndRef.removeEventListener("dragstart",this.handleDragStart),this.dndRef.removeEventListener("dragenter",this.handleDragIn),this.dndRef.removeEventListener("dragleave",this.handleDragOut),this.dndRef.removeEventListener("dragover",this.handleDrag),this.dndRef.removeEventListener("drop",this.handleDrop))}componentDidUpdate(e,t){!this.messagesScroller||t.topic==this.state.topic&&t.maxSeqId==this.state.maxSeqId&&t.minSeqId==this.state.minSeqId||this.state.scrollPosition<100&&(this.messagesScroller.scrollTop=this.messagesScroller.scrollHeight-this.state.scrollPosition-this.messagesScroller.offsetHeight),this.props.applicationVisible?this.postReadNotification(0):this.clearNotificationQueue(),this.componentSetup(e,t)}componentSetup(e,t){const s=this.props.tinode?this.props.tinode.getTopic(this.state.topic):void 0;if(this.state.topic!=t.topic&&(t.topic&&!ss.Tinode.isNewGroupTopicName(t.topic)&&(this.leave(t.topic),t.rtcPanel&&this.handleCallHangup(t.topic,e.callSeq)),s&&(s.onData=this.handleMessageUpdate,s.onAllMessagesReceived=this.handleAllMessagesReceived,s.onInfo=this.handleInfoReceipt,s.onMetaDesc=this.handleDescChange,s.onSubsUpdated=this.handleSubsUpdated,s.onPres=this.handleSubsUpdated)),s)if(this.state.topic!=t.topic||this.props.myUserId&&!e.myUserId){const e=this.props.newTopicParams&&this.props.newTopicParams._topicName==this.props.topic;s.isP2PType()&&e&&!as.Ae?s.getMeta(s.startMetaQuery().withDesc().build()):this.props.myUserId&&this.subscribe(s)}else s.isSubscribed()&&this.state.isReader&&!t.isReader&&s.getMeta(s.startMetaQuery().withLaterData().build())}static getDerivedStateFromProps(e,t){let s={};if(e.topic)if(e.topic!=t.topic){const i=e.tinode.getTopic(e.topic);if(s={topic:e.topic,deleted:i._deleted,docPreview:null,imagePreview:null,imagePostview:null,videoPreview:null,videoPostview:null,rtcPanel:null,typingIndicator:!1,scrollPosition:0,fetchingMessages:!1,showGoToLastButton:!1,contentToEdit:null,dragging:!1},e.forwardMessage?s.reply={content:e.forwardMessage.preview,seq:null}:s.reply=null,i){const a=[];e.connected&&i.subscribers((t=>{t.online&&t.user!=e.myUserId&&a.push(t)})),Object.assign(s,{onlineSubs:a}),i.public?Object.assign(s,{title:i.public.fn,avatar:(0,Es.Qn)(i.public.photo)}):Object.assign(s,{title:"",avatar:null});const n=i.p2pPeerDesc();n?Object.assign(s,{peerMessagingDisabled:Xi(n.acs)}):t.peerMessagingDisabled&&Object.assign(s,{peerMessagingDisabled:!1}),Object.assign(s,{minSeqId:i.minMsgSeq(),maxSeqId:i.maxMsgSeq(),latestClearId:i.maxClearId(),channel:i.isChannelType()}),e.callTopic==i.name&&Ji(e.callState)&&(s.rtcPanel=e.callTopic)}else Object.assign(s,{minSeqId:-1,maxSeqId:-1,latestClearId:-1,onlineSubs:[],title:"",avatar:null,peerMessagingDisabled:!1,channel:!1})}else e.callTopic==t.topic&&!t.rtcPanel&&Ji(e.callState)&&(s.rtcPanel=e.callTopic);else s={minSeqId:-1,maxSeqId:-1,latestClearId:-1,onlineSubs:[],topic:null,title:"",avatar:null,isVerified:!1,isStaff:!1,isDangerous:!1,deleted:!1,docPreview:null,imagePreview:null,imagePostview:null,videoPreview:null,videoPostview:null,rtcPanel:null,typingIndicator:!1,scrollPosition:0,fetchingMessages:!1,peerMessagingDisabled:!1,channel:!1,reply:null,contentToEdit:null,showGoToLastButton:!1,dragging:!1,subsVersion:0};return e.acs?(e.acs.isWriter()!=t.isWriter&&(s.isWriter=!t.isWriter),e.acs.isReader()!=t.isReader&&(s.isReader=!t.isReader),!e.acs.isReader("given")!=t.readingBlocked&&(s.readingBlocked=!t.readingBlocked),e.acs.isSharer()!=t.isSharer&&(s.isSharer=!t.isSharer)):(t.isWriter&&(s.isWriter=!1),t.isReader&&(s.isReader=!1),t.readingBlocked||(t.readingBlocked=!0),t.isSharer&&(s.isSharer=!1)),Yi(e.acs)==!t.unconformed&&(s.unconfirmed=!t.unconformed),!e.connected&&t.onlineSubs&&t.onlineSubs.length>0&&(s.onlineSubs=[]),s}subscribe(e){if(e.isSubscribed()||!this.props.ready)return;const t=this.props.newTopicParams&&this.props.newTopicParams._topicName==this.props.topic;let s=e.startMetaQuery().withLaterDesc().withLaterSub();(this.state.isReader||t)&&(s=s.withLaterData(as.mM),this.state.isReader&&(s=s.withLaterDel()),this.setState({fetchingMessages:!0}));const i=t?this.props.newTopicParams:void 0;e.subscribe(s.build(),i).then((t=>{if(303==t.code)return void Gi.c.navigateTo(Gi.c.setUrlTopic("",t.params.topic));this.state.topic!=t.topic&&this.setState({topic:t.topic}),this.state.deleted&&this.setState({deleted:!1}),this.props.onNewTopicCreated(this.props.topic,t.topic);let s=[];e.queuedMessages((t=>{t._sending||(t._fatal||t.head&&t.head.webrtc?s.push(t.seq):e.isSubscribed()&&this.retrySend(t))})),s.length>0&&e.delMessagesList(s,!0)})).catch((e=>{console.error("Failed subscription to",this.state.topic,e),this.props.onError(e.message,"err");const t=Zi.getDerivedStateFromProps({},{});t.title=this.props.intl.formatMessage($i.not_found),this.setState(t)}))}leave(e){if(!e||!this.props.tinode.isTopicCached(e))return;const t=this.props.tinode.getTopic(e);t&&t.isSubscribed()&&t.leave(!1).catch((e=>{})).finally((e=>{this.setState({fetchingMessages:!1}),t.onData=void 0,t.onAllMessagesReceived=void 0,t.onInfo=void 0,t.onMetaDesc=void 0,t.onSubsUpdated=void 0,t.onPres=void 0}))}handleScrollReference(e){e&&(e.addEventListener("scroll",this.handleScrollEvent),this.messagesScroller=e,this.messagesScroller.scrollTop=this.messagesScroller.scrollHeight-this.state.scrollPosition-this.messagesScroller.offsetHeight)}handleScrollEvent(e){const t=e.target.scrollHeight-e.target.scrollTop-e.target.offsetHeight;if(this.setState({scrollPosition:t,showGoToLastButton:t>100&&t<this.state.scrollPosition}),!this.state.fetchingMessages&&e.target.scrollTop<=40){const e=this.props.tinode.getTopic(this.state.topic);e&&e.isSubscribed()&&e.msgHasMoreMessages()&&this.setState({fetchingMessages:!0},(t=>{e.getMessagesPage(as.mM).catch((e=>this.props.onError(e.message,"err"))).finally((e=>this.setState({fetchingMessages:!1})))}))}}mountDnDEvents(e){e&&(e.addEventListener("dragstart",this.handleDragStart),e.addEventListener("dragenter",this.handleDragIn),e.addEventListener("dragleave",this.handleDragOut),e.addEventListener("dragover",this.handleDrag),e.addEventListener("drop",this.handleDrop),this.dndRef=e)}goToLatestMessage(){this.setState({scrollPosition:0}),this.messagesScroller&&(this.messagesScroller.scrollTop=this.messagesScroller.scrollHeight-this.messagesScroller.offsetHeight)}handleDescChange(e){e.public?this.setState({title:e.public.fn,avatar:(0,Es.Qn)(e.public.photo)}):this.setState({title:"",avatar:null}),e.acs&&this.setState({isWriter:e.acs.isWriter(),isReader:e.acs.isReader(),readingBlocked:!e.acs.isReader("given"),unconfirmed:Yi(e.acs)})}postReadNotification(e){if(!this.props.applicationVisible)return;this.readNotificationTimer||(this.readNotificationTimer=setInterval((e=>{if(0==this.readNotificationQueue.length)return clearInterval(this.readNotificationTimer),void(this.readNotificationTimer=null);let t=-1;for(;this.readNotificationQueue.length>0;){const e=this.readNotificationQueue[0];if(e.topicName!=this.state.topic){this.readNotificationQueue.shift();continue}const s=new Date;if(!(e.sendAt<=s))break;this.readNotificationQueue.shift(),t=Math.max(t,e.seq)}if(t>=0){const e=this.props.tinode.getTopic(this.state.topic);e&&e.noteRead(t)}}),300));const t=new Date;this.readNotificationQueue.push({topicName:this.state.topic,seq:e,sendAt:t.setMilliseconds(t.getMilliseconds()+as.OI)})}clearNotificationQueue(){this.readNotificationQueue=[],this.readNotificationTimer&&(clearInterval(this.readNotificationTimer),this.readNotificationTimer=null)}handleSubsUpdated(){if(this.state.topic){const e=[],t=this.props.tinode.getTopic(this.state.topic);t.subscribers((t=>{t.online&&t.user!=this.props.myUserId&&e.push(t)}));const s={onlineSubs:e,subsVersion:this.state.subsVersion+1},i=t.p2pPeerDesc();i?Object.assign(s,{peerMessagingDisabled:Xi(i.acs)}):this.state.peerMessagingDisabled&&Object.assign(s,{peerMessagingDisabled:!1}),this.setState(s)}}handleMessageUpdate(e){if(!this.state.topic)return;const t=this.props.tinode.getTopic(this.state.topic);if(!e)return void this.setState({latestClearId:t.maxClearId()});clearTimeout(this.keyPressTimer),this.setState({maxSeqId:t.maxMsgSeq(),minSeqId:t.minMsgSeq(),typingIndicator:!1},(s=>{t.isNewMessage(e.seq)?this.state.scrollPosition>100?this.setState({showGoToLastButton:!0}):this.goToLatestMessage():this.messagesScroller&&(this.messagesScroller.scrollTop=this.messagesScroller.scrollHeight-this.state.scrollPosition-this.messagesScroller.offsetHeight)}));t.msgStatus(e,!0)>=ss.Tinode.MESSAGE_STATUS_SENT&&e.from!=this.props.myUserId&&this.postReadNotification(e.seq)}handleAllMessagesReceived(e){this.setState({fetchingMessages:!1}),e>0&&this.postReadNotification(0)}handleInfoReceipt(e){switch(e.what){case"kp":clearTimeout(this.keyPressTimer),this.keyPressTimer=setTimeout((e=>this.setState({typingIndicator:!1})),as.mo+1e3),this.state.typingIndicator||this.setState({typingIndicator:!0});break;case"read":case"recv":this.forceUpdate();break;default:console.info("Other change in topic: ",e.what)}}handleExpandMedia(e){e&&(e.video?this.setState({videoPostview:e}):this.setState({imagePostview:e}))}handleClosePreview(){this.state.imagePreview&&this.state.imagePreview.url&&URL.revokeObjectURL(this.state.imagePreview.url),this.state.videoPreview&&this.state.videoPreview.url&&URL.revokeObjectURL(this.state.videoPreview.url),this.setState({imagePostview:null,imagePreview:null,docPreview:null,videoPreview:null,videoPostview:null})}handleFormResponse(e,t,s){if("pub"==e)this.sendMessage(ss.Drafty.attachJSON(ss.Drafty.parse(t),s));else if("url"==e){const e=new URL(s.ref),t=e.searchParams;for(let e in s.resp)s.resp.hasOwnProperty(e)&&t.set(e,s.resp[e]);["name","seq"].map((e=>{s[e]&&t.set(e,s[e])})),t.set("uid",this.props.myUserId),t.set("topic",this.state.topic),e.search=t,window.open(e,"_blank")}else console.info("Unknown action in form",e)}handleContextClick(e){e.preventDefault(),e.stopPropagation(),this.props.showContextMenu({topicName:this.state.topic,y:e.pageY,x:e.pageX})}handleShowMessageContextMenu(e,t){"chan"==e.userFrom&&(e.userFrom=this.state.topic,e.userName=this.state.title),e.topicName=this.state.topic;const s=t||[],i=this.props.tinode.getTopic(e.topicName);if(i){i.isChannelType()||s.push("message_delete");const e=i.getAccessMode();e&&e.isDeleter()&&s.push("message_delete_hard")}this.props.showContextMenu(e,s)}handleNewChatAcceptance(e){this.props.onNewChat(this.state.topic,e)}handleEnablePeer(e){e.preventDefault(),this.props.onChangePermissions(this.state.topic,as.uU,this.state.topic)}sendKeyPress(e){const t=this.props.tinode.getTopic(this.state.topic);t.isSubscribed()&&(e?t.noteRecording(!0):t.noteKeyPress())}sendMessage(e,t,s){let i;if(this.props.forwardMessage)e=this.props.forwardMessage.msg,i=this.props.forwardMessage.head,this.handleCancelReply();else if(this.state.reply){if(this.state.reply.editing){if(e==this.state.contentToEdit)return void this.handleCancelReply();i={replace:":"+this.state.reply.seq}}else this.state.reply.content&&(i={reply:""+this.state.reply.seq},"string"==typeof e&&(e=ss.Drafty.parse(e)),e=ss.Drafty.append(ss.Drafty.sanitizeEntities(this.state.reply.content),e));this.handleCancelReply()}this.props.sendMessage(e,t,s,i)}retrySend(e){this.props.sendMessage(e.content,void 0,void 0,e.head).then((t=>{this.props.tinode.getTopic(this.state.topic).delMessagesList([e.seq],!0)}))}sendFileAttachment(e){const t=.75*this.props.tinode.getServerParam("maxMessageSize",as.wx)-1024|0;if(e.size>t){const t=this.props.tinode.getLargeFileHelper();if(!t)return void this.props.onError(this.props.intl.formatMessage($i.cannot_initiate_upload));const s=t.upload(e),i=ss.Drafty.attachFile(null,{mime:e.type,filename:e.name,size:e.size,urlPromise:s});this.sendMessage(i,s,t)}else(0,Es.E9)(e).then((t=>this.sendMessage(ss.Drafty.attachFile(null,{mime:t.mime,data:t.bits,filename:t.name,size:e.size})))).catch((e=>this.props.onError(e.message,"err")))}handleAttachFile(e){const t=this.props.tinode.getServerParam("maxFileUploadSize",as._c);e.size>t?this.props.onError(this.props.intl.formatMessage($i.file_attachment_too_large,{size:(0,ms.iW)(e.size),limit:(0,ms.iW)(t)}),"err"):this.setState({docPreview:{file:e,name:e.name,size:e.size,type:e.type}})}handleCallHangup(e,t){this.props.onVideoCallClosed(),this.setState({rtcPanel:null}),this.props.onCallHangup(e,t)}sendImageAttachment(e,t){const s=this.state.imagePreview.mime,i=this.state.imagePreview.width,a=this.state.imagePreview.height,n=this.state.imagePreview.filename,o=.75*this.props.tinode.getServerParam("maxMessageSize",as.wx)-1024|0;if(t.size>o){const o=this.props.tinode.getLargeFileHelper();if(!o)return void this.props.onError(this.props.intl.formatMessage($i.cannot_initiate_upload));const r=o.upload(t);(0,Es._k)(t,as.y2,as.y2,-1,!1).then((e=>(0,Es._K)(e.blob))).then((l=>{let c=ss.Drafty.insertImage(null,0,{mime:s,_tempPreview:l.bits,bits:l.bits,width:i,height:a,filename:n,size:t.size,urlPromise:r});e&&(c=ss.Drafty.appendLineBreak(c),c=ss.Drafty.append(c,ss.Drafty.parse(e))),this.sendMessage(c,r,o)})).catch((e=>this.props.onError(e,"err")))}else(0,Es._K)(t).then((s=>{let o=ss.Drafty.insertImage(null,0,{mime:s.mime,bits:s.bits,width:i,height:a,filename:n,size:t.size});e&&(o=ss.Drafty.appendLineBreak(o),o=ss.Drafty.append(o,ss.Drafty.parse(e))),this.sendMessage(o)}))}sendVideoAttachment(e,t,s,i){const a=i.width,n=i.height,o=.75*this.props.tinode.getServerParam("maxMessageSize",as.wx)-1024|0,r=[];let l;if(t.size+s.size>o){if(l=this.props.tinode.getLargeFileHelper(),!l)return void this.props.onError(this.props.intl.formatMessage($i.cannot_initiate_upload));r[0]=t.size>.675*o?l.upload(t):null,r[1]=s.size>.275*o?l.upload(s):null}if(0==r.length)return void Promise.all([(0,Es._K)(t),(0,Es._K)(s)]).then((s=>{const[o,r]=s;let l=ss.Drafty.insertVideo(null,0,{mime:o.mime,bits:o.bits,preview:r.bits,premime:r.mime,width:a,height:n,duration:i.duration,filename:i.name,size:t.size});e&&(l=ss.Drafty.appendLineBreak(l),l=ss.Drafty.append(l,ss.Drafty.parse(e))),this.sendMessage(l)}));const c=Promise.all(r),d=[];d[0]=r[0]?null:(0,Es._K)(t),d[1]=r[1]?null:(0,Es._k)(s,as.g7,as.g7,-1,!1).then((e=>(0,Es._K)(e.blob))),d[2]=(0,Es._k)(s,as.KG,as.KG,-1,!1).then((e=>(0,Es._K)(e.blob))),Promise.all(d).then((s=>{const[o,r,d]=s;let h=ss.Drafty.insertVideo(null,0,{mime:i.mime,bits:o?o.bits:null,_tempPreview:d.bits,preview:r?r.bits:d.bits,premime:r?r.mime:d.mime,width:a,height:n,duration:i.duration,filename:i.name,size:t.size,urlPromise:c});e&&(h=ss.Drafty.appendLineBreak(h),h=ss.Drafty.append(h,ss.Drafty.parse(e))),this.sendMessage(h,c,l)})).catch((e=>this.props.onError(e.message,"err")))}handleAttachImageOrVideo(e){const t=this.props.tinode.getServerParam("maxFileUploadSize",as._c);e.type.startsWith("video/")?this.setState({videoPreview:{url:URL.createObjectURL(e),blob:e,filename:e.name,size:e.size,mime:e.type}}):(0,Es._k)(e,as.g7,as.g7,t,!1).then((e=>{this.setState({imagePreview:{url:URL.createObjectURL(e.blob),blob:e.blob,filename:e.name,width:e.width,height:e.height,size:e.blob.size,mime:e.mime}})})).catch((e=>{this.props.onError(e.message,"err")}))}handleFileDrop(e){if(!e||0==e.length)return;const t=e[0];t.type&&t.type.startsWith("image/")?this.handleAttachImageOrVideo(t):this.handleAttachFile(t)}sendAudioAttachment(e,t,s){fetch(e).then((e=>e.blob())).then((e=>{const i=.75*this.props.tinode.getServerParam("maxMessageSize",as.wx)-1024;if(e.size>i){const i=this.props.tinode.getLargeFileHelper();if(!i)return void this.props.onError(this.props.intl.formatMessage($i.cannot_initiate_upload));const a=i.upload(e),n=ss.Drafty.appendAudio(null,{mime:e.type,size:e.size,duration:s,preview:t,urlPromise:a});this.sendMessage(n,a,i)}else(0,Es._K)(e).then((i=>{this.sendMessage(ss.Drafty.appendAudio(null,{mime:i.mime,bits:i.bits,size:e.size,duration:s,preview:t}))}))})).catch((e=>{this.props.onError(e.message,"err")}))}handleCancelUpload(e,t){const s=this.props.tinode.getTopic(this.state.topic).findMessage(e);s&&(s._cancelled=!0),t.cancel()}handlePickReply(e,t,s,i){e&&t?(t="string"==typeof t?ss.Drafty.init(t):t,t=ss.Drafty.isValid(t)?ss.Drafty.replyContent(t,as.yE):ss.Drafty.append(ss.Drafty.init("⚠ "),ss.Drafty.wrapInto(this.props.intl.formatMessage($i.invalid_content),"EM")),this.setState({reply:{content:ss.Drafty.quote(i,s,t),seq:e}}),this.props.onCancelForwardMessage()):this.setState({reply:null})}handleEditMessage(e,t){if(!e||!t)return void this.setState({reply:null});t="string"==typeof t?ss.Drafty.init(t):t;const s=ss.Drafty.toMarkdown(t);t=ss.Drafty.isValid(t)?ss.Drafty.replyContent(t,as.UF):ss.Drafty.append(ss.Drafty.init("⚠ "),ss.Drafty.wrapInto(this.props.intl.formatMessage($i.invalid_content),"EM")),this.setState({reply:{content:ss.Drafty.quote(this.props.intl.formatMessage($i.editing_message),null,t),seq:e,editing:!0},contentToEdit:s}),this.props.onCancelForwardMessage()}handleCancelReply(){this.setState({reply:null,contentToEdit:null}),this.props.onCancelForwardMessage()}handleQuoteClick(e){const t=this.getOrCreateMessageRef(e);t&&t.current?(t.current.scrollIntoView({block:"center",behavior:"smooth"}),t.current.classList.add("flash"),setTimeout((e=>{t.current.classList.remove("flash")}),1e3)):console.error("Unresolved message ref",e)}isDragEnabled(){return this.state.isWriter&&!this.state.unconfirmed&&!this.props.forwardMessage&&!this.state.peerMessagingDisabled}handleDragStart(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer.clearData()}handleDragIn(e){e.preventDefault(),e.stopPropagation(),this.dragCounter++,e.dataTransfer.items&&e.dataTransfer.items.length>0&&this.setState({dragging:!0})}handleDragOut(e){e.preventDefault(),e.stopPropagation(),this.dragCounter--,this.dragCounter<=0&&this.setState({dragging:!1})}handleDrag(e){e.preventDefault(),e.stopPropagation()}handleDrop(e){e.preventDefault(),e.stopPropagation(),this.setState({dragging:!1}),this.isDragEnabled()&&e.dataTransfer.files&&e.dataTransfer.files.length>0&&(this.handleFileDrop(e.dataTransfer.files),this.dragCounter=0)}render(){const{formatMessage:e}=this.props.intl;let s;if(this.state.topic){let a;if(this.state.imagePreview)a=t().createElement(qi,{content:this.state.imagePreview,tinode:this.props.tinode,reply:this.state.reply,onCancelReply:this.handleCancelReply,onClose:this.handleClosePreview,onSendMessage:this.sendImageAttachment});else if(this.state.videoPreview)a=t().createElement(Qi,{content:this.state.videoPreview,tinode:this.props.tinode,reply:this.state.reply,onError:this.props.onError,onCancelReply:this.handleCancelReply,onClose:this.handleClosePreview,onSendMessage:this.sendVideoAttachment});else if(this.state.imagePostview)a=t().createElement(qi,{content:this.state.imagePostview,onClose:this.handleClosePreview});else if(this.state.videoPostview)a=t().createElement(Qi,{content:this.state.videoPostview,tinode:this.props.tinode,onError:this.props.onError,onClose:this.handleClosePreview});else if(this.state.docPreview)a=t().createElement(Oi,{content:this.state.docPreview,tinode:this.props.tinode,reply:this.state.reply,onCancelReply:this.handleCancelReply,onClose:this.handleClosePreview,onSendMessage:this.sendFileAttachment});else if(this.state.rtcPanel)a=t().createElement(_i,{topic:this.state.topic,seq:this.props.callSeq,callState:this.props.callState,callAudioOnly:this.props.callAudioOnly,tinode:this.props.tinode,title:this.state.title,avatar:this.state.avatar||!0,onError:this.props.onError,onHangup:this.handleCallHangup,onInvite:this.props.onCallInvite,onSendOffer:this.props.onCallSendOffer,onIceCandidate:this.props.onCallIceCandidate,onSendAnswer:this.props.onCallSendAnswer});else{const s=this.props.tinode.getTopic(this.state.topic),n=s.isChannelType(),o=s.isGroupType()&&!n,r=[];s.trusted&&(s.trusted.verified&&r.push({icon:"verified",color:"badge-inv"}),s.trusted.staff&&r.push({icon:"staff",color:"badge-inv"}),s.trusted.danger&&r.push({icon:"dangerous",color:"badge-inv"}));const l=[];let c=null,d=null,h=null;s.messages(((e,i,a,n)=>{let r=a?a.from||"chan":null,p="single",m=e.from||"chan";m==c?p=m==r?"middle":"last":m==r&&(p="first"),c=m;const u=!(m==this.props.myUserId),g=s.msgStatus(e,!0);let f,b,v=m;const w=s.userDesc(m);w&&w.public&&(f=w.public.fn,b=(0,Es.Qn)(w.public.photo)),h=o?"chat-box group":"chat-box";const E=this.getOrCreateMessageRef(e.seq);let C=e.head?parseInt(e.head.reply):null;if(C&&!isNaN(C)||(C=null),e.hi)l.push(t().createElement(Wi,{deleted:!0,key:e.seq}));else{const s=new Date(e.ts);d&&d.toDateString()==s.toDateString()||(l.push(t().createElement(Wi,{date:(0,ms.qM)(e.ts),locale:this.props.intl.locale,key:"date-"+e.seq})),d=s),l.push(t().createElement(Ri,{tinode:this.props.tinode,content:e.content,mimeType:e.head&&e.head.mime,replyToSeq:C,edited:e.head&&!e.head.webrtc&&e.head.replace,timestamp:e.ts,response:u,seq:e.seq,isGroup:o,isChan:this.state.channel,userFrom:v,userName:f,userAvatar:b,sequence:p,received:g,uploader:e._uploader,userIsWriter:this.state.isWriter,viewportWidth:this.props.viewportWidth,showContextMenu:this.handleShowMessageContextMenu,onExpandMedia:this.handleExpandMedia,onFormResponse:this.handleFormResponse,onCancelUpload:this.handleCancelUpload,pickReply:this.handlePickReply,editMessage:this.handleEditMessage,onQuoteClick:this.handleQuoteClick,onError:this.props.onError,ref:E,key:e.seq}))}}));let p=null;if(n)p=e($i.channel);else{const t=this.props.tinode.getMeTopic().getContact(this.state.topic);t&&ss.Tinode.isP2PTopicName(t.topic)&&(t.online?p=e($i.online_now):t.seen&&(p=e($i.last_seen)+": "+(0,ms.SO)(t.seen.when,this.props.intl.locale)))}const m=this.state.avatar||!0,u=this.state.deleted?null:this.props.online?"online"+(this.state.typingIndicator?" typing":""):"offline",g="panel-title"+(this.state.deleted?" deleted":"");let f=t().createElement(t().Fragment,null,t().createElement("div",{id:"messages-container"},t().createElement("button",{className:"action-button"+(this.state.showGoToLastButton?"":" hidden"),onClick:this.goToLatestMessage},t().createElement("i",{className:"material-icons"},"arrow_downward")),t().createElement("div",{id:"messages-panel",ref:this.handleScrollReference},t().createElement("ul",{id:"scroller",className:h},l)),this.state.isReader?null:t().createElement("div",{id:"write-only-background"},this.state.readingBlocked?t().createElement("div",{id:"write-only-note"},t().createElement(i.FormattedMessage,{id:"messages_not_readable",defaultMessage:"no access to messages",description:"Message shown in topic without the read access"})):null)),this.state.peerMessagingDisabled&&!this.state.unconfirmed?t().createElement("div",{id:"peer-messaging-disabled-note"},t().createElement("i",{className:"material-icons secondary"},"block")," ",t().createElement(i.FormattedMessage,{id:"peers_messaging_disabled",defaultMessage:"Peer's messaging is disabled.",description:"Shown when the p2p peer's messaging is disabled"})," ",t().createElement("a",{href:"#",onClick:this.handleEnablePeer},t().createElement(i.FormattedMessage,{id:"enable_peers_messaging",defaultMessage:"Enable",description:"Call to action to enable peer's messaging"})),"."):null,this.state.unconfirmed?t().createElement(ji,{onAction:this.handleNewChatAcceptance}):t().createElement(Li,{tinode:this.props.tinode,topicName:this.state.topic,noInput:!!this.props.forwardMessage,disabled:!this.state.isWriter||this.state.deleted,reply:this.state.reply,initMessage:this.state.contentToEdit,onKeyPress:this.sendKeyPress,onRecordingProgress:this.sendKeyPress,onSendMessage:this.sendMessage,onAttachFile:this.props.forwardMessage?null:this.handleAttachFile,onAttachImage:this.props.forwardMessage?null:this.handleAttachImageOrVideo,onAttachAudio:this.props.forwardMessage?null:this.sendAudioAttachment,onError:this.props.onError,onQuoteClick:this.handleQuoteClick,onCancelReply:this.handleCancelReply}));a=t().createElement(t().Fragment,null,t().createElement("div",{id:"topic-caption-panel",className:"caption-panel"},this.props.displayMobile?t().createElement("a",{href:"#",id:"hide-message-view",onClick:e=>{e.preventDefault(),this.leave(this.state.topic),this.props.onHideMessagesView()}},t().createElement("i",{className:"material-icons"},"arrow_back")):null,t().createElement("div",{className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:m,topic:this.state.topic,title:this.state.title,deleted:this.state.deleted}),n?null:t().createElement("span",{className:u})),t().createElement("div",{id:"topic-title-group"},t().createElement("div",{id:"topic-title",className:g},this.state.title||t().createElement("i",null,t().createElement(i.FormattedMessage,{id:"unnamed_topic",defaultMessage:"Unnamed",description:"Title shown when the topic has no name"})),t().createElement(cs,{badges:r})),t().createElement("div",{id:"topic-last-seen"},p)),o?t().createElement(Bi,{tinode:this.props.tinode,subscribers:this.state.onlineSubs}):t().createElement("div",{id:"topic-users"}),t().createElement("div",null,t().createElement("a",{href:"#",onClick:this.handleContextClick},t().createElement("i",{className:"material-icons"},"more_vert")))),this.props.displayMobile?t().createElement(Gs,{level:this.props.errorLevel,text:this.props.errorText,onClearError:this.props.onError}):null,t().createElement(Vi.c,{show:this.state.fetchingMessages}),f,this.state.dragging&&this.isDragEnabled()?t().createElement("div",{className:"drag-n-drop"},e($i.drag_file)):null)}s=t().createElement("div",{id:"topic-view",ref:this.mountDnDEvents},a)}else s=t().createElement(Hi,{serverVersion:this.props.serverVersion,serverAddress:this.props.serverAddress});return s}}const ea=(0,i.injectIntl)(Zi);class ta extends t().PureComponent{render(){return t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onBack()}},t().createElement("i",{className:"material-icons"},"arrow_back"))}}class sa extends t().PureComponent{render(){return t().createElement("div",null,t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onNewTopic()}},t().createElement("i",{className:"material-icons"},"chat"))," ",t().createElement("a",{href:"#",onClick:e=>{e.preventDefault(),this.props.onSettings()}},t().createElement("i",{className:"material-icons"},"settings")))}}class ia extends t().PureComponent{render(){return t().createElement("div",null)}}class aa extends t().PureComponent{render(){const e=[];this.props.trustedBadges&&this.props.trustedBadges.map((t=>{e.push({icon:t,color:"badge-inv"})}));let s=null;return this.props.tinode&&(s=this.props.tinode.authorizeURL((0,Cs.mM)(this.props.avatar,"image"))),t().createElement("div",{id:"side-caption-panel",className:"contacts"===this.props.state?"caption-panel caption-panel--contacts":"caption-panel"},this.props.onCancel?t().createElement(ta,{onBack:this.props.onCancel}):null,s?t().createElement("div",{id:"self-avatar",className:"avatar-box"},t().createElement(ds.c,{tinode:this.props.tinode,avatar:s,topic:this.props.myUserId,title:this.props.title})):null,t().createElement("div",{id:"sidepanel-title",className:"panel-title"},this.props.title,t().createElement(cs,{badges:e})),"login"===this.props.state?t().createElement(ia,{onSignUp:this.props.onSignUp,onSettings:this.props.onSettings}):"contacts"===this.props.state?t().createElement(sa,{onNewTopic:this.props.onNewTopic,onSettings:this.props.onSettings}):null)}}const na=(0,i.defineMessages)({archived_contacts_title:{id:"archived_contacts",defaultMessage:"Archived contacts ({count})",description:"Label for archived chats"}});class oa extends t().Component{constructor(e){super(e),this.handleAction=this.handleAction.bind(this),this.state=oa.deriveStateFromProps(e)}static deriveStateFromProps(e){const t=[];let s=0,i=0;return e.chatList.map((a=>{const n=a.acs&&!a.acs.isJoiner();n&&e.blocked&&t.push(a),n||e.blocked||(a.private&&a.private.arch?e.archive?t.push(a):i++:e.archive||(t.push(a),s+=a.unread>0?1:0))})),t.sort(((e,t)=>(t.touched||0)-(e.touched||0))),i>0&&t.push({action:"archive",title:na.archived_contacts_title,values:{count:i}}),{contactList:t,unreadThreads:s}}componentDidUpdate(e,t){if(e.chatList!=this.props.chatList||e.archive!=this.props.archive||e.blocked!=this.props.blocked){const e=oa.deriveStateFromProps(this.props);this.setState(e),e.unreadThreads!=t.unreadThreads&&(0,Cs.cz)(e.unreadThreads)}}handleAction(e){this.props.onShowArchive()}render(){return t().createElement(i.FormattedMessage,{id:"contacts_not_found",defaultMessage:"You have no chats<br />¯∖_(ツ)_/¯",description:"HTML message shown in ContactList when no contacts are found"},(e=>t().createElement(Os,{tinode:this.props.tinode,connected:this.props.connected,contacts:this.state.contactList,emptyListMessage:e,topicSelected:this.props.topicSelected,myUserId:this.props.myUserId,showOnline:!0,showUnread:!0,onTopicSelected:this.props.onTopicSelected,showContextMenu:this.props.showContextMenu,onAction:this.handleAction})))}}class ra extends t().PureComponent{constructor(e){super(e),this.handleCheckboxClick=this.handleCheckboxClick.bind(this)}handleCheckboxClick(e,t){"sound"==e?this.props.onToggleMessageSounds(t):"alert"==e?this.props.onTogglePushNotifications(t):"incognito"==e&&this.props.onToggleIncognitoMode(t)}render(){return t().createElement("div",{className:"scrollable-panel"},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{htmlFor:"message-sound"},t().createElement(i.FormattedMessage,{id:"label_message_sound",defaultMessage:"Message sound:",description:"Label for message sounds toggle"})),t().createElement(Ks.c,{name:"sound",id:"message-sound",checked:this.props.messageSounds,onChange:this.handleCheckboxClick})),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{htmlFor:"desktop-alerts"},this.props.desktopAlertsEnabled?t().createElement(i.FormattedMessage,{id:"label_push_notifications",defaultMessage:"Notification alerts:",description:"Label for push notifications switch"}):t().createElement(i.FormattedMessage,{id:"label_push_notifications_disabled",defaultMessage:"Notification alerts (requires HTTPS):",description:"Label for push notifications switch"})),t().createElement(Ks.c,{name:"alert",id:"desktop-alerts",checked:this.props.desktopAlerts,onChange:this.props.desktopAlertsEnabled?this.handleCheckboxClick:null})),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{htmlFor:"incognito-mode"},t().createElement(i.FormattedMessage,{id:"label_incognito_mode",defaultMessage:"Incognito mode:",description:"Label for incognito mode toggle"})),t().createElement(Ks.c,{name:"incognito",id:"incognito-mode",checked:this.props.incognitoMode,onChange:this.handleCheckboxClick})))}}const la=(0,i.defineMessages)({delete_account:{id:"delete_account",defaultMessage:"Delete account",description:"Title for delete account warning"},delete_account_warning:{id:"delete_account_warning",defaultMessage:"Are you sure you want to delete your account? It cannot be undone.",description:"Warning message when deleting an account"}});class ca extends t().Component{constructor(e){super(e);const t=this.props.tinode.getMeTopic();let s=0;t.contacts((e=>{e.acs&&!e.acs.isJoiner()&&s++}));const i=t.getDefaultAccess();this.state={auth:i?i.auth:null,anon:i?i.anon:null,showPermissionEditorFor:void 0,blockedCount:s},this.handlePasswordUpdate=this.handlePasswordUpdate.bind(this),this.handleLaunchPermissionsEditor=this.handleLaunchPermissionsEditor.bind(this),this.handleHidePermissionsEditor=this.handleHidePermissionsEditor.bind(this),this.handlePermissionsChanged=this.handlePermissionsChanged.bind(this),this.handleDeleteAccount=this.handleDeleteAccount.bind(this)}handlePasswordUpdate(e){this.setState({password:e}),this.props.onUpdatePassword(e)}handleLaunchPermissionsEditor(e){this.setState({showPermissionEditorFor:e,editedPermissions:this.state[e]})}handleHidePermissionsEditor(){this.setState({showPermissionEditorFor:void 0})}handlePermissionsChanged(e){let t={};t[this.state.showPermissionEditorFor]=e,this.props.onUpdateAccountDesc("me",void 0,void 0,t);let s={showPermissionEditorFor:void 0};s[this.state.showPermissionEditorFor]=e,this.setState(s)}handleDeleteAccount(e){e.preventDefault();const{formatMessage:t}=this.props.intl;this.props.onShowAlert(t(la.delete_account),t(la.delete_account_warning),(e=>this.props.onDeleteAccount()),null,!0,null)}render(){return t().createElement(t().Fragment,null,this.state.showPermissionEditorFor?t().createElement(si,{mode:this.state.editedPermissions,skip:"O",onSubmit:this.handlePermissionsChanged,onCancel:this.handleHidePermissionsEditor}):t().createElement("div",{className:"scrollable-panel"},t().createElement("div",{className:"panel-form-column"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_password",defaultMessage:"Password",description:"Label for password editing"})),t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"password_unchanged_prompt",defaultMessage:"Unchanged",description:"Message in editor while password is unchanged"},(e=>t().createElement(li,{placeholder:e,type:"password",onFinished:this.handlePasswordUpdate}))))),t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-column"},t().createElement("a",{href:"#",className:"danger flat-button",onClick:e=>{e.preventDefault(),this.props.onLogout()}},t().createElement("i",{className:"material-icons"},"exit_to_app"),"  ",t().createElement(i.FormattedMessage,{id:"button_logout",defaultMessage:"Logout",description:"Button [Logout]"})),t().createElement("a",{href:"#",className:"danger flat-button",onClick:e=>{this.handleDeleteAccount(e)}},t().createElement("i",{className:"material-icons"},"delete"),"  ",t().createElement(i.FormattedMessage,{id:"button_delete_account",defaultMessage:"Delete account",description:"Button [Delete account]"}))),t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-column"},t().createElement("div",null,t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_default_access_mode",defaultMessage:"Default access mode:",description:"Label for default access mode"}))),t().createElement("div",{className:"quoted"},t().createElement("div",null,"Auth: ",t().createElement("tt",{className:"clickable",onClick:this.handleLaunchPermissionsEditor.bind(this,"auth")},this.state.auth)),t().createElement("div",null,"Anon: ",t().createElement("tt",{className:"clickable",onClick:this.handleLaunchPermissionsEditor.bind(this,"anon")},this.state.anon)))),this.state.blockedCount>0?t().createElement(t().Fragment,null,t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-row"},t().createElement("i",{className:"material-icons"},"block")," ",t().createElement("a",{href:"#",className:"gray",onClick:e=>{e.preventDefault(),this.props.onShowBlocked()}},t().createElement(i.FormattedMessage,{id:"blocked_contacts_link",defaultMessage:"Blocked contacts ({count})",values:{count:this.state.blockedCount},description:"Blocked contacts link"})))):null))}}const da=(0,i.injectIntl)(ca);class ha extends t().PureComponent{render(){return t().createElement("div",{className:"scrollable-panel"},t().createElement("div",{className:"panel-form-column"},t().createElement("a",{href:as.uK,className:"flat-button",target:"_blank"},t().createElement("i",{className:"material-icons"},"email"),"  ",t().createElement(i.FormattedMessage,{id:"link_contact_us",defaultMessage:"Contact Us",description:"Ancor text for contacting us by email"})),t().createElement("a",{href:as.SA,className:"flat-button",target:"_blank"},t().createElement("i",{className:"material-icons"},"description"),"  ",t().createElement(i.FormattedMessage,{id:"link_terms_of_service",defaultMessage:"Terms of Service",description:"Ancor text for terms of service link"})),t().createElement("a",{href:as.ED,className:"flat-button",target:"_blank"},t().createElement("i",{className:"material-icons"},"policy"),"  ",t().createElement(i.FormattedMessage,{id:"link_privacy_policy",defaultMessage:"Privacy Policy",description:"Ancor text for privacy policy link"}))),t().createElement("div",{className:"hr"}),t().createElement("div",{className:"panel-form-column"},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_client",defaultMessage:"Client:",description:"Label for a client version"})),as.Q5),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_sdk",defaultMessage:"SDK:"})),ss.Tinode.getLibrary()),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_server",defaultMessage:"Server:",description:"Label for a server version"})),this.props.serverVersion),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_server_address",defaultMessage:"Server address:"})),this.props.serverAddress)))}}class pa extends t().Component{constructor(e){super(e),this.state={login:e.login,password:"",hostName:e.serverAddress,saveToken:e.persist},this.handleLoginChange=this.handleLoginChange.bind(this),this.handlePasswordChange=this.handlePasswordChange.bind(this),this.handleToggleSaveToken=this.handleToggleSaveToken.bind(this),this.handleSubmit=this.handleSubmit.bind(this)}handleLoginChange(e){this.setState({login:e.target.value})}handlePasswordChange(e){this.setState({password:e.target.value})}handleToggleSaveToken(){this.props.onPersistenceChange(!this.state.saveToken),this.setState({saveToken:!this.state.saveToken})}handleSubmit(e){e.preventDefault(),this.props.onLogin(this.state.login.trim(),this.state.password.trim())}render(){let e="primary";return this.props.disabled&&(e+=" disabled"),t().createElement("div",null,t().createElement("form",{id:"login-form",onSubmit:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"login_prompt",defaultMessage:"Login",description:"Placeholer for username/login"},(e=>t().createElement("input",{type:"text",id:"inputLogin",placeholder:e,autoComplete:"username",autoCorrect:"off",autoCapitalize:"none",value:this.state.login,onChange:this.handleLoginChange,required:!0,autoFocus:!0}))),t().createElement(i.FormattedMessage,{id:"password_prompt",defaultMessage:"Password",description:"Placeholder/prompt for entering password"},(e=>t().createElement(ri.c,{type:"password",id:"inputPassword",placeholder:e,autoComplete:"current-password",value:this.state.password,onChange:this.handlePasswordChange,required:!0}))),t().createElement("div",{className:"panel-form-row"},t().createElement(Ks.c,{id:"save-token",name:"save-token",checked:this.state.saveToken,onChange:this.handleToggleSaveToken}),t().createElement("label",{htmlFor:"save-token"}," ",t().createElement(i.FormattedMessage,{id:"stay_logged_in",defaultMessage:"Stay logged in",description:"Label for a checkbox"})),t().createElement("a",{href:"#reset"},t().createElement(i.FormattedMessage,{id:"forgot_password_link",defaultMessage:"Forgot password?",description:"Link to Reset password form"}))),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:e,type:"submit"},t().createElement(i.FormattedMessage,{id:"button_sign_in",defaultMessage:"Sign in",description:"Button [Sign In]"})))))}}const ma=(0,i.defineMessages)({invalid_id:{id:"error_invalid_id",defaultMessage:"Invalid ID",description:"Error message"}});class ua extends t().PureComponent{constructor(e){super(e),this.qrCodeRef=t().createRef(),this.state={groupId:""},this.handleChange=this.handleChange.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this),this.handleSubmit=this.handleSubmit.bind(this)}componentDidMount(){new(ai())(this.qrCodeRef.current,{text:this.props.myURI,width:as.eV,height:as.eV})}handleChange(e){this.setState({groupId:e.target.value})}handleKeyPress(e){"Enter"===e.key&&this.handleSubmit(e)}handleSubmit(e){if(e.preventDefault(),this.state.groupId){const e=this.state.groupId.trim(),t=e.substring(0,3);e.length>3&&["usr","grp","chn"].includes(t)?this.props.onSubmit(e):this.props.onError(this.props.intl.formatMessage(ma.invalid_id),"err")}}render(){return t().createElement("div",{className:"panel-form"},t().createElement("div",{className:"panel-form-row"},t().createElement(i.FormattedMessage,{id:"group_user_id_prompt",defaultMessage:"Group or User ID",description:"Prompt for entering user or group ID"},(e=>t().createElement("input",{type:"text",placeholder:e,value:this.state.groupId,onChange:this.handleChange,onKeyDown:this.handleKeyPress,required:!0,autoFocus:!0})))),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:"primary",onClick:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"button_subscribe",defaultMessage:"Subscribe",description:"Button [Subscribe]"}))),t().createElement("br",null),t().createElement("div",{className:"panel-form-column"},t().createElement("label",{className:"small"},"Scan my ID:"),t().createElement("div",{className:"qr-code",ref:this.qrCodeRef})))}}const ga=(0,i.injectIntl)(ua);class fa extends t().PureComponent{constructor(e){super(e),this.fullName=t().createRef(),this.state={fullName:"",private:"",description:"",imageUrl:null,tags:[],isChannel:!1,newAvatar:null,newAvatarMime:null},this.handleFieldEdit=this.handleFieldEdit.bind(this),this.handleImageChanged=this.handleImageChanged.bind(this),this.handleAvatarCropped=this.handleAvatarCropped.bind(this),this.handleAvatarCropCancel=this.handleAvatarCropCancel.bind(this),this.uploadAvatar=this.uploadAvatar.bind(this),this.handleTagsChanged=this.handleTagsChanged.bind(this),this.handleChannelToggle=this.handleChannelToggle.bind(this),this.handleSubmit=this.handleSubmit.bind(this)}componentDidMount(){}handleFieldEdit(e,t){this.setState({[e]:t.target.value||""})}handleImageChanged(e,t){this.setState({newAvatar:t,newAvatarMime:e})}handleAvatarCropped(e,t,s,i){const a=t?URL.createObjectURL(t):null;this.setState({imageUrl:a,newAvatar:null,newAvatarMime:null}),t&&this.uploadAvatar(e,t,s,i)}handleAvatarCropCancel(){this.setState({newAvatar:null,newAvatarMime:null})}uploadAvatar(e,t,s,i){const a=e=>{let{mime:t,blob:s}=e;if(s.size>as.cH){this.props.tinode.getLargeFileHelper().upload(s).then((e=>this.setState({imageUrl:e}))).catch((e=>this.props.onError(e.message,"err")))}else(0,Es._K)(s).then((e=>this.setState({imageUrl:(0,Es.Qn)({data:e.bits,type:t})})))};s>as.kz||i>as.kz||s!=i?(0,Es._k)(t,as.kz,as.kz,as._c,!0).then((e=>a(e))).catch((e=>this.props.onError(e.message,"err"))):a({mime:e,blob:t,width:s,height:i})}handleTagsChanged(e){this.setState({tags:e})}handleChannelToggle(){this.setState({isChannel:!this.state.isChannel})}handleSubmit(e){e.preventDefault();const t=this.state.fullName.trim().substring(0,as.Yb),s=this.state.private.trim().substring(0,as.Yb),i=this.state.description.trim().substring(0,as.aq);t&&this.props.onSubmit(t,i,this.state.imageUrl,s,this.state.tags,this.state.isChannel)}render(){if(this.state.newAvatar)return t().createElement(oi.c,{avatar:this.state.newAvatar,mime:this.state.newAvatarMime,onSubmit:this.handleAvatarCropped,onCancel:this.handleAvatarCropCancel,onError:this.props.onError});let e="primary";return this.props.disabled&&(e+=" disabled"),t().createElement("form",{className:"panel-form",onSubmit:this.handleSubmit},t().createElement("div",{className:"panel-form-column"},t().createElement("center",null,t().createElement(zs.c,{tinode:this.props.tinode,avatar:this.state.imageUrl,onError:this.props.onError,onImageUpdated:this.handleImageChanged})),t().createElement("div",{className:"group"},t().createElement("label",{className:"small",htmlFor:"new-topic-fn"},t().createElement(i.FormattedMessage,{id:"label_topic_name",defaultMessage:"Name",description:"Label for editing topic name"})),t().createElement(i.FormattedMessage,{id:"topic_name_editing_placeholder",defaultMessage:"Freeform name of the group",description:"Prompt for entering topic name"},(e=>t().createElement("input",{type:"text",id:"new-topic-fn",placeholder:e,ref:this.fullName,value:this.state.fullName,onChange:this.handleFieldEdit.bind(this,"fullName"),autoFocus:!0,required:!0,tabIndex:0})))),t().createElement("div",{className:"group"},t().createElement("label",{className:"small",htmlFor:"new-topic-priv"},t().createElement(i.FormattedMessage,{id:"label_private",defaultMessage:"Private comment",description:"Label for editing 'private'"})),t().createElement(i.FormattedMessage,{id:"private_editing_placeholder",defaultMessage:"Visible to you only",description:"Placeholder for editing 'private'"},(e=>t().createElement("input",{type:"text",id:"new-topic-priv",placeholder:e,value:this.state.private,onChange:this.handleFieldEdit.bind(this,"private"),tabIndex:1})))),t().createElement("div",{className:"group"},t().createElement("label",{className:"small",htmlFor:"new-topic-desc"},t().createElement(i.FormattedMessage,{id:"label_description",defaultMessage:"Description",description:"Label for editing topic description"})),t().createElement(i.FormattedMessage,{id:"description_editing_placeholder",defaultMessage:"Description (optional)",description:"Placeholder for editing topic description"},(e=>t().createElement("input",{type:"text",id:"new-topic-desc",placeholder:e,value:this.state.description,onChange:this.handleFieldEdit.bind(this,"description"),tabIndex:2}))))),t().createElement("div",{className:"panel-form-row"},t().createElement(Ks.c,{checked:this.state.isChannel,tabIndex:3,onChange:this.handleChannelToggle})," ",t().createElement("label",{onClick:this.handleChannelToggle},t().createElement(i.FormattedMessage,{id:"channel_prompt",defaultMessage:"This is a channel",description:"Checkbox label when creating a channel"}))),t().createElement(i.FormattedMessage,{id:"title_tag_manager",defaultMessage:"Tags (search & discovery)",description:"Section title for TagManager"},(e=>t().createElement(ci,{tinode:this.props.tinode,tags:this.state.tags,activated:!0,onTagsChanged:this.handleTagsChanged,tabIndex:4,title:e}))),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:e},t().createElement(i.FormattedMessage,{id:"button_create",defaultMessage:"Create",description:"Button [Create]"}))))}}const ba=(0,i.defineMessages)({search_for_contacts:{id:"search_for_contacts",defaultMessage:"Use search to find contacts",description:"Text shown in contacts view when user entered no search query."},search_no_results:{id:"search_no_results",defaultMessage:"Search returned no results",description:"Text shown in contacts view when query returned no results."},search_placeholder:{id:"search_placeholder",defaultMessage:"List like alice@example.com, +17025550003...",description:"Placeholder in contacts search field"}});class va extends t().Component{constructor(e){super(e),this.state={tabSelected:"find",searchQuery:null},this.handleTabClick=this.handleTabClick.bind(this),this.handleSearchContacts=this.handleSearchContacts.bind(this),this.handleSearchResultSelected=this.handleSearchResultSelected.bind(this),this.handleNewGroupSubmit=this.handleNewGroupSubmit.bind(this),this.handleGroupByID=this.handleGroupByID.bind(this)}componentDidMount(){this.props.onInitFind()}handleTabClick(e){e.preventDefault(),Gi.c.navigateTo(Gi.c.addUrlParam(window.location.hash,"tab",e.currentTarget.dataset.id)),this.setState({tabSelected:e.currentTarget.dataset.id})}handleSearchContacts(e){this.props.onSearchContacts(e),this.setState({searchQuery:ss.Tinode.isNullValue(e)?null:e})}handleSearchResultSelected(e){"find"==this.state.tabSelected&&(Gi.c.navigateTo(Gi.c.removeUrlParam(window.location.hash,"tab")),this.props.onCreateTopic(e))}handleNewGroupSubmit(e,t,s,i,a,n){Gi.c.navigateTo(Gi.c.removeUrlParam(window.location.hash,"tab")),this.props.onCreateTopic(void 0,{public:(0,Cs.QB)(e,s,null,t),private:i,tags:a},n)}handleGroupByID(e){Gi.c.navigateTo(Gi.c.removeUrlParam(window.location.hash,"tab")),this.props.onCreateTopic(e)}render(){const{formatMessage:e}=this.props.intl,s=e(this.state.searchQuery?ba.search_no_results:ba.search_for_contacts),a=e(ba.search_placeholder);return t().createElement("div",{className:"flex-column"},t().createElement("ul",{className:"tabbar"},t().createElement("li",{className:"find"===this.state.tabSelected?"active":null},t().createElement("a",{href:"#","data-id":"find",onClick:this.handleTabClick},t().createElement(i.FormattedMessage,{id:"tabtitle_find_user",defaultMessage:"find",description:"Tab title Find"}))),t().createElement("li",{className:"grp"===this.state.tabSelected?"active":null},t().createElement("a",{href:"#","data-id":"grp",onClick:this.handleTabClick},t().createElement(i.FormattedMessage,{id:"tabtitle_new_group",defaultMessage:"new group",description:"Tab title New Group"}))),t().createElement("li",{className:"byid"===this.state.tabSelected?"active":null},t().createElement("a",{href:"#","data-id":"byid",onClick:this.handleTabClick},t().createElement(i.FormattedMessage,{id:"tabtitle_group_by_id",defaultMessage:"by id",description:"Tab title Find topic by ID"})))),"grp"===this.state.tabSelected?t().createElement(fa,{tinode:this.props.tinode,onSubmit:this.handleNewGroupSubmit,onError:this.props.onError}):"byid"===this.state.tabSelected?t().createElement(ga,{myURI:ss.Tinode.URI_TOPIC_ID_PREFIX+this.props.tinode.getCurrentUserID(),onSubmit:this.handleGroupByID,onError:this.props.onError}):t().createElement("div",{className:"flex-column"},t().createElement(Bs,{placeholder:a,onSearchContacts:this.handleSearchContacts}),t().createElement(Os,{tinode:this.props.tinode,contacts:this.props.searchResults,myUserId:this.props.myUserId,emptyListMessage:s,showOnline:!1,showUnread:!1,showContextMenu:!1,onTopicSelected:this.handleSearchResultSelected})))}}const wa=(0,i.injectIntl)(va);class Ea extends t().PureComponent{constructor(e){super(e),this.state={hostName:e.serverAddress,changed:!1},this.handleHostNameChange=this.handleHostNameChange.bind(this),this.handleEditingFinished=this.handleEditingFinished.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}handleHostNameChange(e){this.setState({hostName:e.target.value,changed:!0})}handleEditingFinished(){this.state.changed&&(this.setState({changed:!1}),this.props.onServerAddressChange(this.state.hostName.trim()))}handleKeyDown(e){"Enter"==e.key&&this.handleEditingFinished()}render(){var e=[];for(let s in as.W8){let i=as.W8[s];e.push(t().createElement("option",{key:i,value:i}))}return t().createElement("div",{className:"panel-form-row"},t().createElement("input",{type:"search",id:"host-name",placeholder:this.props.hostName,list:"known-hosts",className:"quoted",value:this.state.hostName,onChange:this.handleHostNameChange,onBlur:this.handleEditingFinished,onKeyDown:this.handleKeyDown,required:!0}),t().createElement("datalist",{id:"known-hosts"},e))}}class Ca extends t().PureComponent{constructor(e){super(e),this.state={transport:e.transport||"def",serverAddress:e.serverAddress,secureConnection:e.secureConnection},this.handleSubmit=this.handleSubmit.bind(this),this.handleTransportSelected=this.handleTransportSelected.bind(this),this.handleServerAddressChange=this.handleServerAddressChange.bind(this),this.handleToggleSecure=this.handleToggleSecure.bind(this)}handleSubmit(e){e.preventDefault(),this.props.onUpdate({transport:this.state.transport,serverAddress:this.state.serverAddress,secureConnection:this.state.secureConnection})}handleTransportSelected(e){this.setState({transport:e.currentTarget.value})}handleServerAddressChange(e){this.setState({serverAddress:e})}handleToggleSecure(e){this.setState({secureConnection:!this.state.secureConnection})}render(){const e={def:"default",ws:"websocket",lp:"long polling"},s=[];return["def","ws","lp"].map((i=>{const a="transport-"+i,n=e[i];s.push(t().createElement("li",{key:i},t().createElement("input",{type:"radio",id:a,name:"transport-select",value:i,checked:this.state.transport===i,onChange:this.handleTransportSelected}),t().createElement("label",{htmlFor:a},n)))})),t().createElement("form",{id:"settings-form",className:"panel-form",onSubmit:this.handleSubmit},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_server_to_use",defaultMessage:"Server to use:",description:"Label for server selector in SettingsView"}))),t().createElement(Ea,{serverAddress:this.state.serverAddress,onServerAddressChange:this.handleServerAddressChange}),t().createElement("div",{className:"panel-form-row"},t().createElement(Ks.c,{id:"secure-connection",name:"secure-connection",checked:this.state.secureConnection,className:"quoted",onChange:this.handleToggleSecure}),t().createElement("label",{htmlFor:"secure-connection"},t().createElement(i.FormattedMessage,{id:"label_use_secure_connection",defaultMessage:"Use secure connection",description:"Label for WS/WSS connection type in SettingsView"}))),t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small"},t().createElement(i.FormattedMessage,{id:"label_wire_transport",defaultMessage:"Wire transport:",description:"Label for wire transport selection in SettingsView"}))),t().createElement("div",{className:"panel-form-row"},t().createElement("ul",{className:"quoted"},s)),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{type:"submit",className:"primary"},t().createElement(i.FormattedMessage,{id:"button_update",defaultMessage:"Update",description:"Button [Update]"}))))}}const Sa=(0,i.defineMessages)({phone:{id:"phone_dative",defaultMessage:"phone",description:"Dative case of 'phone', i.e. 'phone' in 'by phone'"},email:{id:"email_dative",defaultMessage:"email",description:"Dative case of 'email', i.e. 'email' in 'by email'"}});class ya extends t().PureComponent{constructor(e){super(e),this.state={code:e.credCode||"",codeReceived:e.credCode},this.handleCodeChange=this.handleCodeChange.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this),this.handleSubmit=this.handleSubmit.bind(this),this.handleCancel=this.handleCancel.bind(this)}static getDerivedStateFromProps(e,t){return e.credCode!=t.codeReceived?{code:e.credCode||"",codeReceived:e.credCode}:t}componentDidMount(){this.props.credCode&&this.props.onSubmit(this.props.credMethod,this.props.credCode,this.props.credToken)}componentDidUpdate(e,t){this.state.codeReceived&&this.state.code&&this.state.code!=t.code&&this.props.onSubmit(this.props.credMethod,this.state.code,this.props.credToken)}handleCodeChange(e){this.setState({code:e.target.value.replace(/[^\d]/g,"")})}handleKeyPress(e){"Enter"===e.key?this.handleSubmit(e):"Escape"==e.key&&this.handleCancel(e)}handleSubmit(e){e.preventDefault(),this.state.code&&this.state.code.trim()&&this.props.onSubmit(this.props.credMethod,this.state.code.trim(),this.props.credToken)}handleCancel(e){e.preventDefault(),this.props.onCancel()}render(){const{formatMessage:e}=this.props.intl,s={email:e(Sa.email),tel:e(Sa.phone)}[this.props.credMethod]||this.props.credMethod;return t().createElement("div",{className:"panel-form"},t().createElement("div",{className:"panel-form-row"},t().createElement("label",{className:"small gray",htmlFor:"enter-confirmation-code"},t().createElement(i.FormattedMessage,{id:"enter_confirmation_code_prompt",defaultMessage:"Confirmation code",description:"Request to enter confirmation code",values:{method:s}}))),t().createElement("div",{className:"panel-form-row"},t().createElement(i.FormattedMessage,{id:"numeric_confirmation_code_prompt",defaultMessage:"Numbers only",description:"Prompt for numeric conformation code"},(e=>t().createElement("input",{type:"text",id:"enter-confirmation-code",placeholder:e,value:this.state.code,onChange:this.handleCodeChange,onKeyDown:this.handleKeyPress,required:!0})))),t().createElement("div",{className:"dialog-buttons"},t().createElement("button",{className:"secondary",onClick:this.handleCancel},t().createElement(i.FormattedMessage,{id:"button_cancel",defaultMessage:"Cancel",description:"Button [Cancel]"})),t().createElement("button",{className:"primary",onClick:this.handleSubmit},t().createElement(i.FormattedMessage,{id:"button_confirm",defaultMessage:"Confirm",description:"Button [Confirm]"}))))}}const Ma=(0,i.injectIntl)(ya),_a=t().lazy((e=>Promise.all([o.e(688),o.e(68)]).then(o.bind(o,2068)))),Ta=t().lazy((e=>Promise.all([o.e(688),o.e(904)]).then(o.bind(o,1904)))),ka=t().lazy((e=>Promise.all([o.e(688),o.e(520)]).then(o.bind(o,1520)))),Aa=(0,i.defineMessages)({login:{id:"sidepanel_title_login",description:"Sidepanel title for LoginView.",defaultMessage:"Sign In"},register:{id:"sidepanel_title_register",description:"Sidepanel title for CreateAccountView.",defaultMessage:"Create Account"},settings:{id:"sidepanel_title_settings",description:"Sidepanel title for SettingsView.",defaultMessage:"Settings"},edit:{id:"sidepanel_title_account_settings",description:"Sidepanel title for AccountSettingsView.",defaultMessage:"Account Settings"},general:{id:"panel_title_general",description:"Title for TopicCommon.",defaultMessage:"General"},security:{id:"panel_title_security",description:"Title for TopicSecirity and AccSecurity.",defaultMessage:"Security"},crop:{id:"panel_title_crop",description:"Title for AvatarCropView.",defaultMessage:"Drag to Adjust"},notif:{id:"sidepanel_title_acc_notifications",description:"Sidepanel title for AccNotificationsView.",defaultMessage:"Notifications"},support:{id:"sidepanel_title_acc_support",description:"Sidepanel title for AccSupportView.",defaultMessage:"Support"},newtpk:{id:"sidepanel_title_newtpk",description:"Sidepanel title for NewTopicView.",defaultMessage:"Start New Chat"},cred:{id:"sidepanel_title_cred",description:"Sidepanel title for ValidationView.",defaultMessage:"Confirm Credentials"},reset:{id:"sidepanel_title_reset",description:"Sidepanel title for PasswordResetView.",defaultMessage:"Reset Password"},archive:{id:"sidepanel_title_archive",description:"Sidepanel title for ContactsView-Archive.",defaultMessage:"Archived Chats"},blocked:{id:"sidepanel_title_blocked",description:"Sidepanel title for ContactsView-Blocked.",defaultMessage:"Blocked Chats"}});class Da extends t().PureComponent{constructor(e){super(e),this.handleNewTopic=this.handleNewTopic.bind(this)}handleNewTopic(){this.props.onNavigate("newtpk")}render(){const{formatMessage:s}=this.props.intl,a=this.props.state||(this.props.myUserId?"contacts":"login");let n,o,r,l;return"contacts"==a?(n=this.props.title,o=!this.props.avatar||this.props.avatar,r=this.props.trustedBadges):(n=s(Aa[a]),o=!1,r=null),-1==["login","contacts"].indexOf(a)&&(l=this.props.onCancel),t().createElement("div",{id:"sidepanel"},t().createElement(aa,{state:a,title:n,avatar:o,tinode:this.props.tinode,trustedBadges:r,myUserId:this.props.myUserId,onSignUp:this.props.onSignUp,onSettings:this.props.onSettings,onNewTopic:this.handleNewTopic,onCancel:l}),t().createElement(Vi.c,{show:this.props.loadSpinnerVisible}),"login"===a?t().createElement("div",null,t().createElement("div",{style:{display:"flex",justifyContent:"center",margin:"20px 0"}},t().createElement("img",{src:"/img/logo.png",alt:""})),t().createElement(pa,{login:this.props.login,disabled:this.props.loginDisabled,persist:this.props.persist,onLogin:this.props.onLoginRequest,onPersistenceChange:this.props.onPersistenceChange,onSignUp:this.props.onSignUp})):"register"===a?t().createElement(e.Suspense,{fallback:t().createElement("div",{className:"panel-form-row"},t().createElement(i.FormattedMessage,{id:"loading_note",defaultMessage:"Loading...",description:"Message shown when component is loading"}))},t().createElement(Ta,{tinode:this.props.tinode,reqCredMethod:this.props.reqCredMethod,onShowCountrySelector:this.props.onShowCountrySelector,onCreateAccount:this.props.onCreateAccount,onCancel:this.props.onCancel,onError:this.props.onError})):"settings"===a?t().createElement(Ca,{transport:this.props.transport,serverAddress:this.props.serverAddress,secureConnection:this.props.secureConnection,onCancel:this.props.onCancel,onUpdate:this.props.onGlobalSettings}):"edit"===a?t().createElement(e.Suspense,{fallback:t().createElement("div",{className:"panel-form-row"},t().createElement(i.FormattedMessage,{id:"loading_note",defaultMessage:"Loading...",description:"Message shown when component is loading"}))},t().createElement(_a,{tinode:this.props.tinode,myUserId:this.props.myUserId,trustedBadges:this.props.trustedBadges,reqCredMethod:this.props.reqCredMethod,onShowCountrySelector:this.props.onShowCountrySelector,onNavigate:this.props.onNavigate,onCredAdd:this.props.onCredAdd,onCredDelete:this.props.onCredDelete,onCredConfirm:this.props.onCredConfirm,onError:this.props.onError})):"general"===a||"crop"===a?t().createElement(hi,{topic:"me",tinode:this.props.tinode,myUserId:this.props.myUserId,reqCredMethod:this.props.reqCredMethod,onUpdateTopicDesc:this.props.onUpdateAccountDesc,onUpdateTagsRequest:this.props.onUpdateAccountTags,onError:this.props.onError}):"notif"===a?t().createElement(ra,{messageSounds:this.props.messageSounds,desktopAlerts:this.props.desktopAlerts,desktopAlertsEnabled:this.props.desktopAlertsEnabled,incognitoMode:this.props.incognitoMode,onTogglePushNotifications:this.props.onTogglePushNotifications,onToggleMessageSounds:this.props.onToggleMessageSounds,onToggleIncognitoMode:this.props.onToggleIncognitoMode}):"security"===a?t().createElement(da,{tinode:this.props.tinode,onUpdateAccountDesc:this.props.onUpdateAccountDesc,onUpdatePassword:this.props.onUpdatePassword,onLogout:this.props.onLogout,onDeleteAccount:this.props.onDeleteAccount,onShowAlert:this.props.onShowAlert,onShowBlocked:this.props.onShowBlocked}):"support"===a?t().createElement(ha,{serverAddress:this.props.serverAddress,serverVersion:this.props.serverVersion}):"contacts"===a||"archive"==a||"blocked"==a?t().createElement(oa,{tinode:this.props.tinode,myUserId:this.props.myUserId,connected:this.props.connected,topicSelected:this.props.topicSelected,archive:"archive"==a,blocked:"blocked"==a,chatList:this.props.chatList,showContextMenu:this.props.showContextMenu,onTopicSelected:this.props.onTopicSelected,onShowArchive:this.props.onShowArchive}):"newtpk"===a?t().createElement(wa,{tinode:this.props.tinode,searchResults:this.props.searchResults,onInitFind:this.props.onInitFind,onSearchContacts:this.props.onSearchContacts,onCreateTopic:this.props.onCreateTopic,onError:this.props.onError}):"cred"===a?t().createElement(Ma,{credCode:this.props.credCode,credMethod:this.props.credMethod,credToken:this.props.credToken,onSubmit:this.props.onValidateCredentials,onCancel:this.props.onCancel}):"reset"===a?t().createElement(e.Suspense,{fallback:t().createElement("div",{className:"panel-form-row"},t().createElement(i.FormattedMessage,{id:"loading_note",defaultMessage:"Loading...",description:"Message shown when component is loading"}))},t().createElement(ka,{tinode:this.props.tinode,reqCredMethod:this.props.reqCredMethod,onShowCountrySelector:this.props.onShowCountrySelector,onRequest:this.props.onPasswordResetRequest,onReset:this.props.onResetPassword,onCancel:this.props.onCancel,onError:this.props.onError})):null,t().createElement(Gs,{level:this.props.errorLevel,text:this.props.errorText,action:this.props.errorAction,actionText:this.props.errorActionText,onClearError:this.props.onError,class:"error-alert"}))}}const Na=(0,i.injectIntl)(Da);function Ia(){let e=as.qm;return"object"==typeof window.location&&("file:"==window.location.protocol||"localhost"==window.location.hostname?e=as.W8.local:window.location.hostname&&(e=window.location.hostname+(window.location.port?":"+window.location.port:""))),e}function Pa(){return"object"==typeof window.location&&"https:"==window.location.protocol}var Ra=o(336);const xa=t().lazy((e=>o.e(724).then(o.bind(o,6724)))),Fa=new Audio("audio/msg.m4a"),Ua=(0,i.defineMessages)({reconnect_countdown:{id:"reconnect_countdown",defaultMessage:"Disconnected. Reconnecting in {seconds}…",description:"Message shown when an app update is available."},reconnect_now:{id:"reconnect_now",defaultMessage:"Try now",description:"Prompt for reconnecting now"},push_init_failed:{id:"push_init_failed",defaultMessage:"Error",description:"Error message when push notifications have failed to initialize."},invalid_security_token:{id:"invalid_security_token",defaultMessage:"Invalid security token",description:"Error message when resetting password."},no_connection:{id:"no_connection",defaultMessage:"No connection",description:"Warning that the user is offline."},code_doesnot_match:{id:"code_doesnot_match",defaultMessage:"Code does not match",description:"Error message when the credential validation code is incorrect."},menu_item_info:{id:"menu_item_info",defaultMessage:"Info",description:"Show extended topic information"},menu_item_audio_call:{id:"menu_item_audio_call",defaultMessage:"Call",description:"Start audio call"},menu_item_video_call:{id:"menu_item_video_call",defaultMessage:"Video call",description:"Start video call"},cred_confirmed_successfully:{id:"cred_confirmed_successfully",defaultMessage:"Confirmed successfully",description:"Notification message that the credential was successfully validated."},password_reset_success:{id:"password_reset_success",defaultMessage:"Password reset successfully",description:"Notification message that the password was successfully reset."}});class La extends t().Component{constructor(e){super(e),this.selfRef=t().createRef(),this.state=this.getBlankState(),this.handleResize=this.handleResize.bind(this),this.handleHashRoute=this.handleHashRoute.bind(this),this.handleOnline=this.handleOnline.bind(this),this.checkForAppUpdate=this.checkForAppUpdate.bind(this),this.handleVisibilityEvent=this.handleVisibilityEvent.bind(this),this.handleError=this.handleError.bind(this),this.handleLoginRequest=this.handleLoginRequest.bind(this),this.handlePersistenceChange=this.handlePersistenceChange.bind(this),this.handleConnected=this.handleConnected.bind(this),this.handleAutoreconnectIteration=this.handleAutoreconnectIteration.bind(this),this.doLogin=this.doLogin.bind(this),this.handleLoginSuccessful=this.handleLoginSuccessful.bind(this),this.handleDisconnect=this.handleDisconnect.bind(this),this.tnMeMetaDesc=this.tnMeMetaDesc.bind(this),this.tnMeContactUpdate=this.tnMeContactUpdate.bind(this),this.tnMeSubsUpdated=this.tnMeSubsUpdated.bind(this),this.resetContactList=this.resetContactList.bind(this),this.tnInitFind=this.tnInitFind.bind(this),this.tnFndSubsUpdated=this.tnFndSubsUpdated.bind(this),this.handleSearchContacts=this.handleSearchContacts.bind(this),this.handleTopicSelected=this.handleTopicSelected.bind(this),this.handleHideMessagesView=this.handleHideMessagesView.bind(this),this.handleSendMessage=this.handleSendMessage.bind(this),this.handleNewChatInvitation=this.handleNewChatInvitation.bind(this),this.handleNewAccount=this.handleNewAccount.bind(this),this.handleNewAccountRequest=this.handleNewAccountRequest.bind(this),this.handleUpdatePasswordRequest=this.handleUpdatePasswordRequest.bind(this),this.handleUpdateAccountTagsRequest=this.handleUpdateAccountTagsRequest.bind(this),this.handleToggleIncognitoMode=this.handleToggleIncognitoMode.bind(this),this.handleSettings=this.handleSettings.bind(this),this.handleGlobalSettings=this.handleGlobalSettings.bind(this),this.handleShowArchive=this.handleShowArchive.bind(this),this.handleShowBlocked=this.handleShowBlocked.bind(this),this.handleToggleMessageSounds=this.handleToggleMessageSounds.bind(this),this.handleCredAdd=this.handleCredAdd.bind(this),this.handleCredDelete=this.handleCredDelete.bind(this),this.handleCredConfirm=this.handleCredConfirm.bind(this),this.toggleFCMToken=this.toggleFCMToken.bind(this),this.handlePushMessage=this.handlePushMessage.bind(this),this.handleSidepanelCancel=this.handleSidepanelCancel.bind(this),this.handleStartTopicRequest=this.handleStartTopicRequest.bind(this),this.handleNewTopicCreated=this.handleNewTopicCreated.bind(this),this.handleTopicUpdateRequest=this.handleTopicUpdateRequest.bind(this),this.handleUnarchive=this.handleUnarchive.bind(this),this.handleChangePermissions=this.handleChangePermissions.bind(this),this.handleTagsUpdateRequest=this.handleTagsUpdateRequest.bind(this),this.handleLogout=this.handleLogout.bind(this),this.handleDeleteAccount=this.handleDeleteAccount.bind(this),this.handleDeleteTopicRequest=this.handleDeleteTopicRequest.bind(this),this.handleDeleteMessagesRequest=this.handleDeleteMessagesRequest.bind(this),this.handleLeaveUnsubRequest=this.handleLeaveUnsubRequest.bind(this),this.handleBlockTopicRequest=this.handleBlockTopicRequest.bind(this),this.handleReportTopic=this.handleReportTopic.bind(this),this.handleShowContextMenu=this.handleShowContextMenu.bind(this),this.defaultTopicContextMenu=this.defaultTopicContextMenu.bind(this),this.handleHideContextMenu=this.handleHideContextMenu.bind(this),this.handleShowAlert=this.handleShowAlert.bind(this),this.handleShowInfoView=this.handleShowInfoView.bind(this),this.handleMemberUpdateRequest=this.handleMemberUpdateRequest.bind(this),this.handleValidateCredentialsRequest=this.handleValidateCredentialsRequest.bind(this),this.handlePasswordResetRequest=this.handlePasswordResetRequest.bind(this),this.handleResetPassword=this.handleResetPassword.bind(this),this.handleContextMenuAction=this.handleContextMenuAction.bind(this),this.handleShowCountrySelector=this.handleShowCountrySelector.bind(this),this.handleShowForwardDialog=this.handleShowForwardDialog.bind(this),this.handleHideForwardDialog=this.handleHideForwardDialog.bind(this),this.handleStartVideoCall=this.handleStartVideoCall.bind(this),this.handleStartAudioCall=this.handleStartAudioCall.bind(this),this.handleInfoMessage=this.handleInfoMessage.bind(this),this.handleDataMessage=this.handleDataMessage.bind(this),this.handleCallClose=this.handleCallClose.bind(this),this.handleCallInvite=this.handleCallInvite.bind(this),this.handleCallRinging=this.handleCallRinging.bind(this),this.handleCallHangup=this.handleCallHangup.bind(this),this.handleCallSendOffer=this.handleCallSendOffer.bind(this),this.handleCallIceCandidate=this.handleCallIceCandidate.bind(this),this.handleCallSendAnswer=this.handleCallSendAnswer.bind(this),this.handleCallAccept=this.handleCallAccept.bind(this),this.sendMessageToTopic=this.sendMessageToTopic.bind(this),this.callTimeoutTimer=null}getBlankState(){const e=Ra.c.getObject("settings")||{},t=!!Ra.c.getObject("keep-logged-in");return{connected:!1,ready:!0,autoLogin:!0,transport:e.transport||null,serverAddress:e.serverAddress||Ia(),secureConnection:void 0===e.secureConnection?Pa():e.secureConnection,serverVersion:"no connection",messageSounds:!e.messageSoundsOff,incognitoMode:!1,desktopAlerts:t&&!!e.desktopAlerts,desktopAlertsEnabled:(Pa()||"object"==typeof window.location&&"localhost"==window.location.hostname)&&void 0!==re&&"undefined"!=typeof navigator&&"undefined"!=typeof FIREBASE_INIT,firebaseToken:t?Ra.c.getObject("firebase-token"):null,applicationVisible:!document.hidden,errorText:"",errorLevel:null,errorAction:void 0,errorActionText:null,sidePanelSelected:"login",sidePanelTitle:null,sidePanelAvatar:null,myTrustedBadges:[],loadSpinnerVisible:!1,login:"dave",password:"dave123",persist:t,myUserId:null,liveConnection:navigator.onLine,topicSelected:"",topicSelectedOnline:!1,topicSelectedAcs:null,newTopicParams:null,loginDisabled:!1,displayMobile:window.innerWidth<=as.Y7,infoPanel:void 0,mobilePanel:"sidepanel",callTopic:void 0,callState:0,callAudioOnly:void 0,callShouldStart:!1,contextMenuVisible:!1,contextMenuBounds:null,contextMenuClickAt:null,contextMenuParams:null,contextMenuItems:[],forwardDialogVisible:!1,forwardMessage:null,alertVisible:!1,alertParams:{},chatList:[],searchResults:[],searchableContacts:[],reqCredMethod:void 0,credMethod:void 0,credCode:void 0,credToken:void 0,requestedTopic:void 0}}componentDidMount(){if(window.addEventListener("resize",this.handleResize),this.handleOnlineOn=e=>{this.handleOnline(!0)},window.addEventListener("online",this.handleOnlineOn),this.handleOnlineOff=e=>{this.handleOnline(!1)},window.addEventListener("offline",this.handleOnlineOff),window.addEventListener("hashchange",this.handleHashRoute),"function"==typeof BroadcastChannel){new BroadcastChannel("tinode-sw").addEventListener("message",this.handlePushMessage)}else console.warn("Your browser does not support BroadcastChannel. Some features will not be available");document.addEventListener("visibilitychange",this.handleVisibilityEvent),this.setState({viewportWidth:document.documentElement.clientWidth,viewportHeight:document.documentElement.clientHeight}),new Promise(((e,t)=>{this.tinode=La.tnSetup(this.state.serverAddress,Pa(),this.state.transport,this.props.intl.locale,this.state.persist,e),this.tinode.onConnect=this.handleConnected,this.tinode.onDisconnect=this.handleDisconnect,this.tinode.onAutoreconnectIteration=this.handleAutoreconnectIteration,this.tinode.onInfoMessage=this.handleInfoMessage,this.tinode.onDataMessage=this.handleDataMessage})).then((e=>{this.state.desktopAlertsEnabled,this.resetContactList();const t=this.state.persist?Ra.c.getObject("auth-token"):void 0;t&&(this.setState({autoLogin:!0}),t.expires=new Date(t.expires),this.tinode.setAuthToken(t),this.tinode.connect().catch((e=>{this.handleError(e.message,"err")}))),this.readTimer=null,this.readTimerCallback=null;const s=Gi.c.parseUrlHash(window.location.hash);if(["cred","reset","register"].includes(s.path[0]))this.handleHashRoute();else{this.setState({requestedTopic:s.path[1]});const e=s.params&&s.params.cred_done?Gi.c.addUrlParam("","cred_done",s.params.cred_done):"";Gi.c.navigateTo(e)}}))}componentWillUnmount(){window.removeEventListener("resize",this.handleResize),window.removeEventListener("hashchange",this.handleHashRoute),window.removeEventListener("online",this.handleOnlineOn),window.removeEventListener("offline",this.handleOnlineOff),document.removeEventListener("visibilitychange",this.handleVisibilityEvent)}static tnSetup(e,t,s,i,a,n){const o=new ss.Tinode({appName:as.Q5,host:e,apiKey:as._Y,transport:s,secure:t,persist:a},n);return o.setHumanLanguage("ru"),console.log("initialize"),o.enableLogging(as.me,!0),o}handlePushMessage(e){this.tinode.oobNotification(e.data||{})}initFCMessaging(){const{formatMessage:e,locale:t}=this.props.intl}static requestFCMToken(e,t){return!1}handleResize(){const e=document.documentElement.clientWidth<=as.Y7;this.setState({viewportWidth:document.documentElement.clientWidth,viewportHeight:document.documentElement.clientHeight}),this.state.displayMobile!=e&&this.setState({displayMobile:e})}checkForAppUpdate(e){e.onupdatefound=s=>{const a=e.installing;a.onstatechange=e=>{if("installed"==a.state&&navigator.serviceWorker.controller){const e=t().createElement(t().Fragment,null,t().createElement(i.FormattedMessage,{id:"update_available",defaultMessage:"Update available.",description:"Message shown when an app update is available."})," ",t().createElement("a",{href:""},t().createElement(i.FormattedMessage,{id:"reload_update",defaultMessage:"Reload",description:"Call to action to reload application when update is available."})),".");this.handleError(e,"info")}}}}handleHashRoute(){const e=Gi.c.parseUrlHash(window.location.hash),t={infoPanel:e.params.info,newTopicTabSelected:e.params.tab};if(e.path&&e.path.length>0){["register","settings","edit","notif","security","support","general","crop","cred","reset","newtpk","archive","blocked","contacts",""].includes(e.path[0])?t.sidePanelSelected=e.path[0]:console.warn("Unknown sidepanel view",e.path[0]);let s=e.path[1]||null;s!=this.state.topicSelected&&(ss.Tinode.topicType(s)?t.mobilePanel="topic-view":(s=null,t.mobilePanel="sidepanel"),Object.assign(t,{topicSelected:s,topicSelectedAcs:this.tinode.getTopicAccessMode(s)}))}else Object.assign(t,{sidePanelSelected:"",topicSelected:null});e.params.method&&(t.credMethod=e.params.method),e.params.code&&(t.credCode=e.params.code),e.params.token&&(t.credToken=e.params.token),e.params.cred_done&&Object.assign(t,La.stateForError(this.props.intl.formatMessage(Ua.cred_confirmed_successfully),"info")),this.setState(t)}handleOnline(e){e?(this.handleError(),clearInterval(this.reconnectCountdown),this.tinode.reconnect()):this.handleError(this.props.intl.formatMessage(Ua.no_connection),"warn"),this.setState({liveConnection:e})}handleVisibilityEvent(){this.setState({applicationVisible:!document.hidden})}static stateForError(e,t,s,i){return{errorText:e,errorLevel:t,errorAction:s,errorActionText:i,callShouldStart:!1}}handleError(e,t,s,i){this.setState(La.stateForError(e,t,s,i))}handleLoginRequest(e,t){this.setState({loginDisabled:!0,login:e,password:t,loadSpinnerVisible:!0,autoLogin:!0}),this.handleError("",null),this.tinode.isConnected()?this.doLogin(e,t,null,{meth:this.state.credMethod,resp:this.state.credCode}):this.tinode.connect().catch((e=>{this.setState({loginDisabled:!1,autoLogin:!1,loadSpinnerVisible:!1}),this.handleError(e.message,"err")})),this.state.desktopAlertsEnabled&&this.state.firebaseToken}handlePersistenceChange(e){e?this.tinode.initStorage().then((e=>{Ra.c.setObject("keep-logged-in",!0),this.setState({persist:!0})})):this.tinode.clearStorage().then((e=>{Ra.c.setObject("keep-logged-in",!1),this.setState({persist:!1})}))}handleConnected(){clearInterval(this.reconnectCountdown),this.handleError();const e=this.tinode.getServerInfo();this.setState({serverVersion:e.ver+" "+(e.build?e.build:"none"),reqCredMethod:((e.reqCred||{}).auth||[])[0]||"email"}),console.log(this.state),this.state.autoLogin&&this.doLogin(this.state.login,this.state.password,null,{meth:this.state.credMethod,resp:this.state.credCode})}handleAutoreconnectIteration(e,t){if(clearInterval(this.reconnectCountdown),e<0)return void this.handleError();if(t)return void t.then((e=>{this.handleError()})).catch((e=>{this.handleError(e.message,"err")}));const{formatMessage:s}=this.props.intl;let i=e/1e3;i|=i,this.reconnectCountdown=setInterval((e=>{if(i<-10)return clearInterval(this.reconnectCountdown),void this.tinode.reconnect();const t=i>99?(0,ms.sj)(i):i;this.handleError(s(Ua.reconnect_countdown,{seconds:t}),"warn",(e=>{clearInterval(this.reconnectCountdown),this.tinode.reconnect()}),s(Ua.reconnect_now)),i-=1}),1e3)}handleDisconnect(e){this.setState({connected:!1,ready:!1,topicSelectedOnline:!1,errorText:e&&e.message?e.message:"Disconnected",errorLevel:e&&e.message?"err":"warn",loginDisabled:!1,contextMenuVisible:!1,forwardDialogVisible:!1,serverVersion:"no connection"})}doLogin(e,t,s,i){if(this.tinode.isAuthenticated())return void Gi.c.navigateTo("");let a=s||(this.tinode.getAuthToken()||{}).token;if(!(e&&t||a))return Gi.c.navigateTo(""),void this.setState({loginDisabled:!1});i=ss.Tinode.credential(i);let n,o=this.tinode.isConnected()?Promise.resolve():this.tinode.connect();e&&t?(a=null,this.setState({password:null}),n=o.then((s=>this.tinode.loginBasic(e,t,i)))):n=o.then((e=>this.tinode.loginToken(a,i))),n.then((e=>{e.code>=300&&"validate credentials"===e.text?(this.setState({loadSpinnerVisible:!1}),i&&this.handleError(this.props.intl.formatMessage(Ua.code_doesnot_match),"warn"),La.navigateToCredentialsView(e.params)):this.handleLoginSuccessful()})).catch((e=>{const t=e.code>=500;this.setState({loginDisabled:!1,credMethod:void 0,credCode:void 0,loadSpinnerVisible:!1,autoLogin:t}),this.handleError(e.message,"err"),console.warn("Login failed",e),t||(a&&this.handleLogout(),Gi.c.navigateTo(""))}))}static navigateToCredentialsView(e){const t=Gi.c.parseUrlHash(window.location.hash);t.path[0]="cred",t.params.method=e.cred[0],t.params.token=e.token,t.params.code=e.code,Gi.c.navigateTo(Gi.c.composeUrlHash(t.path,t.params))}handleLoginSuccessful(){this.handleError(),Ra.c.getObject("keep-logged-in")&&Ra.c.setObject("auth-token",this.tinode.getAuthToken());const e=this.state.requestedTopic,t=this.tinode.getMeTopic();t.onMetaDesc=this.tnMeMetaDesc,t.onContactUpdate=this.tnMeContactUpdate,t.onSubsUpdated=this.tnMeSubsUpdated,this.setState({connected:!0,credMethod:void 0,credCode:void 0,credToken:void 0,myUserId:this.tinode.getCurrentUserID(),autoLogin:!0,requestedTopic:void 0}),t.subscribe(t.startMetaQuery().withLaterSub().withDesc().withTags().withCred().build()).catch((e=>{this.tinode.disconnect(),localStorage.removeItem("auth-token"),this.handleError(e.message,"err"),Gi.c.navigateTo("")})).finally((e=>{this.setState({loadSpinnerVisible:!1})}));let s=Gi.c.setUrlSidePanel(window.location.hash,"contacts");e&&(s=Gi.c.setUrlTopic(s,e)),Gi.c.navigateTo(s)}tnMeMetaDesc(e){if(e){if(e.public&&this.setState({sidePanelTitle:e.public.fn,sidePanelAvatar:(0,Es.Qn)(e.public.photo)}),e.trusted){const t=[];for(const[s,i]of Object.entries(e.trusted))i&&t.push(s);this.setState({myTrustedBadges:t})}e.acs&&this.setState({incognitoMode:!e.acs.isPresencer()})}}tnMeContactUpdate(e,t){if("on"==e||"off"==e)this.resetContactList(),this.state.topicSelected==t.topic&&this.setState({topicSelectedOnline:"on"==e});else if("read"==e)this.resetContactList();else if("msg"==e&&t){const e=this.tinode.getTopic(t.topic),s=e&&e.isArchived();t.unread>0&&this.state.messageSounds&&!s&&(document.hidden||this.state.topicSelected!=t.topic)&&Fa.play().catch((e=>{})),this.resetContactList()}else"recv"==e||("gone"==e||"unsub"==e?(this.state.topicSelected==t.topic&&this.handleTopicSelected(null),this.resetContactList()):"acs"==e?this.state.topicSelected==t.topic&&this.setState({topicSelectedAcs:t.acs}):"del"==e||"upd"==e||"call"==e||console.info("Unsupported (yet) presence update:",e,"in",(t||{}).topic))}tnMeSubsUpdated(e){this.resetContactList()}static prepareSearchableContacts(e,t){const s={};for(const t of e)ss.Tinode.isP2PTopicName(t.topic)&&(s[t.topic]={user:t.topic,updated:t.updated,public:t.public,private:t.private,acs:t.acs});for(const e of t)s[e.user]||(s[e.user]=e);return Object.values(s)}resetContactList(){const e={chatList:[]};this.state.ready||(e.ready=!0),this.tinode.getMeTopic().contacts((t=>{t.topic||t.user||(t.topic=t.name),e.chatList.push(t),this.state.topicSelected==t.topic&&(e.topicSelectedOnline=t.online,e.topicSelectedAcs=t.acs)}));const t=new Date(0);e.chatList.sort(((e,s)=>(e.touched||t).getTime()-(s.touched||t).getTime())),e.searchableContacts=La.prepareSearchableContacts(e.chatList,this.state.searchResults),this.setState(e)}tnInitFind(){const e=this.tinode.getFndTopic();e.onSubsUpdated=this.tnFndSubsUpdated,e.isSubscribed()?this.tnFndSubsUpdated():e.subscribe(e.startMetaQuery().withSub().build()).catch((e=>{this.handleError(e.message,"err")}))}tnFndSubsUpdated(){const e=[];this.tinode.getFndTopic().contacts((t=>{e.push(t)})),this.setState({searchResults:e,searchableContacts:La.prepareSearchableContacts(this.state.chatList,e)})}handleSearchContacts(e){const t=this.tinode.getFndTopic();t.setMeta({desc:{public:e}}).then((e=>t.getMeta(t.startMetaQuery().withSub().build()))).catch((e=>this.handleError(e.message,"err")))}handleTopicSelected(e){this.state.newTopicParams&&this.state.newTopicParams._topicName!=e&&this.setState({newTopicParams:null}),e?(this.setState({errorText:"",errorLevel:null,mobilePanel:"topic-view",infoPanel:void 0}),this.state.topicSelected!=e&&(this.setState({topicSelectedOnline:this.tinode.isTopicOnline(e),topicSelectedAcs:this.tinode.getTopicAccessMode(e),forwardMessage:null}),Gi.c.navigateTo(Gi.c.setUrlTopic("",e)))):(this.setState({topicSelected:null,errorText:"",errorLevel:null,mobilePanel:"sidepanel",topicSelectedOnline:!1,topicSelectedAcs:null,infoPanel:void 0,forwardMessage:null}),Gi.c.navigateTo(Gi.c.setUrlTopic("",null)))}handleHideMessagesView(){this.setState({mobilePanel:"sidepanel"}),Gi.c.navigateTo(Gi.c.setUrlTopic(window.location.hash,null))}handleSendMessage(e,t,s,i){const a=this.tinode.getTopic(this.state.topicSelected);return this.sendMessageToTopic(a,e,t,s,i)}sendMessageToTopic(e,t,s,i,a){(t=e.createMessage(t,!1))._uploader=i,a&&(t.head=Object.assign(t.head||{},a));const n=[];if(s&&n.push(s),!e.isSubscribed()){const s=e.subscribe().then((s=>{let i=[];e.queuedMessages((s=>{s._sending||s.seq==t.seq||(s.head&&s.head.webrtc?i.push(s.seq):e.isSubscribed()&&e.publishMessage(s))})),i.length>0&&e.delMessagesList(i,!0)}));n.push(s)}return e.publishDraft(t,Promise.all(n)).then((t=>(e.isArchived()&&e.archive(!1),t))).catch((e=>this.handleError(e.message,"err")))}handleNewChatInvitation(e,t){const s=this.tinode.getTopic(e);let i=null;switch(t){case"accept":const a=s.getAccessMode().getGiven();i=s.setMeta({sub:{mode:a}}),s.isP2PType()&&(i=i.then((t=>s.setMeta({sub:{user:e,mode:a}}))));break;case"delete":i=s.delTopic(!0);break;case"block":const n=s.getAccessMode().updateWant("-JP").getWant();i=s.setMeta({sub:{mode:n}}).then((e=>this.handleTopicSelected(null)));break;default:console.warn("Unknown invitation action",'"'+t+'""')}null!=i&&i.catch((e=>this.handleError(e.message,"err")))}handleNewAccount(){this.handleError(),Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,"register"))}handleNewAccountRequest(e,t,s,i,a){this.handleError(),this.tinode.connect(this.state.serverAddress).then((n=>{let o;return s&&s.photo&&s.photo.ref&&(o=[s.photo.ref]),this.tinode.createAccountBasic(e,t,{public:s,tags:a,cred:ss.Tinode.credential(i),attachments:o})})).then((e=>{e.code>=300&&"validate credentials"==e.text?La.navigateToCredentialsView(e.params):this.handleLoginSuccessful(this)})).catch((e=>{this.handleError(e.message,"err")}))}handleToggleIncognitoMode(e){this.setState({incognitoMode:null});const t=this.tinode.getMeTopic(),s=t.getAccessMode().updateWant(e?"-P":"+P").getWant();t.setMeta({sub:{mode:s}}).catch((t=>{this.setState({incognitoMode:!e}),this.handleError(t.message,"err")}))}handleUpdateAccountTagsRequest(e,t){this.tinode.getMeTopic().setMeta({tags:t}).catch((e=>this.handleError(e.message,"err")))}handleSettings(){this.handleError(),Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,this.state.myUserId?"edit":"settings"))}handleGlobalSettings(e){const t=e.serverAddress||this.state.serverAddress,s=e.transport||this.state.transport,i=void 0===e.secureConnection?this.state.secureConnection:e.secureConnection;this.tinode&&(this.tinode.clearStorage(),this.tinode.onDisconnect=void 0,this.tinode.disconnect()),this.tinode=La.tnSetup(t,i,s,this.props.intl.locale,Ra.c.getObject("keep-logged-in")),this.tinode.onConnect=this.handleConnected,this.tinode.onDisconnect=this.handleDisconnect,this.tinode.onAutoreconnectIteration=this.handleAutoreconnectIteration,this.tinode.onInfoMessage=this.handleInfoMessage,this.tinode.onDataMessage=this.handleDataMessage,this.setState({serverAddress:t,transport:s,secureConnection:i}),Ra.c.setObject("settings",{serverAddress:t,transport:s,secureConnection:i}),Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,""))}handleShowArchive(){Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,this.state.myUserId?"archive":""))}handleShowBlocked(){Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,this.state.myUserId?"blocked":""))}toggleFCMToken(e){e?(this.setState({desktopAlerts:null}),this.state.firebaseToken&&(this.setState({desktopAlerts:!0}),Ra.c.getObject("keep-logged-in")&&Ra.c.updateObject("settings",{desktopAlerts:!0}))):this.state.firebaseToken&&this.fcm?ts(this.fcm).catch((e=>{console.error("Unable to delete token.",e)})).finally((e=>{Ra.c.updateObject("settings",{desktopAlerts:!1}),localStorage.removeItem("firebase-token"),this.setState({desktopAlerts:!1,firebaseToken:null}),this.tinode.setDeviceToken(null)})):(this.setState({desktopAlerts:!1,firebaseToken:null}),Ra.c.updateObject("settings",{desktopAlerts:!1}))}handleToggleMessageSounds(e){this.setState({messageSounds:e}),Ra.c.updateObject("settings",{messageSoundsOff:!e})}handleCredAdd(e,t){this.tinode.getMeTopic().setMeta({cred:{meth:e,val:t}}).catch((e=>this.handleError(e.message,"err")))}handleCredDelete(e,t){this.tinode.getMeTopic().delCredential(e,t).catch((e=>this.handleError(e.message,"err")))}handleCredConfirm(e,t){La.navigateToCredentialsView({cred:[e],code:t})}handleSidepanelCancel(){const e=Gi.c.parseUrlHash(window.location.hash);let t="";["security","support","general","notif"].includes(e.path[0])?t="edit":"crop"==e.path[0]?t="general":"blocked"==e.path[0]?t="security":this.state.myUserId&&(t="contacts"),e.path[0]=t,e.params&&(delete e.params.code,delete e.params.method,delete e.params.tab,delete e.params.scheme,delete e.params.token),Gi.c.navigateTo(Gi.c.composeUrlHash(e.path,e.params)),this.setState({errorText:"",errorLevel:null})}basicNavigator(e){Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,e))}infoNavigator(e){Gi.c.navigateTo(Gi.c.setUrlInfoPanel(window.location.hash,e))}handleStartTopicRequest(e,t,s){if(e&&this.tinode.isTopicCached(e))return void this.handleTopicSelected(e);const i={};ss.Tinode.isP2PTopicName(e)?(i.sub={mode:as.uU},i.desc={defacs:{auth:as.uU}}):(e=e||this.tinode.newGroupTopicName(s),t&&(i.desc={public:t.public,private:{comment:t.private}},i.tags=t.tags)),i._topicName=e,this.setState({newTopicParams:i},(t=>{this.handleTopicSelected(e)}))}handleNewTopicCreated(e,t){let s={};this.state.callShouldStart&&(s={callState:3,callShouldStart:!1}),this.state.topicSelected==e&&e!=t&&(s.topicSelected=t),this.setState(s,(e=>{Gi.c.navigateTo(Gi.c.setUrlTopic("",t))}))}handleTopicUpdateRequest(e,t,s,i){this.handleError();const a=this.tinode.getTopic(e);if(a){const e={};let n;t&&(t.photo&&(t.photo.ref&&t.photo.ref!=ss.Tinode.DEL_CHAR?n=[t.photo.ref]:t.photo.data&&t.photo.data!=ss.Tinode.DEL_CHAR||(t.photo=ss.Tinode.DEL_CHAR)),e.public=t),"string"==typeof s&&(e.private=s===ss.Tinode.DEL_CHAR?ss.Tinode.DEL_CHAR:{comment:s}),i&&(e.defacs=i),a.setMeta({desc:e,attachments:n}).catch((e=>this.handleError(e.message,"err")))}}handleUnarchive(e){const t=this.tinode.getTopic(e);t&&t.archive(!1).catch((e=>this.handleError(e.message,"err")))}handleUpdatePasswordRequest(e){this.handleError(),e&&this.tinode.updateAccountBasic(null,this.tinode.getCurrentLogin(),e).catch((e=>this.handleError(e.message,"err")))}handleChangePermissions(e,t,s){const i=this.tinode.getTopic(e);if(i){const e=i.getAccessMode();s?(e.updateGiven(t),t=e.getGiven()):(e.updateWant(t),t=e.getWant()),i.setMeta({sub:{user:s,mode:t}}).catch((e=>this.handleError(e.message,"err")))}}handleTagsUpdateRequest(e,t){const s=this.tinode.getTopic(e);s&&s.setMeta({tags:t}).catch((e=>this.handleError(e.message,"err")))}handleLogout(){let e;(0,Cs.cz)(0),localStorage.removeItem("auth-token"),localStorage.removeItem("firebase-token"),localStorage.removeItem("settings"),this.state.firebaseToken&&ts(this.fcm),clearInterval(this.reconnectCountdown),this.tinode?(e=this.tinode.clearStorage(),this.tinode.onDisconnect=void 0,this.tinode.disconnect()):e=Promose.resolve(),this.setState(this.getBlankState()),e.then((e=>{this.tinode=La.tnSetup(this.state.serverAddress,Pa(),this.state.transport,this.props.intl.locale,Ra.c.getObject("keep-logged-in"),(e=>{this.tinode.onConnect=this.handleConnected,this.tinode.onDisconnect=this.handleDisconnect,this.tinode.onAutoreconnectIteration=this.handleAutoreconnectIteration,this.tinode.onInfoMessage=this.handleInfoMessage,this.tinode.onDataMessage=this.handleDataMessage,Gi.c.navigateTo("")}))}))}handleDeleteAccount(){this.tinode.delCurrentUser(!0).then((e=>{this.handleLogout()}))}handleDeleteTopicRequest(e){const t=this.tinode.getTopic(e);t&&t.delTopic(!0).then((e=>{Gi.c.navigateTo(Gi.c.setUrlTopic(window.location.hash,""))})).catch((e=>{this.handleError(e.message,"err")}))}handleDeleteMessagesRequest(e){const t=this.tinode.getTopic(e);t&&t.delMessagesAll(!0).catch((e=>this.handleError(e.message,"err")))}handleLeaveUnsubRequest(e){const t=this.tinode.getTopic(e);t&&t.leave(!0).then((e=>{Gi.c.navigateTo(Gi.c.setUrlTopic(window.location.hash,""))})).catch((e=>{this.handleError(e.message,"err")}))}handleBlockTopicRequest(e){const t=this.tinode.getTopic(e);t&&t.updateMode(null,"-JP").then((e=>{Gi.c.navigateTo(Gi.c.setUrlTopic(window.location.hash,""))})).catch((e=>this.handleError(e.message,"err")))}handleReportTopic(e){const t=this.tinode.getTopic(e);t&&(this.tinode.report("report",e),t.updateMode(null,"-JP").then((e=>{Gi.c.navigateTo(Gi.c.setUrlTopic(window.location.hash,""))})).catch((e=>this.handleError(e.message,"err"))))}handleShowContextMenu(e,t){this.setState({contextMenuVisible:!0,contextMenuClickAt:{x:e.x,y:e.y},contextMenuParams:e,contextMenuItems:t||this.defaultTopicContextMenu(e.topicName),contextMenuBounds:this.selfRef.current.getBoundingClientRect()})}handleShowForwardDialog(e){"newtpk"==this.state.sidePanelSelected&&this.handleSidepanelCancel();const t="➦ "+e.userName,s="string"==typeof e.content?ss.Drafty.init(e.content):ss.Drafty.forwardedContent(e.content),i=ss.Drafty.preview(s,as.sL,!0),a=ss.Drafty.append(ss.Drafty.appendLineBreak(ss.Drafty.mention(t,e.userFrom)),s),n=ss.Drafty.quote(t,e.userFrom,i),o={forwarded:e.topicName+":"+e.seq};this.setState({forwardDialogVisible:!0,forwardMessage:{head:o,msg:a,preview:n}})}defaultTopicContextMenu(e){const t=this.tinode.getTopic(e);if(t._deleted)return["topic_delete"];let s=!1,i=!1,a=!1,n=!1,o=!1,r=!1,l=!1;if(t){n=t.isSubscribed(),r=t.isArchived();const e=t.getAccessMode();e&&(s=e.isMuted(),i=!e.isJoiner(),a=!e.isJoiner("want"),o=e.isDeleter())}return l=!!this.tinode.getServerParam("iceServers"),[n?{title:this.props.intl.formatMessage(Ua.menu_item_info),handler:this.handleShowInfoView}:null,n&&ss.Tinode.isP2PTopicName(e)&&l?{title:this.props.intl.formatMessage(Ua.menu_item_audio_call),handler:this.handleStartAudioCall}:null,n&&ss.Tinode.isP2PTopicName(e)&&l?{title:this.props.intl.formatMessage(Ua.menu_item_video_call),handler:this.handleStartVideoCall}:null,n?"messages_clear":null,n&&o?"messages_clear_hard":null,s?i?null:"topic_unmute":"topic_mute",a?"topic_unblock":"topic_block",r?"topic_restore":"topic_archive","topic_delete"]}handleHideContextMenu(){this.setState({contextMenuVisible:!1,contextMenuClickAt:null,contextMenuParams:null,contextMenuBounds:null})}handleHideForwardDialog(e){this.setState({forwardDialogVisible:!1,forwardMessage:e?this.state.forwardMessage:null})}handleContextMenuAction(e,t,s){"topic_archive"==e?t&&s.topicName&&s.topicName==this.state.topicSelected&&t.then((e=>{this.handleTopicSelected(null)})):"menu_item_forward"==e&&this.handleShowForwardDialog(s)}handleShowAlert(e,t,s,i,a,n){this.setState({alertVisible:!0,alertParams:{title:e,content:t,onConfirm:s,confirm:i,onReject:a,reject:n}})}handleShowInfoView(){Gi.c.navigateTo(Gi.c.addUrlParam(window.location.hash,"info","info")),this.setState({infoPanel:"info"})}handleMemberUpdateRequest(e,t,s){if(!e)return;const i=this.tinode.getTopic(e);i&&(t&&t.length>0&&t.map((e=>{i.invite(e,null).catch((e=>this.handleError(e.message,"err")))})),s&&s.length>0&&s.map((e=>{i.delSubscription(e).catch((e=>this.handleError(e.message,"err")))})))}handleValidateCredentialsRequest(e,t,s){this.tinode.isAuthenticated()?this.tinode.getMeTopic().setMeta({cred:{meth:e,resp:t}}).then((e=>Gi.c.navigateTo(Gi.c.setUrlSidePanel(window.location.hash,"contacts")))).catch((e=>this.handleError(e.message,"err"))):(this.setState({credMethod:e,credCode:t,credToken:s}),this.doLogin(null,null,s,{meth:e,resp:t}))}handlePasswordResetRequest(e,t){return this.tinode.connect().then((s=>this.tinode.requestResetAuthSecret("basic",e,t))).catch((e=>{this.handleError(e.message,"err")}))}handleResetPassword(e,t){const s=(0,Es.Se)(t.secret);s&&t.scheme?this.tinode.connect().then((i=>this.tinode.updateAccountBasic(null,null,e,{scheme:t.scheme,secret:s}))).then((e=>{this.handleError(this.props.intl.formatMessage(Ua.password_reset_success),"info"),Gi.c.navigateTo("")})).catch((e=>{this.handleError(e.message,"err")})):this.handleError(this.props.intl.formatMessage(Ua.invalid_security_token),"err")}handleShowCountrySelector(s,a,n){this.handleShowAlert("Select country",t().createElement(e.Suspense,{fallback:t().createElement("div",null,t().createElement(i.FormattedMessage,{id:"loading_note",defaultMessage:"Loading...",description:"Message shown when component is loading"}))},t().createElement(xa,{selected:s,onSubmit:(e,t)=>{this.setState({alertVisible:!1}),n(e,t)}})),null,null,(e=>{}),"Cancel")}handleStartVideoCall(){this.setState({callTopic:this.state.topicSelected,callState:1,callAudioOnly:!1})}handleStartAudioCall(){this.setState({callTopic:this.state.topicSelected,callState:1,callAudioOnly:!0})}handleCallInvite(e,t,s,i){switch(s){case 1:const s={webrtc:Vs,aonly:!!i};this.handleSendMessage(ss.Drafty.videoCall(i),void 0,void 0,s).then((e=>{e.code<200||e.code>=300||!e.params||!e.params.seq?this.handleCallClose():this.setState({callSeq:e.params.seq})}));break;case 3:const a=this.tinode.getTopic(e);if(!a)return;a.videoCall("accept",t)}}handleCallRinging(e,t){const s=this.tinode.getTopic(e);s&&s.videoCall("ringing",t)}handleCallHangup(e,t){const s=this.tinode.getTopic(e);s&&s.videoCall("hang-up",t)}handleCallSendOffer(e,t,s){const i=this.tinode.getTopic(e);i&&i.videoCall("offer",t,s)}handleCallIceCandidate(e,t,s){const i=this.tinode.getTopic(e);i&&i.videoCall("ice-candidate",t,s)}handleCallSendAnswer(e,t,s){const i=this.tinode.getTopic(e);i&&i.videoCall("answer",t,s)}handleCallClose(){this.callTimeoutTimer&&clearTimeout(this.callTimeoutTimer),this.setState({callTopic:void 0,callState:0,callAudioOnly:void 0})}handleCallAccept(e){const t=this.tinode.getTopic(e);t&&(t.isSubscribed()?(this.handleTopicSelected(this.state.callTopic),this.setState({callState:3})):this.setState({callShouldStart:!0},(e=>this.handleTopicSelected(this.state.callTopic))))}handleInfoMessage(e){if("call"==e.what)switch(e.event){case"accept":if(ss.Tinode.isMeTopicName(e.topic)&&this.tinode.isMe(e.from))return void this.setState({callTopic:null,callState:0,callSeq:null,callAudioOnly:void 0});e.topic==this.state.callTopic&&this.setState({callState:3});break;case"hang-up":this.handleCallClose()}}handleDataMessage(e){if(e.head&&e.head.webrtc&&e.head.webrtc==Vs){const t=this.tinode.getTopic(e.topic);if(t){const s=t.latestMsgVersion(e.seq)||e;s.head&&s.head.webrtc&&s.head.webrtc==Vs&&e.from!=this.state.myUserId&&(0==this.state.callState?this.setState({callTopic:e.topic,callState:2,callSeq:e.seq,callAudioOnly:!!s.head.aonly}):this.handleCallHangup(e.topic,e.seq))}else console.warn("Received vc data message from unknown topic",e.topic)}}render(){return t().createElement("div",{id:"app-container",ref:this.selfRef},this.state.contextMenuVisible?t().createElement(rs,{tinode:this.tinode,bounds:this.state.contextMenuBounds,clickAt:this.state.contextMenuClickAt,params:this.state.contextMenuParams,items:this.state.contextMenuItems,hide:this.handleHideContextMenu,onShowAlert:this.handleShowAlert,onAction:this.handleContextMenuAction,onTopicRemoved:e=>{e==this.state.topicSelected&&this.handleTopicSelected(null)},onError:this.handleError}):null,this.state.forwardDialogVisible?t().createElement(qs,{tinode:this.tinode,contacts:this.state.chatList,topicSelected:this.state.topicSelected,myUserId:this.state.myUserId,hide:this.handleHideForwardDialog,onInitFind:this.tnInitFind,searchResults:this.state.searchResults,onSearchContacts:this.handleSearchContacts,onTopicSelected:this.handleStartTopicRequest}):null,this.state.callTopic&&2==this.state.callState?t().createElement(Ws,{tinode:this.tinode,topic:this.state.callTopic,seq:this.state.callSeq,callState:this.state.callState,audioOnly:this.state.callAudioOnly,onClose:this.handleCallClose,onRinging:this.handleCallRinging,onAcceptCall:this.handleCallAccept,onReject:this.handleCallHangup}):null,this.state.alertVisible?t().createElement(is,{title:this.state.alertParams.title,content:this.state.alertParams.content,onReject:this.state.alertParams.onReject?e=>this.setState({alertVisible:!1}):null,reject:this.state.alertParams.reject,onConfirm:this.state.alertParams.onConfirm?e=>{this.setState({alertVisible:!1}),this.state.alertParams.onConfirm()}:null,confirm:this.state.alertParams.confirm}):null,this.state.displayMobile&&"sidepanel"!=this.state.mobilePanel?null:t().createElement(Na,{tinode:this.tinode,connected:this.state.connected,displayMobile:this.state.displayMobile,state:this.state.sidePanelSelected,title:this.state.sidePanelTitle,avatar:this.state.sidePanelAvatar,trustedBadges:this.state.myTrustedBadges,login:this.state.login,persist:this.state.persist,myUserId:this.state.myUserId,loginDisabled:this.state.loginDisabled,loadSpinnerVisible:this.state.loadSpinnerVisible,errorText:this.state.errorText,errorLevel:this.state.errorLevel,errorAction:this.state.errorAction,errorActionText:this.state.errorActionText,topicSelected:this.state.topicSelected,chatList:this.state.chatList,credMethod:this.state.credMethod,credCode:this.state.credCode,credToken:this.state.credToken,transport:this.state.transport,messageSounds:this.state.messageSounds,desktopAlerts:this.state.desktopAlerts,desktopAlertsEnabled:this.state.desktopAlertsEnabled,incognitoMode:this.state.incognitoMode,serverAddress:this.state.serverAddress,secureConnection:this.state.secureConnection,serverVersion:this.state.serverVersion,reqCredMethod:this.state.reqCredMethod,onGlobalSettings:this.handleGlobalSettings,onSignUp:this.handleNewAccount,onSettings:this.handleSettings,onNavigate:this.basicNavigator,onLoginRequest:this.handleLoginRequest,onPersistenceChange:this.handlePersistenceChange,onCreateAccount:this.handleNewAccountRequest,onUpdateAccountDesc:this.handleTopicUpdateRequest,onUpdatePassword:this.handleUpdatePasswordRequest,onUpdateAccountTags:this.handleUpdateAccountTagsRequest,onTogglePushNotifications:this.toggleFCMToken,onToggleMessageSounds:this.handleToggleMessageSounds,onToggleIncognitoMode:this.handleToggleIncognitoMode,onCredAdd:this.handleCredAdd,onCredDelete:this.handleCredDelete,onCredConfirm:this.handleCredConfirm,onTopicSelected:this.handleTopicSelected,onCreateTopic:this.handleStartTopicRequest,onLogout:this.handleLogout,onDeleteAccount:this.handleDeleteAccount,onShowAlert:this.handleShowAlert,onCancel:this.handleSidepanelCancel,onError:this.handleError,onValidateCredentials:this.handleValidateCredentialsRequest,onPasswordResetRequest:this.handlePasswordResetRequest,onResetPassword:this.handleResetPassword,onShowArchive:this.handleShowArchive,onShowBlocked:this.handleShowBlocked,onShowCountrySelector:this.handleShowCountrySelector,onInitFind:this.tnInitFind,searchResults:this.state.searchResults,onSearchContacts:this.handleSearchContacts,showContextMenu:this.handleShowContextMenu}),!this.state.displayMobile||"topic-view"==this.state.mobilePanel&&!this.state.infoPanel?t().createElement(ea,{tinode:this.tinode,connected:this.state.connected,ready:this.state.ready,online:this.state.topicSelectedOnline,acs:this.state.topicSelectedAcs,displayMobile:this.state.displayMobile,viewportWidth:this.state.viewportWidth,viewportHeight:this.state.viewportHeight,topic:this.state.topicSelected,myUserId:this.state.myUserId,myUserName:this.state.sidePanelTitle,serverVersion:this.state.serverVersion,serverAddress:this.state.serverAddress,applicationVisible:this.state.applicationVisible,forwardMessage:this.state.forwardMessage,onCancelForwardMessage:this.handleHideForwardDialog,callTopic:this.state.callTopic,callSeq:this.state.callSeq,callState:this.state.callState,callAudioOnly:this.state.callAudioOnly,onCallHangup:this.handleCallHangup,onCallInvite:this.handleCallInvite,onCallSendOffer:this.handleCallSendOffer,onCallIceCandidate:this.handleCallIceCandidate,onCallSendAnswer:this.handleCallSendAnswer,errorText:this.state.errorText,errorLevel:this.state.errorLevel,errorAction:this.state.errorAction,errorActionText:this.state.errorActionText,newTopicParams:this.state.newTopicParams,onHideMessagesView:this.handleHideMessagesView,onError:this.handleError,onNewTopicCreated:this.handleNewTopicCreated,showContextMenu:this.handleShowContextMenu,onChangePermissions:this.handleChangePermissions,onNewChat:this.handleNewChatInvitation,sendMessage:this.handleSendMessage,onVideoCallClosed:this.handleCallClose}):null,this.state.infoPanel?t().createElement(bi,{tinode:this.tinode,connected:this.state.connected,displayMobile:this.state.displayMobile,topic:this.state.topicSelected,searchableContacts:this.state.searchableContacts,myUserId:this.state.myUserId,panel:this.state.infoPanel,errorText:this.state.errorText,errorLevel:this.state.errorLevel,errorAction:this.state.errorAction,errorActionText:this.state.errorActionText,onNavigate:this.infoNavigator,onTopicDescUpdateRequest:this.handleTopicUpdateRequest,onShowAlert:this.handleShowAlert,onChangePermissions:this.handleChangePermissions,onMemberUpdateRequest:this.handleMemberUpdateRequest,onDeleteTopic:this.handleDeleteTopicRequest,onDeleteMessages:this.handleDeleteMessagesRequest,onLeaveTopic:this.handleLeaveUnsubRequest,onBlockTopic:this.handleBlockTopicRequest,onReportTopic:this.handleReportTopic,onAddMember:this.handleManageGroupMembers,onTopicTagsUpdateRequest:this.handleTagsUpdateRequest,onTopicUnArchive:this.handleUnarchive,onInitFind:this.tnInitFind,onError:this.handleError,showContextMenu:this.handleShowContextMenu}):null)}}const Oa=(0,i.injectIntl)(La);if("undefined"!=typeof FIREBASE_INIT&&FIREBASE_INIT&&FIREBASE_INIT.measurementId){const Ka=document.getElementsByTagName("head")[0];let Qa=document.createElement("script");function Ga(){dataLayer.push(arguments)}Qa.src="https://www.googletagmanager.com/gtag/js?id="+FIREBASE_INIT.measurementId,Qa.async=!0,Ka.prepend(Qa),window.dataLayer=window.dataLayer||[],Ga("js",new Date),Ga("config",FIREBASE_INIT.measurementId)}const Ba={de:e=>o.e(632).then(o.t.bind(o,1632,19)),en:e=>o.e(264).then(o.t.bind(o,1264,19)),es:e=>o.e(336).then(o.t.bind(o,3336,19)),fr:e=>o.e(936).then(o.t.bind(o,1936,19)),ko:e=>o.e(952).then(o.t.bind(o,952,19)),ro:e=>o.e(844).then(o.t.bind(o,5844,19)),ru:e=>o.e(128).then(o.t.bind(o,6128,19)),th:e=>o.e(864).then(o.t.bind(o,8864,19)),uk:e=>o.e(178).then(o.t.bind(o,8178,19)),zh:e=>o.e(648).then(o.t.bind(o,3648,19)),"zh-TW":e=>o.e(564).then(o.t.bind(o,4564,19))},{params:qa}=Gi.c.parseUrlHash(window.location.hash),ja=qa&&qa.hl||navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en",Va=ja.replace("_","-"),Ha=Va.split("-")[0].toLowerCase(),Wa=Ba[Va]?ja:Ba[Ha]?Ha:"ru";document.getElementsByTagName("html")[0].setAttribute("lang","ru");const za=(0,s.C)(document.getElementById("mountPoint"));Ba.ru().then((e=>(console.log(e),console.log(Wa),console.log(),za.render(t().createElement(i.IntlProvider,{locale:"ru",messages:e,textComponent:t().Fragment},t().createElement(Oa,null))))))})()})();
//# sourceMappingURL=index.prod.js.map